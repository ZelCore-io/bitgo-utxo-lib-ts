"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.hashForWitnessV0 = exports.hashForSignature = void 0;
const types = require("bitcoinjs-lib/src/types");
const bitcoinjs_lib_1 = require("bitcoinjs-lib");
const bitcoinjs_lib_2 = require("bitcoinjs-lib");
const bitcoinjs_lib_3 = require("bitcoinjs-lib");
const bufferutils_1 = require("bitcoinjs-lib/src/bufferutils");
const typeforce = require('typeforce');
const ZERO = Buffer.from('0000000000000000000000000000000000000000000000000000000000000000', 'hex');
const ONE = Buffer.from('0000000000000000000000000000000000000000000000000000000000000001', 'hex');
const EMPTY_BUFFER = Buffer.allocUnsafe(0);
const VALUE_UINT64_MAX = Buffer.from('ffffffffffffffff', 'hex');
const BLANK_OUTPUT = {
    script: EMPTY_BUFFER,
    valueBuffer: VALUE_UINT64_MAX,
};
function varSliceSize(someScript) {
    const length = someScript.length;
    return bufferutils_1.varuint.encodingLength(length) + length;
}
function hashForSignature(inIndex, prevOutScript, hashType, prevOutValue, cloneTx) {
    typeforce(types.tuple(types.UInt32, types.Buffer, /* types.UInt8 */ types.Number), arguments);
    // https://github.com/bitcoin/bitcoin/blob/master/src/test/sighash_tests.cpp#L29
    if (inIndex >= cloneTx.ins.length)
        return ONE;
    // ignore OP_CODESEPARATOR
    const decompiled = bitcoinjs_lib_2.script.decompile(prevOutScript);
    if (decompiled === null)
        return ONE;
    const ourScript = bitcoinjs_lib_2.script.compile(decompiled.filter(x => {
        return x !== bitcoinjs_lib_3.script.OPS.OP_CODESEPARATOR;
    }));
    const txTmp = cloneTx;
    // SIGHASH_NONE: ignore all outputs? (wildcard payee)
    if ((hashType & 0x1f) === bitcoinjs_lib_1.Transaction.SIGHASH_NONE) {
        txTmp.outs = [];
        // ignore sequence numbers (except at inIndex)
        txTmp.ins.forEach((input, i) => {
            if (i === inIndex)
                return;
            input.sequence = 0;
        });
        // SIGHASH_SINGLE: ignore all outputs, except at the same index?
    }
    else if ((hashType & 0x1f) === bitcoinjs_lib_1.Transaction.SIGHASH_SINGLE) {
        // https://github.com/bitcoin/bitcoin/blob/master/src/test/sighash_tests.cpp#L60
        if (inIndex >= cloneTx.outs.length)
            return ONE;
        // truncate outputs after
        txTmp.outs.length = inIndex + 1;
        // "blank" outputs before
        for (let i = 0; i < inIndex; i++) {
            txTmp.outs[i] = BLANK_OUTPUT;
        }
        // ignore sequence numbers (except at inIndex)
        txTmp.ins.forEach((input, y) => {
            if (y === inIndex)
                return;
            input.sequence = 0;
        });
    }
    // SIGHASH_ANYONECANPAY: ignore inputs entirely?
    if (hashType & bitcoinjs_lib_1.Transaction.SIGHASH_ANYONECANPAY) {
        txTmp.ins = [txTmp.ins[inIndex]];
        txTmp.ins[0].script = ourScript;
        // SIGHASH_ALL: only ignore input scripts
    }
    else {
        // "blank" others input scripts
        txTmp.ins.forEach(input => {
            input.script = EMPTY_BUFFER;
        });
        txTmp.ins[inIndex].script = ourScript;
    }
    // serialize and hash
    const buffer = Buffer.allocUnsafe(txTmp.byteLength(false) + 4);
    buffer.writeInt32LE(hashType, buffer.length - 4);
    txTmp.__toBuffer(buffer, 0, false);
    return bitcoinjs_lib_2.crypto.sha256(buffer);
}
exports.hashForSignature = hashForSignature;
function hashForWitnessV0(inIndex, prevOutScript, value, hashType, cloneTx) {
    typeforce(types.tuple(types.UInt32, types.Buffer, types.Satoshi, types.UInt32), arguments);
    let tbuffer = Buffer.from([]);
    let bufferWriter;
    let hashOutputs = ZERO;
    let hashPrevouts = ZERO;
    let hashSequence = ZERO;
    if (!(hashType & bitcoinjs_lib_1.Transaction.SIGHASH_ANYONECANPAY)) {
        tbuffer = Buffer.allocUnsafe(36 * cloneTx.ins.length);
        bufferWriter = new bufferutils_1.BufferWriter(tbuffer, 0);
        cloneTx.ins.forEach(txIn => {
            bufferWriter.writeSlice(txIn.hash);
            bufferWriter.writeUInt32(txIn.index);
        });
        hashPrevouts = bitcoinjs_lib_2.crypto.sha256(tbuffer);
    }
    if (!(hashType & bitcoinjs_lib_1.Transaction.SIGHASH_ANYONECANPAY) &&
        (hashType & 0x1f) !== bitcoinjs_lib_1.Transaction.SIGHASH_SINGLE &&
        (hashType & 0x1f) !== bitcoinjs_lib_1.Transaction.SIGHASH_NONE) {
        tbuffer = Buffer.allocUnsafe(4 * cloneTx.ins.length);
        bufferWriter = new bufferutils_1.BufferWriter(tbuffer, 0);
        cloneTx.ins.forEach(txIn => {
            bufferWriter.writeUInt32(txIn.sequence);
        });
        hashSequence = bitcoinjs_lib_2.crypto.sha256(tbuffer);
    }
    if ((hashType & 0x1f) !== bitcoinjs_lib_1.Transaction.SIGHASH_SINGLE &&
        (hashType & 0x1f) !== bitcoinjs_lib_1.Transaction.SIGHASH_NONE) {
        const txOutsSize = cloneTx.outs.reduce((sum, output) => {
            return sum + 8 + varSliceSize(output.script);
        }, 0);
        tbuffer = Buffer.allocUnsafe(txOutsSize);
        bufferWriter = new bufferutils_1.BufferWriter(tbuffer, 0);
        cloneTx.outs.forEach(out => {
            bufferWriter.writeUInt64(out.value);
            bufferWriter.writeVarSlice(out.script);
        });
        hashOutputs = bitcoinjs_lib_2.crypto.sha256(tbuffer);
    }
    else if ((hashType & 0x1f) === bitcoinjs_lib_1.Transaction.SIGHASH_SINGLE &&
        inIndex < cloneTx.outs.length) {
        const output = cloneTx.outs[inIndex];
        tbuffer = Buffer.allocUnsafe(8 + varSliceSize(output.script));
        bufferWriter = new bufferutils_1.BufferWriter(tbuffer, 0);
        bufferWriter.writeUInt64(output.value);
        bufferWriter.writeVarSlice(output.script);
        hashOutputs = bitcoinjs_lib_2.crypto.sha256(tbuffer);
    }
    tbuffer = Buffer.allocUnsafe(156 + varSliceSize(prevOutScript));
    bufferWriter = new bufferutils_1.BufferWriter(tbuffer, 0);
    const input = cloneTx.ins[inIndex];
    bufferWriter.writeInt32(cloneTx.version);
    bufferWriter.writeSlice(hashPrevouts);
    bufferWriter.writeSlice(hashSequence);
    bufferWriter.writeSlice(input.hash);
    bufferWriter.writeUInt32(input.index);
    bufferWriter.writeVarSlice(prevOutScript);
    bufferWriter.writeUInt64(value);
    bufferWriter.writeUInt32(input.sequence);
    bufferWriter.writeSlice(hashOutputs);
    bufferWriter.writeUInt32(cloneTx.locktime);
    bufferWriter.writeUInt32(hashType);
    return bitcoinjs_lib_2.crypto.sha256(tbuffer);
}
exports.hashForWitnessV0 = hashForWitnessV0;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3JzVHJhbnNhY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYml0Z28vZ3JvZXN0bGNvaW4vR3JzVHJhbnNhY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaURBQWlEO0FBQ2pELGlEQUE0QztBQUM1QyxpREFBcUU7QUFDckUsaURBQW1EO0FBQ25ELCtEQUErRDtBQUUvRCxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7QUFFdkMsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FDdEIsa0VBQWtFLEVBQ2xFLEtBQUssQ0FDTixDQUFDO0FBRUYsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FDckIsa0VBQWtFLEVBQ2xFLEtBQUssQ0FDTixDQUFDO0FBRUYsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUUzQyxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFFaEUsTUFBTSxZQUFZLEdBQUc7SUFDbkIsTUFBTSxFQUFFLFlBQVk7SUFDcEIsV0FBVyxFQUFFLGdCQUFnQjtDQUM5QixDQUFDO0FBRUYsU0FBUyxZQUFZLENBQUMsVUFBVTtJQUM5QixNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDO0lBQ2pDLE9BQU8sYUFBYSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEdBQUcsTUFBTSxDQUFDO0FBQy9ELENBQUM7QUFFRCxTQUFnQixnQkFBZ0IsQ0FDOUIsT0FBTyxFQUNQLGFBQWEsRUFDYixRQUFRLEVBQ1IsWUFBWSxFQUNaLE9BQU87SUFFUCxTQUFTLENBQ1AsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNLEVBQUUsaUJBQWlCLENBQUMsS0FB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QztJQUMxRCxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ25DLFlBQVksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3pDLFlBQVksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDdEMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUN0QyxZQUFZLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQyxZQUFZLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0QyxZQUFZLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzFDLFlBQVksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDekMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNyQyxZQUFZLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMzQyxZQUFZLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLE9BQU8sc0JBQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDakMsQ0FBQztBQXZFRCw0Q0F1RUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB0eXBlcyBmcm9tICdiaXRjb2luanMtbGliL3NyYy90eXBlcyc7XHJcbmltcG9ydCB7IFRyYW5zYWN0aW9uIH0gZnJvbSAnYml0Y29pbmpzLWxpYic7XHJcbmltcG9ydCB7IGNyeXB0byBhcyBiY3J5cHRvLCBzY3JpcHQgYXMgYnNjcmlwdCB9IGZyb20gJ2JpdGNvaW5qcy1saWInO1xyXG5pbXBvcnQgeyBzY3JpcHQgYXMgc2NyaXB0XzEgfSBmcm9tICdiaXRjb2luanMtbGliJztcclxuaW1wb3J0ICogYXMgYnVmZmVydXRpbHNfMSBmcm9tICdiaXRjb2luanMtbGliL3NyYy9idWZmZXJ1dGlscyc7XHJcblxyXG5jb25zdCB0eXBlZm9yY2UgPSByZXF1aXJlKCd0eXBlZm9yY2UnKTtcclxuXHJcbmNvbnN0IFpFUk8gPSBCdWZmZXIuZnJvbShcclxuICAnMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCcsXHJcbiAgJ2hleCcsXHJcbik7XHJcblxyXG5jb25zdCBPTkUgPSBCdWZmZXIuZnJvbShcclxuICAnMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMScsXHJcbiAgJ2hleCcsXHJcbik7XHJcblxyXG5jb25zdCBFTVBUWV9CVUZGRVIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoMCk7XHJcblxyXG5jb25zdCBWQUxVRV9VSU5UNjRfTUFYID0gQnVmZmVyLmZyb20oJ2ZmZmZmZmZmZmZmZmZmZmYnLCAnaGV4Jyk7XHJcblxyXG5jb25zdCBCTEFOS19PVVRQVVQgPSB7XHJcbiAgc2NyaXB0OiBFTVBUWV9CVUZGRVIsXHJcbiAgdmFsdWVCdWZmZXI6IFZBTFVFX1VJTlQ2NF9NQVgsXHJcbn07XHJcblxyXG5mdW5jdGlvbiB2YXJTbGljZVNpemUoc29tZVNjcmlwdCkge1xyXG4gIGNvbnN0IGxlbmd0aCA9IHNvbWVTY3JpcHQubGVuZ3RoO1xyXG4gIHJldHVybiBidWZmZXJ1dGlsc18xLnZhcnVpbnQuZW5jb2RpbmdMZW5ndGgobGVuZ3RoKSArIGxlbmd0aDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGhhc2hGb3JTaWduYXR1cmUoXHJcbiAgaW5JbmRleCxcclxuICBwcmV2T3V0U2NyaXB0LFxyXG4gIGhhc2hUeXBlLFxyXG4gIHByZXZPdXRWYWx1ZSxcclxuICBjbG9uZVR4LFxyXG4pIHtcclxuICB0eXBlZm9yY2UoXHJcbiAgICB0eXBlcy50dXBsZSh0eXBlcy5VSW50MzIsIHR5cGVzLkJ1ZmZlciwgLyogdHlwZXMuVUludDggKi8gdHlwZXMuTnVtYmVyKSxcclxuICAgIGFyZ3VtZW50cyxcclxuICApO1xyXG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9iaXRjb2luL2JpdGNvaW4vYmxvYi9tYXN0ZXIvc3JjL3Rlc3Qvc2lnaGFzaF90ZXN0cy5jcHAjTDI5XHJcbiAgaWYgKGluSW5kZXggPj0gY2xvbmVUeC5pbnMubGVuZ3RoKSByZXR1cm4gT05FO1xyXG4gIC8vIGlnbm9yZSBPUF9DT0RFU0VQQVJBVE9SXHJcbiAgY29uc3QgZGVjb21waWxlZCA9IGJzY3JpcHQuZGVjb21waWxlKHByZXZPdXRTY3JpcHQpO1xyXG4gIGlmIChkZWNvbXBpbGVkID09PSBudWxsKSByZXR1cm4gT05FO1xyXG4gIGNvbnN0IG91clNjcmlwdCA9IGJzY3JpcHQuY29tcGlsZShcclxuICAgIGRlY29tcGlsZWQuZmlsdGVyKHggPT4ge1xyXG4gICAgICByZXR1cm4geCAhPT0gc2NyaXB0XzEuT1BTLk9QX0NPREVTRVBBUkFUT1I7XHJcbiAgICB9KSxcclxuICApO1xyXG4gIGNvbnN0IHR4VG1wID0gY2xvbmVUeDtcclxuICAvLyBTSUdIQVNIX05PTkU6IGlnbm9yZSBhbGwgb3V0cHV0cz8gKHdpbGRjYXJkIHBheWVlKVxyXG4gIGlmICgoaGFzaFR5cGUgJiAweDFmKSA9PT0gVHJhbnNhY3Rpb24uU0lHSEFTSF9OT05FKSB7XHJcbiAgICB0eFRtcC5vdXRzID0gW107XHJcbiAgICAvLyBpZ25vcmUgc2VxdWVuY2UgbnVtYmVycyAoZXhjZXB0IGF0IGluSW5kZXgpXHJcbiAgICB0eFRtcC5pbnMuZm9yRWFjaCgoaW5wdXQsIGkpID0+IHtcclxuICAgICAgaWYgKGkgPT09IGluSW5kZXgpIHJldHVybjtcclxuICAgICAgaW5wdXQuc2VxdWVuY2UgPSAwO1xyXG4gICAgfSk7XHJcbiAgICAvLyBTSUdIQVNIX1NJTkdMRTogaWdub3JlIGFsbCBvdXRwdXRzLCBleGNlcHQgYXQgdGhlIHNhbWUgaW5kZXg/XHJcbiAgfSBlbHNlIGlmICgoaGFzaFR5cGUgJiAweDFmKSA9PT0gVHJhbnNhY3Rpb24uU0lHSEFTSF9TSU5HTEUpIHtcclxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9iaXRjb2luL2JpdGNvaW4vYmxvYi9tYXN0ZXIvc3JjL3Rlc3Qvc2lnaGFzaF90ZXN0cy5jcHAjTDYwXHJcbiAgICBpZiAoaW5JbmRleCA+PSBjbG9uZVR4Lm91dHMubGVuZ3RoKSByZXR1cm4gT05FO1xyXG4gICAgLy8gdHJ1bmNhdGUgb3V0cHV0cyBhZnRlclxyXG4gICAgdHhUbXAub3V0cy5sZW5ndGggPSBpbkluZGV4ICsgMTtcclxuICAgIC8vIFwiYmxhbmtcIiBvdXRwdXRzIGJlZm9yZVxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbkluZGV4OyBpKyspIHtcclxuICAgICAgdHhUbXAub3V0c1tpXSA9IEJMQU5LX09VVFBVVDtcclxuICAgIH1cclxuICAgIC8vIGlnbm9yZSBzZXF1ZW5jZSBudW1iZXJzIChleGNlcHQgYXQgaW5JbmRleClcclxuICAgIHR4VG1wLmlucy5mb3JFYWNoKChpbnB1dCwgeSkgPT4ge1xyXG4gICAgICBpZiAoeSA9PT0gaW5JbmRleCkgcmV0dXJuO1xyXG4gICAgICBpbnB1dC5zZXF1ZW5jZSA9IDA7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLy8gU0lHSEFTSF9BTllPTkVDQU5QQVk6IGlnbm9yZSBpbnB1dHMgZW50aXJlbHk/XHJcbiAgaWYgKGhhc2hUeXBlICYgVHJhbnNhY3Rpb24uU0lHSEFTSF9BTllPTkVDQU5QQVkpIHtcclxuICAgIHR4VG1wLmlucyA9IFt0eFRtcC5pbnNbaW5JbmRleF1dO1xyXG4gICAgdHhUbXAuaW5zWzBdLnNjcmlwdCA9IG91clNjcmlwdDtcclxuICAgIC8vIFNJR0hBU0hfQUxMOiBvbmx5IGlnbm9yZSBpbnB1dCBzY3JpcHRzXHJcbiAgfSBlbHNlIHtcclxuICAgIC8vIFwiYmxhbmtcIiBvdGhlcnMgaW5wdXQgc2NyaXB0c1xyXG4gICAgdHhUbXAuaW5zLmZvckVhY2goaW5wdXQgPT4ge1xyXG4gICAgICBpbnB1dC5zY3JpcHQgPSBFTVBUWV9CVUZGRVI7XHJcbiAgICB9KTtcclxuICAgIHR4VG1wLmluc1tpbkluZGV4XS5zY3JpcHQgPSBvdXJTY3JpcHQ7XHJcbiAgfVxyXG4gIC8vIHNlcmlhbGl6ZSBhbmQgaGFzaFxyXG4gIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSh0eFRtcC5ieXRlTGVuZ3RoKGZhbHNlKSArIDQpO1xyXG4gIGJ1ZmZlci53cml0ZUludDMyTEUoaGFzaFR5cGUsIGJ1ZmZlci5sZW5ndGggLSA0KTtcclxuICB0eFRtcC5fX3RvQnVmZmVyKGJ1ZmZlciwgMCwgZmFsc2UpO1xyXG4gIHJldHVybiBiY3J5cHRvLnNoYTI1NihidWZmZXIpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaGFzaEZvcldpdG5lc3NWMChpbkluZGV4LCBwcmV2T3V0U2NyaXB0LCB2YWx1ZSwgaGFzaFR5cGUsIGNsb25lVHgpIHtcclxuICB0eXBlZm9yY2UoXHJcbiAgICB0eXBlcy50dXBsZSh0eXBlcy5VSW50MzIsIHR5cGVzLkJ1ZmZlciwgdHlwZXMuU2F0b3NoaSwgdHlwZXMuVUludDMyKSxcclxuICAgIGFyZ3VtZW50cyxcclxuICApO1xyXG4gIGxldCB0YnVmZmVyID0gQnVmZmVyLmZyb20oW10pO1xyXG4gIGxldCBidWZmZXJXcml0ZXI7XHJcbiAgbGV0IGhhc2hPdXRwdXRzID0gWkVSTztcclxuICBsZXQgaGFzaFByZXZvdXRzID0gWkVSTztcclxuICBsZXQgaGFzaFNlcXVlbmNlID0gWkVSTztcclxuICBpZiAoIShoYXNoVHlwZSAmIFRyYW5zYWN0aW9uLlNJR0hBU0hfQU5ZT05FQ0FOUEFZKSkge1xyXG4gICAgdGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSgzNiAqIGNsb25lVHguaW5zLmxlbmd0aCk7XHJcbiAgICBidWZmZXJXcml0ZXIgPSBuZXcgYnVmZmVydXRpbHNfMS5CdWZmZXJXcml0ZXIodGJ1ZmZlciwgMCk7XHJcbiAgICBjbG9uZVR4Lmlucy5mb3JFYWNoKHR4SW4gPT4ge1xyXG4gICAgICBidWZmZXJXcml0ZXIud3JpdGVTbGljZSh0eEluLmhhc2gpO1xyXG4gICAgICBidWZmZXJXcml0ZXIud3JpdGVVSW50MzIodHhJbi5pbmRleCk7XHJcbiAgICB9KTtcclxuICAgIGhhc2hQcmV2b3V0cyA9IGJjcnlwdG8uc2hhMjU2KHRidWZmZXIpO1xyXG4gIH1cclxuICBpZiAoXHJcbiAgICAhKGhhc2hUeXBlICYgVHJhbnNhY3Rpb24uU0lHSEFTSF9BTllPTkVDQU5QQVkpICYmXHJcbiAgICAoaGFzaFR5cGUgJiAweDFmKSAhPT0gVHJhbnNhY3Rpb24uU0lHSEFTSF9TSU5HTEUgJiZcclxuICAgIChoYXNoVHlwZSAmIDB4MWYpICE9PSBUcmFuc2FjdGlvbi5TSUdIQVNIX05PTkVcclxuICApIHtcclxuICAgIHRidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoNCAqIGNsb25lVHguaW5zLmxlbmd0aCk7XHJcbiAgICBidWZmZXJXcml0ZXIgPSBuZXcgYnVmZmVydXRpbHNfMS5CdWZmZXJXcml0ZXIodGJ1ZmZlciwgMCk7XHJcbiAgICBjbG9uZVR4Lmlucy5mb3JFYWNoKHR4SW4gPT4ge1xyXG4gICAgICBidWZmZXJXcml0ZXIud3JpdGVVSW50MzIodHhJbi5zZXF1ZW5jZSk7XHJcbiAgICB9KTtcclxuICAgIGhhc2hTZXF1ZW5jZSA9IGJjcnlwdG8uc2hhMjU2KHRidWZmZXIpO1xyXG4gIH1cclxuICBpZiAoXHJcbiAgICAoaGFzaFR5cGUgJiAweDFmKSAhPT0gVHJhbnNhY3Rpb24uU0lHSEFTSF9TSU5HTEUgJiZcclxuICAgIChoYXNoVHlwZSAmIDB4MWYpICE9PSBUcmFuc2FjdGlvbi5TSUdIQVNIX05PTkVcclxuICApIHtcclxuICAgIGNvbnN0IHR4T3V0c1NpemUgPSBjbG9uZVR4Lm91dHMucmVkdWNlKChzdW0sIG91dHB1dCkgPT4ge1xyXG4gICAgICByZXR1cm4gc3VtICsgOCArIHZhclNsaWNlU2l6ZShvdXRwdXQuc2NyaXB0KTtcclxuICAgIH0sIDApO1xyXG4gICAgdGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSh0eE91dHNTaXplKTtcclxuICAgIGJ1ZmZlcldyaXRlciA9IG5ldyBidWZmZXJ1dGlsc18xLkJ1ZmZlcldyaXRlcih0YnVmZmVyLCAwKTtcclxuICAgIGNsb25lVHgub3V0cy5mb3JFYWNoKG91dCA9PiB7XHJcbiAgICAgIGJ1ZmZlcldyaXRlci53cml0ZVVJbnQ2NChvdXQudmFsdWUpO1xyXG4gICAgICBidWZmZXJXcml0ZXIud3JpdGVWYXJTbGljZShvdXQuc2NyaXB0KTtcclxuICAgIH0pO1xyXG4gICAgaGFzaE91dHB1dHMgPSBiY3J5cHRvLnNoYTI1Nih0YnVmZmVyKTtcclxuICB9IGVsc2UgaWYgKFxyXG4gICAgKGhhc2hUeXBlICYgMHgxZikgPT09IFRyYW5zYWN0aW9uLlNJR0hBU0hfU0lOR0xFICYmXHJcbiAgICBpbkluZGV4IDwgY2xvbmVUeC5vdXRzLmxlbmd0aFxyXG4gICkge1xyXG4gICAgY29uc3Qgb3V0cHV0ID0gY2xvbmVUeC5vdXRzW2luSW5kZXhdO1xyXG4gICAgdGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSg4ICsgdmFyU2xpY2VTaXplKG91dHB1dC5zY3JpcHQpKTtcclxuICAgIGJ1ZmZlcldyaXRlciA9IG5ldyBidWZmZXJ1dGlsc18xLkJ1ZmZlcldyaXRlcih0YnVmZmVyLCAwKTtcclxuICAgIGJ1ZmZlcldyaXRlci53cml0ZVVJbnQ2NChvdXRwdXQudmFsdWUpO1xyXG4gICAgYnVmZmVyV3JpdGVyLndyaXRlVmFyU2xpY2Uob3V0cHV0LnNjcmlwdCk7XHJcbiAgICBoYXNoT3V0cHV0cyA9IGJjcnlwdG8uc2hhMjU2KHRidWZmZXIpO1xyXG4gIH1cclxuICB0YnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKDE1NiArIHZhclNsaWNlU2l6ZShwcmV2T3V0U2NyaXB0KSk7XHJcbiAgYnVmZmVyV3JpdGVyID0gbmV3IGJ1ZmZlcnV0aWxzXzEuQnVmZmVyV3JpdGVyKHRidWZmZXIsIDApO1xyXG4gIGNvbnN0IGlucHV0ID0gY2xvbmVUeC5pbnNbaW5JbmRleF07XHJcbiAgYnVmZmVyV3JpdGVyLndyaXRlSW50MzIoY2xvbmVUeC52ZXJzaW9uKTtcclxuICBidWZmZXJXcml0ZXIud3JpdGVTbGljZShoYXNoUHJldm91dHMpO1xyXG4gIGJ1ZmZlcldyaXRlci53cml0ZVNsaWNlKGhhc2hTZXF1ZW5jZSk7XHJcbiAgYnVmZmVyV3JpdGVyLndyaXRlU2xpY2UoaW5wdXQuaGFzaCk7XHJcbiAgYnVmZmVyV3JpdGVyLndyaXRlVUludDMyKGlucHV0LmluZGV4KTtcclxuICBidWZmZXJXcml0ZXIud3JpdGVWYXJTbGljZShwcmV2T3V0U2NyaXB0KTtcclxuICBidWZmZXJXcml0ZXIud3JpdGVVSW50NjQodmFsdWUpO1xyXG4gIGJ1ZmZlcldyaXRlci53cml0ZVVJbnQzMihpbnB1dC5zZXF1ZW5jZSk7XHJcbiAgYnVmZmVyV3JpdGVyLndyaXRlU2xpY2UoaGFzaE91dHB1dHMpO1xyXG4gIGJ1ZmZlcldyaXRlci53cml0ZVVJbnQzMihjbG9uZVR4LmxvY2t0aW1lKTtcclxuICBidWZmZXJXcml0ZXIud3JpdGVVSW50MzIoaGFzaFR5cGUpO1xyXG4gIHJldHVybiBiY3J5cHRvLnNoYTI1Nih0YnVmZmVyKTtcclxufSJdfQ==