"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert = require("assert");
const mocha_1 = require("mocha");
const bs58check = require("bs58check");
const testutil_1 = require("../../../src/testutil");
const bitgo_1 = require("../../../src/bitgo");
const src_1 = require("../../../src");
const outputScripts_1 = require("../../../src/bitgo/outputScripts");
function getScriptTypes() {
    return [...bitgo_1.outputScripts.scriptTypes2Of3, 'p2shP2pk'];
}
const walletKeys = (0, testutil_1.getDefaultWalletKeys)();
function runTest(scriptType, signerName, cosignerName, network) {
    const signer = walletKeys[signerName];
    const cosigner = walletKeys[cosignerName];
    const networkName = (0, src_1.getNetworkName)(network);
    const signingKeys = [
        signerName === 'user' || (cosignerName === 'user' && scriptType !== 'p2shP2pk'),
        signerName === 'backup' || (cosignerName === 'backup' && scriptType !== 'p2shP2pk'),
        signerName === 'bitgo' || (cosignerName === 'bitgo' && scriptType !== 'p2shP2pk'),
    ];
    (0, mocha_1.describe)(`UtxoPsbt ${[
        `scriptType=${scriptType}`,
        `network=${networkName}`,
        `signer=${signerName}`,
        `cosigner=${cosignerName}`,
    ].join(',')}`, function () {
        let psbt;
        before('create transaction', async function () {
            // Build a fully hydrated UtxoPsbt
            psbt = (0, bitgo_1.createPsbtForNetwork)({ network });
            psbt.updateGlobal({
                globalXpub: walletKeys.triple.map((bip32) => {
                    const extendedPubkey = bip32.neutered().toBase58();
                    return {
                        extendedPubkey: bs58check.decode(extendedPubkey),
                        masterFingerprint: bip32.fingerprint,
                        path: 'm',
                    };
                }),
            });
            // Add the inputs
            if (scriptType === 'p2shP2pk') {
                const unspent = (0, testutil_1.mockReplayProtectionUnspent)(network, BigInt(1e8), { key: signer });
                const { redeemScript } = (0, outputScripts_1.createOutputScriptP2shP2pk)(signer.publicKey);
                assert(redeemScript);
                (0, bitgo_1.addReplayProtectionUnspentToPsbt)(psbt, unspent, redeemScript);
            }
            else {
                const unspents = (0, testutil_1.mockUnspents)(walletKeys, [scriptType], BigInt(1e8), network);
                unspents.forEach((unspent) => (0, bitgo_1.addWalletUnspentToPsbt)(psbt, unspent, walletKeys, signerName, cosignerName, {
                    isReplaceableByFee: true,
                }));
            }
            // Add the outputs
            (0, bitgo_1.addWalletOutputToPsbt)(psbt, walletKeys, (0, bitgo_1.getInternalChainCode)('p2sh'), 0, BigInt(1e8 - 10000));
        });
        (0, mocha_1.it)('can go from unsigned to fully signed', async function () {
            if (scriptType === 'p2trMusig2' && signerName === 'user' && cosignerName === 'bitgo') {
                psbt.setAllInputsMusig2NonceHD(signer);
                psbt.setAllInputsMusig2NonceHD(cosigner);
            }
            assert.ok(psbt.getSignatureValidationArray(0).every((res) => !res));
            if (scriptType === 'p2shP2pk') {
                psbt.signAllInputs(signer);
            }
            else {
                psbt.signAllInputsHD(signer);
                psbt.signAllInputsHD(cosigner);
            }
            assert(psbt.validateSignaturesOfAllInputs());
            assert.deepStrictEqual(psbt.getSignatureValidationArray(0), signingKeys);
            psbt.finalizeAllInputs();
            const tx = psbt.extractTransaction();
            assert(tx);
            if (scriptType === 'p2shP2pk') {
                tx.ins.forEach((input) => assert.strictEqual(input.sequence, bitgo_1.TX_INPUT_SEQUENCE_NUMBER_FINAL));
            }
            else {
                tx.ins.forEach((input) => assert.strictEqual(input.sequence, bitgo_1.MAX_BIP125_RBF_SEQUENCE));
            }
        });
    });
}
getScriptTypes().forEach((t) => {
    runTest(t, 'user', 'bitgo', src_1.networks.bitcoin);
    runTest(t, 'backup', 'user', src_1.networks.bitcoin);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmluZ0FuZFZhbGlkYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi90ZXN0L2JpdGdvL3BzYnQvc2lnbmluZ0FuZFZhbGlkYXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBaUM7QUFDakMsaUNBQXFDO0FBQ3JDLHVDQUF1QztBQUV2QyxvREFBd0c7QUFDeEcsOENBWTRCO0FBQzVCLHNDQUFpRTtBQUNqRSxvRUFBOEU7QUFFOUUsU0FBUyxjQUFjO0lBQ3JCLE9BQU8sQ0FBQyxHQUFHLHFCQUFhLENBQUMsZUFBZSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ3hELENBQUM7QUFFRCxNQUFNLFVBQVUsR0FBRyxJQUFBLCtCQUFvQixHQUFFLENBQUM7QUFDMUMsU0FBUyxPQUFPLENBQUMsVUFBb0MsRUFBRSxVQUFtQixFQUFFLFlBQXFCLEVBQUUsT0FBZ0I7SUFDakgsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3RDLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUUxQyxNQUFNLFdBQVcsR0FBRyxJQUFBLG9CQUFjLEVBQUMsT0FBTyxDQUFDLENBQUM7SUFDNUMsTUFBTSxXQUFXLEdBQUc7UUFDbEIsVUFBVSxLQUFLLE1BQU0sSUFBSSxDQUFDLFlBQVksS0FBSyxNQUFNLElBQUksVUFBVSxLQUFLLFVBQVUsQ0FBQztRQUMvRSxVQUFVLEtBQUssUUFBUSxJQUFJLENBQUMsWUFBWSxLQUFLLFFBQVEsSUFBSSxVQUFVLEtBQUssVUFBVSxDQUFDO1FBQ25GLFVBQVUsS0FBSyxPQUFPLElBQUksQ0FBQyxZQUFZLEtBQUssT0FBTyxJQUFJLFVBQVUsS0FBSyxVQUFVLENBQUM7S0FDbEYsQ0FBQztJQUVGLElBQUEsZ0JBQVEsRUFBQyxZQUFZO1FBQ25CLGNBQWMsVUFBVSxFQUFFO1FBQzFCLFdBQVcsV0FBVyxFQUFFO1FBQ3hCLFVBQVUsVUFB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RUFBRSxDQUFDLENBQUM7WUFDN0MsTUFBTSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDekUsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDekIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDckMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ1gsSUFBSSxVQUFVLEtBQUssVUFBVSxFQUFFO2dCQUM3QixFQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLHNDQUE4QixDQUFDLENBQUMsQ0FBQzthQUMvRjtpQkFBTTtnQkFDTCxFQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLCtCQUF1QixDQUFDLENBQUMsQ0FBQzthQUN4RjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsY0FBYyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7SUFDN0IsT0FBTyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLGNBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QyxPQUFPLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsY0FBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2pELENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XHJcbmltcG9ydCB7IGRlc2NyaWJlLCBpdCB9IGZyb20gJ21vY2hhJztcclxuaW1wb3J0ICogYXMgYnM1OGNoZWNrIGZyb20gJ2JzNThjaGVjayc7XHJcblxyXG5pbXBvcnQgeyBnZXREZWZhdWx0V2FsbGV0S2V5cywgbW9ja1JlcGxheVByb3RlY3Rpb25VbnNwZW50LCBtb2NrVW5zcGVudHMgfSBmcm9tICcuLi8uLi8uLi9zcmMvdGVzdHV0aWwnO1xyXG5pbXBvcnQge1xyXG4gIGFkZFJlcGxheVByb3RlY3Rpb25VbnNwZW50VG9Qc2J0LFxyXG4gIGFkZFdhbGxldE91dHB1dFRvUHNidCxcclxuICBhZGRXYWxsZXRVbnNwZW50VG9Qc2J0LFxyXG4gIGNyZWF0ZVBzYnRGb3JOZXR3b3JrLFxyXG4gIE1BWF9CSVAxMjVfUkJGX1NFUVVFTkNFLFxyXG4gIFRYX0lOUFVUX1NFUVVFTkNFX05VTUJFUl9GSU5BTCxcclxuICBnZXRJbnRlcm5hbENoYWluQ29kZSxcclxuICBLZXlOYW1lLFxyXG4gIG91dHB1dFNjcmlwdHMsXHJcbiAgVXR4b1BzYnQsXHJcbiAgV2FsbGV0VW5zcGVudCxcclxufSBmcm9tICcuLi8uLi8uLi9zcmMvYml0Z28nO1xyXG5pbXBvcnQgeyBnZXROZXR3b3JrTmFtZSwgTmV0d29yaywgbmV0d29ya3MgfSBmcm9tICcuLi8uLi8uLi9zcmMnO1xyXG5pbXBvcnQgeyBjcmVhdGVPdXRwdXRTY3JpcHRQMnNoUDJwayB9IGZyb20gJy4uLy4uLy4uL3NyYy9iaXRnby9vdXRwdXRTY3JpcHRzJztcclxuXHJcbmZ1bmN0aW9uIGdldFNjcmlwdFR5cGVzKCk6IG91dHB1dFNjcmlwdHMuU2NyaXB0VHlwZVtdIHtcclxuICByZXR1cm4gWy4uLm91dHB1dFNjcmlwdHMuc2NyaXB0VHlwZXMyT2YzLCAncDJzaFAycGsnXTtcclxufVxyXG5cclxuY29uc3Qgd2FsbGV0S2V5cyA9IGdldERlZmF1bHRXYWxsZXRLZXlzKCk7XHJcbmZ1bmN0aW9uIHJ1blRlc3Qoc2NyaXB0VHlwZTogb3V0cHV0U2NyaXB0cy5TY3JpcHRUeXBlLCBzaWduZXJOYW1lOiBLZXlOYW1lLCBjb3NpZ25lck5hbWU6IEtleU5hbWUsIG5ldHdvcms6IE5ldHdvcmspIHtcclxuICBjb25zdCBzaWduZXIgPSB3YWxsZXRLZXlzW3NpZ25lck5hbWVdO1xyXG4gIGNvbnN0IGNvc2lnbmVyID0gd2FsbGV0S2V5c1tjb3NpZ25lck5hbWVdO1xyXG5cclxuICBjb25zdCBuZXR3b3JrTmFtZSA9IGdldE5ldHdvcmtOYW1lKG5ldHdvcmspO1xyXG4gIGNvbnN0IHNpZ25pbmdLZXlzID0gW1xyXG4gICAgc2lnbmVyTmFtZSA9PT0gJ3VzZXInIHx8IChjb3NpZ25lck5hbWUgPT09ICd1c2VyJyAmJiBzY3JpcHRUeXBlICE9PSAncDJzaFAycGsnKSxcclxuICAgIHNpZ25lck5hbWUgPT09ICdiYWNrdXAnIHx8IChjb3NpZ25lck5hbWUgPT09ICdiYWNrdXAnICYmIHNjcmlwdFR5cGUgIT09ICdwMnNoUDJwaycpLFxyXG4gICAgc2lnbmVyTmFtZSA9PT0gJ2JpdGdvJyB8fCAoY29zaWduZXJOYW1lID09PSAnYml0Z28nICYmIHNjcmlwdFR5cGUgIT09ICdwMnNoUDJwaycpLFxyXG4gIF07XHJcblxyXG4gIGRlc2NyaWJlKGBVdHhvUHNidCAke1tcclxuICAgIGBzY3JpcHRUeXBlPSR7c2NyaXB0VHlwZX1gLFxyXG4gICAgYG5ldHdvcms9JHtuZXR3b3JrTmFtZX1gLFxyXG4gICAgYHNpZ25lcj0ke3NpZ25lck5hbWV9YCxcclxuICAgIGBjb3NpZ25lcj0ke2Nvc2lnbmVyTmFtZX1gLFxyXG4gIF0uam9pbignLCcpfWAsIGZ1bmN0aW9uICgpIHtcclxuICAgIGxldCBwc2J0OiBVdHhvUHNidDtcclxuICAgIGJlZm9yZSgnY3JlYXRlIHRyYW5zYWN0aW9uJywgYXN5bmMgZnVuY3Rpb24gKCkge1xyXG4gICAgICAvLyBCdWlsZCBhIGZ1bGx5IGh5ZHJhdGVkIFV0eG9Qc2J0XHJcbiAgICAgIHBzYnQgPSBjcmVhdGVQc2J0Rm9yTmV0d29yayh7IG5ldHdvcmsgfSk7XHJcbiAgICAgIHBzYnQudXBkYXRlR2xvYmFsKHtcclxuICAgICAgICBnbG9iYWxYcHViOiB3YWxsZXRLZXlzLnRyaXBsZS5tYXAoKGJpcDMyKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBleHRlbmRlZFB1YmtleSA9IGJpcDMyLm5ldXRlcmVkKCkudG9CYXNlNTgoKTtcclxuICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGV4dGVuZGVkUHVia2V5OiBiczU4Y2hlY2suZGVjb2RlKGV4dGVuZGVkUHVia2V5KSxcclxuICAgICAgICAgICAgbWFzdGVyRmluZ2VycHJpbnQ6IGJpcDMyLmZpbmdlcnByaW50LFxyXG4gICAgICAgICAgICBwYXRoOiAnbScsXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH0pLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIEFkZCB0aGUgaW5wdXRzXHJcbiAgICAgIGlmIChzY3JpcHRUeXBlID09PSAncDJzaFAycGsnKSB7XHJcbiAgICAgICAgY29uc3QgdW5zcGVudCA9IG1vY2tSZXBsYXlQcm90ZWN0aW9uVW5zcGVudChuZXR3b3JrLCBCaWdJbnQoMWU4KSwgeyBrZXk6IHNpZ25lciB9KTtcclxuICAgICAgICBjb25zdCB7IHJlZGVlbVNjcmlwdCB9ID0gY3JlYXRlT3V0cHV0U2NyaXB0UDJzaFAycGsoc2lnbmVyLnB1YmxpY0tleSk7XHJcbiAgICAgICAgYXNzZXJ0KHJlZGVlbVNjcmlwdCk7XHJcbiAgICAgICAgYWRkUmVwbGF5UHJvdGVjdGlvblVuc3BlbnRUb1BzYnQocHNidCwgdW5zcGVudCwgcmVkZWVtU2NyaXB0KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCB1bnNwZW50cyA9IG1vY2tVbnNwZW50cyh3YWxsZXRLZXlzLCBbc2NyaXB0VHlwZV0sIEJpZ0ludCgxZTgpLCBuZXR3b3JrKSBhcyBXYWxsZXRVbnNwZW50PGJpZ2ludD5bXTtcclxuICAgICAgICB1bnNwZW50cy5mb3JFYWNoKCh1bnNwZW50KSA9PlxyXG4gICAgICAgICAgYWRkV2FsbGV0VW5zcGVudFRvUHNidChwc2J0LCB1bnNwZW50LCB3YWxsZXRLZXlzLCBzaWduZXJOYW1lLCBjb3NpZ25lck5hbWUsIHtcclxuICAgICAgICAgICAgaXNSZXBsYWNlYWJsZUJ5RmVlOiB0cnVlLFxyXG4gICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBBZGQgdGhlIG91dHB1dHNcclxuICAgICAgYWRkV2FsbGV0T3V0cHV0VG9Qc2J0KHBzYnQsIHdhbGxldEtleXMsIGdldEludGVybmFsQ2hhaW5Db2RlKCdwMnNoJyksIDAsIEJpZ0ludCgxZTggLSAxMDAwMCkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2NhbiBnbyBmcm9tIHVuc2lnbmVkIHRvIGZ1bGx5IHNpZ25lZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcclxuICAgICAgaWYgKHNjcmlwdFR5cGUgPT09ICdwMnRyTXVzaWcyJyAmJiBzaWduZXJOYW1lID09PSAndXNlcicgJiYgY29zaWduZXJOYW1lID09PSAnYml0Z28nKSB7XHJcbiAgICAgICAgcHNidC5zZXRBbGxJbnB1dHNNdXNpZzJOb25jZUhEKHNpZ25lcik7XHJcbiAgICAgICAgcHNidC5zZXRBbGxJbnB1dHNNdXNpZzJOb25jZUhEKGNvc2lnbmVyKTtcclxuICAgICAgfVxyXG4gICAgICBhc3NlcnQub2socHNidC5nZXRTaWduYXR1cmVWYWxpZGF0aW9uQXJyYXkoMCkuZXZlcnkoKHJlcykgPT4gIXJlcykpO1xyXG4gICAgICBpZiAoc2NyaXB0VHlwZSA9PT0gJ3Ayc2hQMnBrJykge1xyXG4gICAgICAgIHBzYnQuc2lnbkFsbElucHV0cyhzaWduZXIpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHBzYnQuc2lnbkFsbElucHV0c0hEKHNpZ25lcik7XHJcbiAgICAgICAgcHNidC5zaWduQWxsSW5wdXRzSEQoY29zaWduZXIpO1xyXG4gICAgICB9XHJcbiAgICAgIGFzc2VydChwc2J0LnZhbGlkYXRlU2lnbmF0dXJlc09mQWxsSW5wdXRzKCkpO1xyXG4gICAgICBhc3NlcnQuZGVlcFN0cmljdEVxdWFsKHBzYnQuZ2V0U2lnbmF0dXJlVmFsaWRhdGlvbkFycmF5KDApLCBzaWduaW5nS2V5cyk7XHJcbiAgICAgIHBzYnQuZmluYWxpemVBbGxJbnB1dHMoKTtcclxuICAgICAgY29uc3QgdHggPSBwc2J0LmV4dHJhY3RUcmFuc2FjdGlvbigpO1xyXG4gICAgICBhc3NlcnQodHgpO1xyXG4gICAgICBpZiAoc2NyaXB0VHlwZSA9PT0gJ3Ayc2hQMnBrJykge1xyXG4gICAgICAgIHR4Lmlucy5mb3JFYWNoKChpbnB1dCkgPT4gYXNzZXJ0LnN0cmljdEVxdWFsKGlucHV0LnNlcXVlbmNlLCBUWF9JTlBVVF9TRVFVRU5DRV9OVU1CRVJfRklOQUwpKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0eC5pbnMuZm9yRWFjaCgoaW5wdXQpID0+IGFzc2VydC5zdHJpY3RFcXVhbChpbnB1dC5zZXF1ZW5jZSwgTUFYX0JJUDEyNV9SQkZfU0VRVUVOQ0UpKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmdldFNjcmlwdFR5cGVzKCkuZm9yRWFjaCgodCkgPT4ge1xyXG4gIHJ1blRlc3QodCwgJ3VzZXInLCAnYml0Z28nLCBuZXR3b3Jrcy5iaXRjb2luKTtcclxuICBydW5UZXN0KHQsICdiYWNrdXAnLCAndXNlcicsIG5ldHdvcmtzLmJpdGNvaW4pO1xyXG59KTtcclxuIl19