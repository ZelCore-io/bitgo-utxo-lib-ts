"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getTransactionStages = exports.getFullSignedTransaction2Of3 = exports.getFullSignedTransactionP2shP2pk = exports.getHalfSignedTransaction2Of3 = exports.getUnsignedTransaction2Of3 = exports.getTransactionBuilder = exports.getPrevOutputs = exports.getPrevOutput = exports.mockTransactionId = exports.defaultTestOutputAmount = exports.parseTransactionRoundTrip = exports.getSignKeyCombinations = void 0;
const assert = require("assert");
const src_1 = require("../src");
const outputScripts_1 = require("../src/bitgo/outputScripts");
const bitgo_1 = require("../src/bitgo");
const outputScripts_util_1 = require("./integration_local_rpc/generate/outputScripts.util");
const fixtures_1 = require("./integration_local_rpc/generate/fixtures");
function getSignKeyCombinations(length) {
    if (length === 0) {
        return [];
    }
    if (length === 1) {
        return fixtures_1.fixtureKeys.map((k) => [k]);
    }
    return getSignKeyCombinations(length - 1)
        .map((head) => fixtures_1.fixtureKeys.filter((k) => !head.includes(k)).map((k) => [...head, k]))
        .reduce((all, keys) => [...all, ...keys]);
}
exports.getSignKeyCombinations = getSignKeyCombinations;
function parseTransactionRoundTrip(buf, network, { inputs, amountType = 'number', version, roundTripPsbt = true, } = {}) {
    const tx = (0, bitgo_1.createTransactionFromBuffer)(buf, network, { version, amountType });
    assert.strictEqual(tx.byteLength(), buf.length);
    assert.strictEqual(tx.toBuffer().toString('hex'), buf.toString('hex'));
    // Test `Transaction.clone()` implementation
    assert.strictEqual(tx.clone().toBuffer().toString('hex'), buf.toString('hex'));
    if (inputs) {
        const bigintTx = tx.clone('bigint');
        const bigintInputs = inputs.map((input) => ({ ...input, value: BigInt(input.value) }));
        if (roundTripPsbt) {
            // Test UtxoPsbt.fromTransaction() implementation
            assert.strictEqual(bitgo_1.UtxoPsbt.fromTransaction(bigintTx, bigintInputs)
                .finalizeAllInputs()
                .extractTransaction()
                .toBuffer()
                .toString('hex'), buf.toString('hex'));
            // Test UtxoPsbt.toBuffer() and UtxoPsbt.fromBuffer() implementation
            assert.strictEqual((0, bitgo_1.createPsbtFromBuffer)((0, bitgo_1.createPsbtFromTransaction)(bigintTx, bigintInputs).toBuffer(), network)
                .finalizeAllInputs()
                .extractTransaction()
                .toBuffer()
                .toString('hex'), buf.toString('hex'));
        }
        // Test `TransactionBuilder.fromTransaction()` implementation
        assert.strictEqual((0, bitgo_1.createTransactionBuilderFromTransaction)(tx, inputs).build().toBuffer().toString('hex'), buf.toString('hex'));
    }
    return tx;
}
exports.parseTransactionRoundTrip = parseTransactionRoundTrip;
exports.defaultTestOutputAmount = 1e8;
function mockTransactionId(v = 0xff) {
    return Buffer.alloc(32).fill(v).toString('hex');
}
exports.mockTransactionId = mockTransactionId;
function getPrevOutput(scriptType, value, network, vout = 0, { keys = fixtures_1.fixtureKeys, prevTx, } = {}) {
    const script = (0, outputScripts_1.isScriptType2Of3)(scriptType)
        ? (0, outputScripts_1.createOutputScript2of3)(keys.map((k) => k.publicKey), scriptType).scriptPubKey
        : (0, outputScripts_1.createOutputScriptP2shP2pk)(keys[0].publicKey).scriptPubKey;
    if (prevTx === true) {
        const txb = (0, bitgo_1.createTransactionBuilderForNetwork)(network);
        txb.addInput(Buffer.alloc(32).fill(1), 0);
        txb.addOutput(script, value);
        prevTx = txb.buildIncomplete();
    }
    return {
        txid: prevTx ? prevTx.getId() : mockTransactionId(),
        vout,
        script,
        value,
        prevTx: prevTx ? prevTx.toBuffer() : undefined,
    };
}
exports.getPrevOutput = getPrevOutput;
function getPrevOutputs(scriptType, value, network, { keys = fixtures_1.fixtureKeys, prevTx } = {}) {
    return [getPrevOutput(scriptType, value, network, 0, { keys, prevTx })];
}
exports.getPrevOutputs = getPrevOutputs;
function getTransactionBuilder(keys, halfSigners, scriptType, network, { amountType = 'number', outputAmount = exports.defaultTestOutputAmount, prevOutputs = getPrevOutputs(scriptType, (0, bitgo_1.toTNumber)(outputAmount, amountType), network), } = {}) {
    const txBuilder = (0, bitgo_1.createTransactionBuilderForNetwork)(network);
    prevOutputs.forEach(({ txid, vout }) => {
        txBuilder.addInput(txid, vout);
    });
    const recipientScript = (0, outputScripts_util_1.createScriptPubKey)(fixtures_1.fixtureKeys, 'p2pkh', src_1.networks.bitcoin);
    txBuilder.addOutput(recipientScript, (0, bitgo_1.toTNumber)(BigInt(outputAmount) - BigInt(1000), amountType));
    const pubkeys = keys.map((k) => k.publicKey);
    assert((0, bitgo_1.isTriple)(pubkeys));
    prevOutputs.forEach(({ value }, vin) => {
        halfSigners.forEach(({ signer, cosigner }) => {
            if (scriptType === 'p2shP2pk') {
                (0, bitgo_1.signInputP2shP2pk)(txBuilder, vin, signer);
            }
            else {
                if (!cosigner) {
                    throw new Error(`must set cosigner`);
                }
                (0, bitgo_1.signInput2Of3)(txBuilder, vin, scriptType, pubkeys, signer, cosigner.publicKey, value);
            }
        });
    });
    return txBuilder;
}
exports.getTransactionBuilder = getTransactionBuilder;
function getUnsignedTransaction2Of3(keys, scriptType, network, params = {}) {
    return getTransactionBuilder(keys, [], scriptType, network, params).buildIncomplete();
}
exports.getUnsignedTransaction2Of3 = getUnsignedTransaction2Of3;
function getHalfSignedTransaction2Of3(keys, signer1, signer2, scriptType, network, opts = {}) {
    return getTransactionBuilder(keys, [{ signer: signer1, cosigner: signer2 }], scriptType, network, opts).buildIncomplete();
}
exports.getHalfSignedTransaction2Of3 = getHalfSignedTransaction2Of3;
function getFullSignedTransactionP2shP2pk(keys, signer1, network, opts = {}) {
    return getTransactionBuilder(keys, [{ signer: signer1 }], 'p2shP2pk', network, opts).build();
}
exports.getFullSignedTransactionP2shP2pk = getFullSignedTransactionP2shP2pk;
function getFullSignedTransaction2Of3(keys, signer1, signer2, scriptType, network, opts = {}) {
    return getTransactionBuilder(keys, [
        { signer: signer1, cosigner: signer2 },
        { signer: signer2, cosigner: signer1 },
    ], scriptType, network, opts).build();
}
exports.getFullSignedTransaction2Of3 = getFullSignedTransaction2Of3;
function getTransactionStages(keys, signer1, signer2, scriptType, network, opts) {
    const halfSigned = getHalfSignedTransaction2Of3(keys, signer1, signer2, scriptType, network, opts);
    const fullSigned = scriptType === 'p2shP2pk'
        ? halfSigned
        : getFullSignedTransaction2Of3(keys, signer1, signer2, scriptType, network, opts);
    return {
        unsigned: getUnsignedTransaction2Of3(keys, scriptType, network, opts),
        halfSigned,
        fullSigned,
    };
}
exports.getTransactionStages = getTransactionStages;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb25fdXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3Rlc3QvdHJhbnNhY3Rpb25fdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxpQ0FBaUM7QUFHakMsZ0NBQTJDO0FBRTNDLDhEQUtvQztBQUNwQyx3Q0Flc0I7QUFHdEIsNEZBQXlGO0FBQ3pGLHdFQUF3RTtBQUV4RSxTQUFnQixzQkFBc0IsQ0FBQyxNQUFjO0lBQ25ELElBQUksTUFBTSxLQUFLLENBQUMsRUFBRTtRQUNoQixPQUFPLEVBQUUsQ0FBQztLQUNYO0lBQ0QsSUFBSSxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQ2hCLE9BQU8sc0JBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNwQztJQUNELE9BQU8sc0JBQXNCLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztTQUN0QyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLHNCQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNwRixNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUM5QyxDQUFDO0FBVkQsd0RBVUM7QUFFRCxTQUFnQix5QkFBeUIsQ0FDdkMsR0FBVyxFQUNYLE9BQWdCLEVBQ2hCLEVBQ0UsTUFBTSxFQUNOLFVBQVUsR0FBRyxRQUFRLEVBQ3JCLE9BQU8sRUFDUCxhQUFhLEdBQUcsSUFBSSxNQU1sQixFQUFFO0lBRU4s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ZmFjZSB9IGZyb20gJ2JpcDMyJztcclxuaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XHJcbmltcG9ydCB7IFR4T3V0cHV0IH0gZnJvbSAnYml0Y29pbmpzLWxpYic7XHJcblxyXG5pbXBvcnQgeyBuZXR3b3JrcywgTmV0d29yayB9IGZyb20gJy4uL3NyYyc7XHJcblxyXG5pbXBvcnQge1xyXG4gIGNyZWF0ZU91dHB1dFNjcmlwdDJvZjMsXHJcbiAgY3JlYXRlT3V0cHV0U2NyaXB0UDJzaFAycGssXHJcbiAgaXNTY3JpcHRUeXBlMk9mMyxcclxuICBTY3JpcHRUeXBlMk9mMyxcclxufSBmcm9tICcuLi9zcmMvYml0Z28vb3V0cHV0U2NyaXB0cyc7XHJcbmltcG9ydCB7XHJcbiAgaXNUcmlwbGUsXHJcbiAgY3JlYXRlUHNidEZyb21CdWZmZXIsXHJcbiAgY3JlYXRlUHNidEZyb21UcmFuc2FjdGlvbixcclxuICBjcmVhdGVUcmFuc2FjdGlvbkJ1aWxkZXJGb3JOZXR3b3JrLFxyXG4gIGNyZWF0ZVRyYW5zYWN0aW9uQnVpbGRlckZyb21UcmFuc2FjdGlvbixcclxuICBjcmVhdGVUcmFuc2FjdGlvbkZyb21CdWZmZXIsXHJcbiAgc2lnbklucHV0Mk9mMyxcclxuICBzaWduSW5wdXRQMnNoUDJwayxcclxuICBUeE91dFBvaW50LFxyXG4gIFV0eG9UcmFuc2FjdGlvbixcclxuICBVdHhvVHJhbnNhY3Rpb25CdWlsZGVyLFxyXG4gIFByZXZPdXRwdXQsXHJcbiAgdG9UTnVtYmVyLFxyXG4gIFV0eG9Qc2J0LFxyXG59IGZyb20gJy4uL3NyYy9iaXRnbyc7XHJcbmltcG9ydCB7IEtleVRyaXBsZSB9IGZyb20gJy4uL3NyYy90ZXN0dXRpbCc7XHJcblxyXG5pbXBvcnQgeyBjcmVhdGVTY3JpcHRQdWJLZXkgfSBmcm9tICcuL2ludGVncmF0aW9uX2xvY2FsX3JwYy9nZW5lcmF0ZS9vdXRwdXRTY3JpcHRzLnV0aWwnO1xyXG5pbXBvcnQgeyBmaXh0dXJlS2V5cyB9IGZyb20gJy4vaW50ZWdyYXRpb25fbG9jYWxfcnBjL2dlbmVyYXRlL2ZpeHR1cmVzJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRTaWduS2V5Q29tYmluYXRpb25zKGxlbmd0aDogbnVtYmVyKTogQklQMzJJbnRlcmZhY2VbXVtdIHtcclxuICBpZiAobGVuZ3RoID09PSAwKSB7XHJcbiAgICByZXR1cm4gW107XHJcbiAgfVxyXG4gIGlmIChsZW5ndGggPT09IDEpIHtcclxuICAgIHJldHVybiBmaXh0dXJlS2V5cy5tYXAoKGspID0+IFtrXSk7XHJcbiAgfVxyXG4gIHJldHVybiBnZXRTaWduS2V5Q29tYmluYXRpb25zKGxlbmd0aCAtIDEpXHJcbiAgICAubWFwKChoZWFkKSA9PiBmaXh0dXJlS2V5cy5maWx0ZXIoKGspID0+ICFoZWFkLmluY2x1ZGVzKGspKS5tYXAoKGspID0+IFsuLi5oZWFkLCBrXSkpXHJcbiAgICAucmVkdWNlKChhbGwsIGtleXMpID0+IFsuLi5hbGwsIC4uLmtleXNdKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlVHJhbnNhY3Rpb25Sb3VuZFRyaXA8VE51bWJlciBleHRlbmRzIG51bWJlciB8IGJpZ2ludCwgVCBleHRlbmRzIFV0eG9UcmFuc2FjdGlvbjxUTnVtYmVyPj4oXHJcbiAgYnVmOiBCdWZmZXIsXHJcbiAgbmV0d29yazogTmV0d29yayxcclxuICB7XHJcbiAgICBpbnB1dHMsXHJcbiAgICBhbW91bnRUeXBlID0gJ251bWJlcicsXHJcbiAgICB2ZXJzaW9uLFxyXG4gICAgcm91bmRUcmlwUHNidCA9IHRydWUsXHJcbiAgfToge1xyXG4gICAgaW5wdXRzPzogKFR4T3V0UG9pbnQgJiBUeE91dHB1dDxUTnVtYmVyPilbXTtcclxuICAgIGFtb3VudFR5cGU/OiAnbnVtYmVyJyB8ICdiaWdpbnQnO1xyXG4gICAgdmVyc2lvbj86IG51bWJlcjtcclxuICAgIHJvdW5kVHJpcFBzYnQ/OiBib29sZWFuO1xyXG4gIH0gPSB7fVxyXG4pOiBUIHtcclxuICBjb25zdCB0eCA9IGNyZWF0ZVRyYW5zYWN0aW9uRnJvbUJ1ZmZlcjxUTnVtYmVyPihidWYsIG5ldHdvcmssIHsgdmVyc2lvbiwgYW1vdW50VHlwZSB9KTtcclxuICBhc3NlcnQuc3RyaWN0RXF1YWwodHguYnl0ZUxlbmd0aCgpLCBidWYubGVuZ3RoKTtcclxuICBhc3NlcnQuc3RyaWN0RXF1YWwodHgudG9CdWZmZXIoKS50b1N0cmluZygnaGV4JyksIGJ1Zi50b1N0cmluZygnaGV4JykpO1xyXG5cclxuICAvLyBUZXN0IGBUcmFuc2FjdGlvbi5jbG9uZSgpYCBpbXBsZW1lbnRhdGlvblxyXG4gIGFzc2VydC5zdHJpY3RFcXVhbCh0eC5jbG9uZSgpLnRvQnVmZmVyKCkudG9TdHJpbmcoJ2hleCcpLCBidWYudG9TdHJpbmcoJ2hleCcpKTtcclxuXHJcbiAgaWYgKGlucHV0cykge1xyXG4gICAgY29uc3QgYmlnaW50VHggPSB0eC5jbG9uZTxiaWdpbnQ+KCdiaWdpbnQnKTtcclxuICAgIGNvbnN0IGJpZ2ludElucHV0cyA9IGlucHV0cy5tYXAoKGlucHV0KSA9PiAoeyAuLi5pbnB1dCwgdmFsdWU6IEJpZ0ludChpbnB1dC52YWx1ZSkgfSkpO1xyXG4gICAgaWYgKHJvdW5kVHJpcFBzYnQpIHtcclxuICAgICAgLy8gVGVzdCBVdHhvUHNidC5mcm9tVHJhbnNhY3Rpb24oKSBpbXBsZW1lbnRhdGlvblxyXG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoXHJcbiAgICAgICAgVXR4b1BzYnQuZnJvbVRyYW5zYWN0aW9uKGJpZ2ludFR4LCBiaWdpbnRJbnB1dHMpXHJcbiAgICAgICAgICAuZmluYWxpemVBbGxJbnB1dHMoKVxyXG4gICAgICAgICAgLmV4dHJhY3RUcmFuc2FjdGlvbigpXHJcbiAgICAgICAgICAudG9CdWZmZXIoKVxyXG4gICAgICAgICAgLnRvU3RyaW5nKCdoZXgnKSxcclxuICAgICAgICBidWYudG9TdHJpbmcoJ2hleCcpXHJcbiAgICAgICk7XHJcblxyXG4gICAgICAvLyBUZXN0IFV0eG9Qc2J0LnRvQnVmZmVyKCkgYW5kIFV0eG9Qc2J0LmZyb21CdWZmZXIoKSBpbXBsZW1lbnRhdGlvblxyXG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoXHJcbiAgICAgICAgY3JlYXRlUHNidEZyb21CdWZmZXIoY3JlYXRlUHNidEZyb21UcmFuc2FjdGlvbihiaWdpbnRUeCwgYmlnaW50SW5wdXRzKS50b0J1ZmZlcigpLCBuZXR3b3JrKVxyXG4gICAgICAgICAgLmZpbmFsaXplQWxsSW5wdXRzKClcclxuICAgICAgICAgIC5leHRyYWN0VHJhbnNhY3Rpb24oKVxyXG4gICAgICAgICAgLnRvQnVmZmVyKClcclxuICAgICAgICAgIC50b1N0cmluZygnaGV4JyksXHJcbiAgICAgICAgYnVmLnRvU3RyaW5nKCdoZXgnKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgLy8gVGVzdCBgVHJhbnNhY3Rpb25CdWlsZGVyLmZyb21UcmFuc2FjdGlvbigpYCBpbXBsZW1lbnRhdGlvblxyXG4gICAgYXNzZXJ0LnN0cmljdEVxdWFsKFxyXG4gICAgICBjcmVhdGVUcmFuc2FjdGlvbkJ1aWxkZXJGcm9tVHJhbnNhY3Rpb248VE51bWJlcj4odHgsIGlucHV0cykuYnVpbGQoKS50b0J1ZmZlcigpLnRvU3RyaW5nKCdoZXgnKSxcclxuICAgICAgYnVmLnRvU3RyaW5nKCdoZXgnKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHJldHVybiB0eCBhcyBUO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgZGVmYXVsdFRlc3RPdXRwdXRBbW91bnQgPSAxZTg7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbW9ja1RyYW5zYWN0aW9uSWQodiA9IDB4ZmYpOiBzdHJpbmcge1xyXG4gIHJldHVybiBCdWZmZXIuYWxsb2MoMzIpLmZpbGwodikudG9TdHJpbmcoJ2hleCcpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJldk91dHB1dDxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50ID0gbnVtYmVyPihcclxuICBzY3JpcHRUeXBlOiBTY3JpcHRUeXBlMk9mMyB8ICdwMnNoUDJwaycsXHJcbiAgdmFsdWU6IFROdW1iZXIsXHJcbiAgbmV0d29yazogTmV0d29yayxcclxuICB2b3V0ID0gMCxcclxuICB7XHJcbiAgICBrZXlzID0gZml4dHVyZUtleXMsXHJcbiAgICBwcmV2VHgsXHJcbiAgfToge1xyXG4gICAga2V5cz86IEtleVRyaXBsZTtcclxuICAgIHByZXZUeD86IFV0eG9UcmFuc2FjdGlvbjxUTnVtYmVyPiB8IGJvb2xlYW47XHJcbiAgfSA9IHt9XHJcbik6IFByZXZPdXRwdXQ8VE51bWJlcj4ge1xyXG4gIGNvbnN0IHNjcmlwdCA9IGlzU2NyaXB0VHlwZTJPZjMoc2NyaXB0VHlwZSlcclxuICAgID8gY3JlYXRlT3V0cHV0U2NyaXB0Mm9mMyhcclxuICAgICAgICBrZXlzLm1hcCgoaykgPT4gay5wdWJsaWNLZXkpLFxyXG4gICAgICAgIHNjcmlwdFR5cGVcclxuICAgICAgKS5zY3JpcHRQdWJLZXlcclxuICAgIDogY3JlYXRlT3V0cHV0U2NyaXB0UDJzaFAycGsoa2V5c1swXS5wdWJsaWNLZXkpLnNjcmlwdFB1YktleTtcclxuXHJcbiAgaWYgKHByZXZUeCA9PT0gdHJ1ZSkge1xyXG4gICAgY29uc3QgdHhiID0gY3JlYXRlVHJhbnNhY3Rpb25CdWlsZGVyRm9yTmV0d29yazxUTnVtYmVyPihuZXR3b3JrKTtcclxuICAgIHR4Yi5hZGRJbnB1dChCdWZmZXIuYWxsb2MoMzIpLmZpbGwoMSksIDApO1xyXG4gICAgdHhiLmFkZE91dHB1dChzY3JpcHQsIHZhbHVlKTtcclxuICAgIHByZXZUeCA9IHR4Yi5idWlsZEluY29tcGxldGUoKTtcclxuICB9XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICB0eGlkOiBwcmV2VHggPyBwcmV2VHguZ2V0SWQoKSA6IG1vY2tUcmFuc2FjdGlvbklkKCksXHJcbiAgICB2b3V0LFxyXG4gICAgc2NyaXB0LFxyXG4gICAgdmFsdWUsXHJcbiAgICBwcmV2VHg6IHByZXZUeCA/IHByZXZUeC50b0J1ZmZlcigpIDogdW5kZWZpbmVkLFxyXG4gIH07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRQcmV2T3V0cHV0czxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50ID0gbnVtYmVyPihcclxuICBzY3JpcHRUeXBlOiBTY3JpcHRUeXBlMk9mMyB8ICdwMnNoUDJwaycsXHJcbiAgdmFsdWU6IFROdW1iZXIsXHJcbiAgbmV0d29yazogTmV0d29yayxcclxuICB7IGtleXMgPSBmaXh0dXJlS2V5cywgcHJldlR4IH06IHsga2V5cz86IEtleVRyaXBsZTsgcHJldlR4PzogYm9vbGVhbiB9ID0ge31cclxuKTogUHJldk91dHB1dDxUTnVtYmVyPltdIHtcclxuICByZXR1cm4gW2dldFByZXZPdXRwdXQ8VE51bWJlcj4oc2NyaXB0VHlwZSwgdmFsdWUsIG5ldHdvcmssIDAsIHsga2V5cywgcHJldlR4IH0pXTtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgSGFsZlNpZ25lciA9IHtcclxuICBzaWduZXI6IEJJUDMySW50ZXJmYWNlO1xyXG4gIGNvc2lnbmVyPzogQklQMzJJbnRlcmZhY2U7XHJcbn07XHJcblxyXG50eXBlIFRyYW5zYWN0aW9uVXRpbEJ1aWxkT3B0aW9uczxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50PiA9IHtcclxuICBhbW91bnRUeXBlPzogJ251bWJlcicgfCAnYmlnaW50JztcclxuICBvdXRwdXRBbW91bnQ/OiBudW1iZXIgfCBiaWdpbnQgfCBzdHJpbmc7XHJcbiAgcHJldk91dHB1dHM/OiBQcmV2T3V0cHV0PFROdW1iZXI+W107XHJcbn07XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0VHJhbnNhY3Rpb25CdWlsZGVyPFROdW1iZXIgZXh0ZW5kcyBudW1iZXIgfCBiaWdpbnQgPSBudW1iZXI+KFxyXG4gIGtleXM6IEtleVRyaXBsZSxcclxuICBoYWxmU2lnbmVyczogSGFsZlNpZ25lcltdLFxyXG4gIHNjcmlwdFR5cGU6IFNjcmlwdFR5cGUyT2YzIHwgJ3Ayc2hQMnBrJyxcclxuICBuZXR3b3JrOiBOZXR3b3JrLFxyXG4gIHtcclxuICAgIGFtb3VudFR5cGUgPSAnbnVtYmVyJyxcclxuICAgIG91dHB1dEFtb3VudCA9IGRlZmF1bHRUZXN0T3V0cHV0QW1vdW50LFxyXG4gICAgcHJldk91dHB1dHMgPSBnZXRQcmV2T3V0cHV0czxUTnVtYmVyPihzY3JpcHRUeXBlLCB0b1ROdW1iZXI8VE51bWJlcj4ob3V0cHV0QW1vdW50LCBhbW91bnRUeXBlKSwgbmV0d29yayksXHJcbiAgfTogVHJhbnNhY3Rpb25VdGlsQnVpbGRPcHRpb25zPFROdW1iZXI+ID0ge31cclxuKTogVXR4b1RyYW5zYWN0aW9uQnVpbGRlcjxUTnVtYmVyPiB7XHJcbiAgY29uc3QgdHhCdWlsZGVyID0gY3JlYXRlVHJhbnNhY3Rpb25CdWlsZGVyRm9yTmV0d29yazxUTnVtYmVyPihuZXR3b3JrKTtcclxuXHJcbiAgcHJldk91dHB1dHMuZm9yRWFjaCgoeyB0eGlkLCB2b3V0IH0pID0+IHtcclxuICAgIHR4QnVpbGRlci5hZGRJbnB1dCh0eGlkLCB2b3V0KTtcclxuICB9KTtcclxuXHJcbiAgY29uc3QgcmVjaXBpZW50U2NyaXB0ID0gY3JlYXRlU2NyaXB0UHViS2V5KGZpeHR1cmVLZXlzLCAncDJwa2gnLCBuZXR3b3Jrcy5iaXRjb2luKTtcclxuICB0eEJ1aWxkZXIuYWRkT3V0cHV0KHJlY2lwaWVudFNjcmlwdCwgdG9UTnVtYmVyPFROdW1iZXI+KEJpZ0ludChvdXRwdXRBbW91bnQpIC0gQmlnSW50KDEwMDApLCBhbW91bnRUeXBlKSk7XHJcblxyXG4gIGNvbnN0IHB1YmtleXMgPSBrZXlzLm1hcCgoaykgPT4gay5wdWJsaWNLZXkpO1xyXG4gIGFzc2VydChpc1RyaXBsZShwdWJrZXlzKSk7XHJcblxyXG4gIHByZXZPdXRwdXRzLmZvckVhY2goKHsgdmFsdWUgfSwgdmluKSA9PiB7XHJcbiAgICBoYWxmU2lnbmVycy5mb3JFYWNoKCh7IHNpZ25lciwgY29zaWduZXIgfSkgPT4ge1xyXG4gICAgICBpZiAoc2NyaXB0VHlwZSA9PT0gJ3Ayc2hQMnBrJykge1xyXG4gICAgICAgIHNpZ25JbnB1dFAyc2hQMnBrKHR4QnVpbGRlciwgdmluLCBzaWduZXIpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmICghY29zaWduZXIpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgbXVzdCBzZXQgY29zaWduZXJgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc2lnbklucHV0Mk9mMyh0eEJ1aWxkZXIsIHZpbiwgc2NyaXB0VHlwZSBhcyBTY3JpcHRUeXBlMk9mMywgcHVia2V5cywgc2lnbmVyLCBjb3NpZ25lci5wdWJsaWNLZXksIHZhbHVlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIHJldHVybiB0eEJ1aWxkZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRVbnNpZ25lZFRyYW5zYWN0aW9uMk9mMzxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50ID0gbnVtYmVyPihcclxuICBrZXlzOiBLZXlUcmlwbGUsXHJcbiAgc2NyaXB0VHlwZTogU2NyaXB0VHlwZTJPZjMgfCAncDJzaFAycGsnLFxyXG4gIG5ldHdvcms6IE5ldHdvcmssXHJcbiAgcGFyYW1zOiBUcmFuc2FjdGlvblV0aWxCdWlsZE9wdGlvbnM8VE51bWJlcj4gPSB7fVxyXG4pOiBVdHhvVHJhbnNhY3Rpb248VE51bWJlcj4ge1xyXG4gIHJldHVybiBnZXRUcmFuc2FjdGlvbkJ1aWxkZXI8VE51bWJlcj4oa2V5cywgW10sIHNjcmlwdFR5cGUsIG5ldHdvcmssIHBhcmFtcykuYnVpbGRJbmNvbXBsZXRlKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRIYWxmU2lnbmVkVHJhbnNhY3Rpb24yT2YzPFROdW1iZXIgZXh0ZW5kcyBudW1iZXIgfCBiaWdpbnQgPSBudW1iZXI+KFxyXG4gIGtleXM6IEtleVRyaXBsZSxcclxuICBzaWduZXIxOiBCSVAzMkludGVyZmFjZSxcclxuICBzaWduZXIyOiBCSVAzMkludGVyZmFjZSxcclxuICBzY3JpcHRUeXBlOiBTY3JpcHRUeXBlMk9mMyB8ICdwMnNoUDJwaycsXHJcbiAgbmV0d29yazogTmV0d29yayxcclxuICBvcHRzOiBUcmFuc2FjdGlvblV0aWxCdWlsZE9wdGlvbnM8VE51bWJlcj4gPSB7fVxyXG4pOiBVdHhvVHJhbnNhY3Rpb248VE51bWJlcj4ge1xyXG4gIHJldHVybiBnZXRUcmFuc2FjdGlvbkJ1aWxkZXI8VE51bWJlcj4oXHJcbiAgICBrZXlzLFxyXG4gICAgW3sgc2lnbmVyOiBzaWduZXIxLCBjb3NpZ25lcjogc2lnbmVyMiB9XSxcclxuICAgIHNjcmlwdFR5cGUsXHJcbiAgICBuZXR3b3JrLFxyXG4gICAgb3B0c1xyXG4gICkuYnVpbGRJbmNvbXBsZXRlKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRGdWxsU2lnbmVkVHJhbnNhY3Rpb25QMnNoUDJwazxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50ID0gbnVtYmVyPihcclxuICBrZXlzOiBLZXlUcmlwbGUsXHJcbiAgc2lnbmVyMTogQklQMzJJbnRlcmZhY2UsXHJcbiAgbmV0d29yazogTmV0d29yayxcclxuICBvcHRzOiBUcmFuc2FjdGlvblV0aWxCdWlsZE9wdGlvbnM8VE51bWJlcj4gPSB7fVxyXG4pOiBVdHhvVHJhbnNhY3Rpb248VE51bWJlcj4ge1xyXG4gIHJldHVybiBnZXRUcmFuc2FjdGlvbkJ1aWxkZXI8VE51bWJlcj4oa2V5cywgW3sgc2lnbmVyOiBzaWduZXIxIH1dLCAncDJzaFAycGsnLCBuZXR3b3JrLCBvcHRzKS5idWlsZCgpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RnVsbFNpZ25lZFRyYW5zYWN0aW9uMk9mMzxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50ID0gbnVtYmVyPihcclxuICBrZXlzOiBLZXlUcmlwbGUsXHJcbiAgc2lnbmVyMTogQklQMzJJbnRlcmZhY2UsXHJcbiAgc2lnbmVyMjogQklQMzJJbnRlcmZhY2UsXHJcbiAgc2NyaXB0VHlwZTogU2NyaXB0VHlwZTJPZjMgfCAncDJzaFAycGsnLFxyXG4gIG5ldHdvcms6IE5ldHdvcmssXHJcbiAgb3B0czogVHJhbnNhY3Rpb25VdGlsQnVpbGRPcHRpb25zPFROdW1iZXI+ID0ge31cclxuKTogVXR4b1RyYW5zYWN0aW9uPFROdW1iZXI+IHtcclxuICByZXR1cm4gZ2V0VHJhbnNhY3Rpb25CdWlsZGVyPFROdW1iZXI+KFxyXG4gICAga2V5cyxcclxuICAgIFtcclxuICAgICAgeyBzaWduZXI6IHNpZ25lcjEsIGNvc2lnbmVyOiBzaWduZXIyIH0sXHJcbiAgICAgIHsgc2lnbmVyOiBzaWduZXIyLCBjb3NpZ25lcjogc2lnbmVyMSB9LFxyXG4gICAgXSxcclxuICAgIHNjcmlwdFR5cGUsXHJcbiAgICBuZXR3b3JrLFxyXG4gICAgb3B0c1xyXG4gICkuYnVpbGQoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFRyYW5zYWN0aW9uU3RhZ2VzPFROdW1iZXIgZXh0ZW5kcyBudW1iZXIgfCBiaWdpbnQ+KFxyXG4gIGtleXM6IEtleVRyaXBsZSxcclxuICBzaWduZXIxOiBCSVAzMkludGVyZmFjZSxcclxuICBzaWduZXIyOiBCSVAzMkludGVyZmFjZSxcclxuICBzY3JpcHRUeXBlOiBTY3JpcHRUeXBlMk9mMyB8ICdwMnNoUDJwaycsXHJcbiAgbmV0d29yazogTmV0d29yayxcclxuICBvcHRzOiBUcmFuc2FjdGlvblV0aWxCdWlsZE9wdGlvbnM8VE51bWJlcj5cclxuKToge1xyXG4gIHVuc2lnbmVkOiBVdHhvVHJhbnNhY3Rpb248VE51bWJlcj47XHJcbiAgaGFsZlNpZ25lZDogVXR4b1RyYW5zYWN0aW9uPFROdW1iZXI+O1xyXG4gIGZ1bGxTaWduZWQ6IFV0eG9UcmFuc2FjdGlvbjxUTnVtYmVyPjtcclxufSB7XHJcbiAgY29uc3QgaGFsZlNpZ25lZCA9IGdldEhhbGZTaWduZWRUcmFuc2FjdGlvbjJPZjMoa2V5cywgc2lnbmVyMSwgc2lnbmVyMiwgc2NyaXB0VHlwZSwgbmV0d29yaywgb3B0cyk7XHJcbiAgY29uc3QgZnVsbFNpZ25lZCA9XHJcbiAgICBzY3JpcHRUeXBlID09PSAncDJzaFAycGsnXHJcbiAgICAgID8gaGFsZlNpZ25lZFxyXG4gICAgICA6IGdldEZ1bGxTaWduZWRUcmFuc2FjdGlvbjJPZjMoa2V5cywgc2lnbmVyMSwgc2lnbmVyMiwgc2NyaXB0VHlwZSwgbmV0d29yaywgb3B0cyk7XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICB1bnNpZ25lZDogZ2V0VW5zaWduZWRUcmFuc2FjdGlvbjJPZjMoa2V5cywgc2NyaXB0VHlwZSwgbmV0d29yaywgb3B0cyksXHJcbiAgICBoYWxmU2lnbmVkLFxyXG4gICAgZnVsbFNpZ25lZCxcclxuICB9O1xyXG59XHJcbiJdfQ==