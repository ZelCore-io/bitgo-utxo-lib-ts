"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert = require("assert");
const bitgo_1 = require("../../../src/bitgo");
const testutil_1 = require("../../../src/testutil");
const src_1 = require("../../../src");
const outputScripts_1 = require("../../../src/bitgo/outputScripts");
const rootWalletKeys = (0, testutil_1.getDefaultWalletKeys)();
const signs = ['unsigned', 'halfsigned', 'fullsigned'];
const neutratedRootWalletKeys = new bitgo_1.RootWalletKeys(rootWalletKeys.triple.map((bip32) => bip32.neutered()), rootWalletKeys.derivationPrefixes);
const psbtInputs = testutil_1.inputScriptTypes.map((scriptType) => ({ scriptType, value: BigInt(1000) }));
const psbtOutputs = testutil_1.outputScriptTypes.map((scriptType) => ({ scriptType, value: BigInt(900) }));
const txInputs = testutil_1.txnInputScriptTypes.map((scriptType) => ({ scriptType, value: BigInt(1000) }));
const txOutputs = testutil_1.txnOutputScriptTypes.map((scriptType) => ({ scriptType, value: BigInt(900) }));
function getSigValidArray(scriptType, sign) {
    if (scriptType === 'p2shP2pk' || sign === 'unsigned') {
        return [false, false, false];
    }
    if (sign === 'halfsigned') {
        return [true, false, false];
    }
    return scriptType === 'p2trMusig2' ? [true, true, false] : [true, false, true];
}
function signCount(sign) {
    return sign === 'unsigned' ? 0 : sign === 'halfsigned' ? 1 : 2;
}
function runPsbt(network, sign, inputs, outputs) {
    const coin = (0, src_1.getNetworkName)(network);
    const signatureCount = signCount(sign);
    describe(`psbt build, sign and verify for ${coin} ${sign}`, function () {
        it(`getSignatureValidationArray with globalXpub ${coin} ${sign}`, function () {
            const psbt = (0, testutil_1.constructPsbt)(inputs, outputs, network, rootWalletKeys, sign);
            (0, bitgo_1.addXpubsToPsbt)(psbt, neutratedRootWalletKeys);
            psbt.data.inputs.forEach((input, inputIndex) => {
                const isP2shP2pk = inputs[inputIndex].scriptType === 'p2shP2pk';
                const expectedSigValid = getSigValidArray(inputs[inputIndex].scriptType, sign);
                psbt.getSignatureValidationArray(inputIndex).forEach((sv, i) => {
                    if (isP2shP2pk && sign !== 'unsigned' && i === 0) {
                        assert.strictEqual(sv, true);
                    }
                    else {
                        assert.strictEqual(sv, expectedSigValid[i]);
                    }
                });
            });
        });
        it(`getSignatureValidationArray with rootNodes ${coin} ${sign}`, function () {
            const psbt = (0, testutil_1.constructPsbt)(inputs, outputs, network, rootWalletKeys, sign);
            (0, bitgo_1.addXpubsToPsbt)(psbt, neutratedRootWalletKeys);
            psbt.data.inputs.forEach((input, inputIndex) => {
                const isP2shP2pk = inputs[inputIndex].scriptType === 'p2shP2pk';
                const expectedSigValid = getSigValidArray(inputs[inputIndex].scriptType, sign);
                psbt.getSignatureValidationArray(inputIndex, { rootNodes: neutratedRootWalletKeys.triple }).forEach((sv, i) => {
                    if (isP2shP2pk && sign !== 'unsigned' && i === 0) {
                        assert.strictEqual(sv, true);
                    }
                    else {
                        assert.strictEqual(sv, expectedSigValid[i]);
                    }
                });
            });
        });
        it(`getSignatureValidationArrayPsbt  ${coin} ${sign}`, function () {
            const psbt = (0, testutil_1.constructPsbt)(inputs, outputs, network, rootWalletKeys, sign);
            const sigValidations = (0, bitgo_1.getSignatureValidationArrayPsbt)(psbt, neutratedRootWalletKeys);
            psbt.data.inputs.forEach((input, inputIndex) => {
                const expectedSigValid = getSigValidArray(inputs[inputIndex].scriptType, sign);
                const sigValid = sigValidations.find((sv) => sv[0] === inputIndex);
                assert.ok(sigValid);
                sigValid[1].forEach((sv, i) => assert.strictEqual(sv, expectedSigValid[i]));
            });
        });
        it(`psbt signature counts ${coin} ${sign}`, function () {
            const psbt = (0, testutil_1.constructPsbt)(inputs, outputs, network, rootWalletKeys, sign);
            const counts = (0, bitgo_1.getStrictSignatureCounts)(psbt);
            const countsFromInputs = (0, bitgo_1.getStrictSignatureCounts)(psbt.data.inputs);
            assert.strictEqual(counts.length, psbt.data.inputs.length);
            assert.strictEqual(countsFromInputs.length, psbt.data.inputs.length);
            psbt.data.inputs.forEach((input, inputIndex) => {
                const expectedCount = inputs[inputIndex].scriptType === 'p2shP2pk' && signatureCount > 0 ? 1 : signatureCount;
                assert.strictEqual((0, bitgo_1.getPsbtInputSignatureCount)(input), expectedCount);
                assert.strictEqual((0, bitgo_1.getStrictSignatureCount)(input), expectedCount);
                assert.strictEqual(counts[inputIndex], expectedCount);
                assert.strictEqual(countsFromInputs[inputIndex], expectedCount);
            });
            if (sign === 'fullsigned') {
                const tx = psbt.finalizeAllInputs().extractTransaction();
                const counts = (0, bitgo_1.getStrictSignatureCounts)(tx);
                const countsFromIns = (0, bitgo_1.getStrictSignatureCounts)(tx.ins);
                tx.ins.forEach((input, inputIndex) => {
                    const expectedCount = inputs[inputIndex].scriptType === 'p2shP2pk' ? 1 : signatureCount;
                    assert.strictEqual((0, bitgo_1.getStrictSignatureCount)(input), expectedCount);
                    assert.strictEqual(counts[inputIndex], expectedCount);
                    assert.strictEqual(countsFromIns[inputIndex], expectedCount);
                });
            }
        });
    });
}
function runTx(network, sign, inputs, outputs) {
    const coin = (0, src_1.getNetworkName)(network);
    const signatureCount = signCount(sign);
    describe(`tx build, sign and verify for ${coin} ${sign}`, function () {
        it(`tx signature counts ${coin} ${sign}`, function () {
            const txb = (0, testutil_1.constructTxnBuilder)(inputs, outputs, network, rootWalletKeys, sign);
            const tx = sign === 'fullsigned' ? txb.build() : txb.buildIncomplete();
            const counts = (0, bitgo_1.getStrictSignatureCounts)(tx);
            const countsFromIns = (0, bitgo_1.getStrictSignatureCounts)(tx.ins);
            assert.strictEqual(counts.length, tx.ins.length);
            assert.strictEqual(countsFromIns.length, tx.ins.length);
            tx.ins.forEach((input, inputIndex) => {
                const expectedCount = inputs[inputIndex].scriptType === 'p2shP2pk' && signatureCount > 0 ? 1 : signatureCount;
                assert.strictEqual((0, bitgo_1.getStrictSignatureCount)(input), expectedCount);
                assert.strictEqual(counts[inputIndex], expectedCount);
                assert.strictEqual(countsFromIns[inputIndex], expectedCount);
            });
        });
    });
}
signs.forEach((sign) => {
    (0, src_1.getNetworkList)()
        .filter((v) => (0, src_1.isMainnet)(v) && v !== src_1.networks.bitcoinsv)
        .forEach((network) => {
        const supportedPsbtInputs = psbtInputs.filter((input) => (0, outputScripts_1.isSupportedScriptType)(network, input.scriptType === 'taprootKeyPathSpend' ? 'p2trMusig2' : input.scriptType));
        const supportedPsbtOutputs = psbtOutputs.filter((output) => (0, outputScripts_1.isSupportedScriptType)(network, output.scriptType));
        runPsbt(network, sign, supportedPsbtInputs, supportedPsbtOutputs);
        const supportedTxInputs = txInputs.filter((input) => (0, outputScripts_1.isSupportedScriptType)(network, input.scriptType));
        const supportedTxOutputs = txOutputs.filter((output) => (0, outputScripts_1.isSupportedScriptType)(network, output.scriptType));
        runTx(network, sign, supportedTxInputs, supportedTxOutputs);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2lnblZlcmlmeVBzYnRBbmRUeC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Rlc3QvYml0Z28vcHNidC9TaWduVmVyaWZ5UHNidEFuZFR4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUNBQWlDO0FBRWpDLDhDQVM0QjtBQUU1QixvREFhK0I7QUFDL0Isc0NBQTRGO0FBQzVGLG9FQUF5RTtBQUd6RSxNQUFNLGNBQWMsR0FBRyxJQUFBLCtCQUFvQixHQUFFLENBQUM7QUFDOUMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxVQUFVLEVBQUUsWUFBWSxFQUFFLFlBQVksQ0FBVSxDQUFDO0FBRWhFLE1BQU0sdUJBQXVCLEdBQUcsSUFBSSxzQkFBYyxDQUNoRCxjQUFjLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUEyQixFQUNoRixjQUFjLENBQUMsa0JBQWtCLENBQ2xDLENBQUM7QUFFRixNQUFNLFVBQVUsR0FBRywyQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUMvRixNQUFNLFdBQVcsR0FBRyw0QkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUVoRyxNQUFNLFFBQVEsR0FBRyw4QkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNoRyxNQUFNLFNB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cUIsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQzdHLENBQUM7UUFDRixNQUFNLG9CQUFvQixHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLElBQUEscUNBQXFCLEVBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQy9HLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLG1CQUFtQixFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFFbEUsTUFBTSxpQkFBaUIsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFBLHFDQUFxQixFQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUN2RyxNQUFNLGtCQUFrQixHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLElBQUEscUNBQXFCLEVBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQzNHLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLGlCQUFpQixFQUFFLGtCQUFrQixDQUFDLENBQUM7SUFDOUQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFzc2VydCBmcm9tICdhc3NlcnQnO1xyXG5cclxuaW1wb3J0IHtcclxuICBhZGRYcHVic1RvUHNidCxcclxuICBnZXRQc2J0SW5wdXRTaWduYXR1cmVDb3VudCxcclxuICBnZXRTaWduYXR1cmVWYWxpZGF0aW9uQXJyYXlQc2J0LFxyXG4gIGdldFN0cmljdFNpZ25hdHVyZUNvdW50LFxyXG4gIGdldFN0cmljdFNpZ25hdHVyZUNvdW50cyxcclxuICBSb290V2FsbGV0S2V5cyxcclxuICBUcmlwbGUsXHJcbiAgVXR4b1RyYW5zYWN0aW9uLFxyXG59IGZyb20gJy4uLy4uLy4uL3NyYy9iaXRnbyc7XHJcbmltcG9ydCB7IEJJUDMySW50ZXJmYWNlIH0gZnJvbSAnYmlwMzInO1xyXG5pbXBvcnQge1xyXG4gIGNvbnN0cnVjdFBzYnQsXHJcbiAgY29uc3RydWN0VHhuQnVpbGRlcixcclxuICBnZXREZWZhdWx0V2FsbGV0S2V5cyxcclxuICBJbnB1dCxcclxuICBJbnB1dFNjcmlwdFR5cGUsXHJcbiAgaW5wdXRTY3JpcHRUeXBlcyxcclxuICBPdXRwdXQsXHJcbiAgb3V0cHV0U2NyaXB0VHlwZXMsXHJcbiAgVHhuSW5wdXQsXHJcbiAgdHhuSW5wdXRTY3JpcHRUeXBlcyxcclxuICBUeG5PdXRwdXQsXHJcbiAgdHhuT3V0cHV0U2NyaXB0VHlwZXMsXHJcbn0gZnJvbSAnLi4vLi4vLi4vc3JjL3Rlc3R1dGlsJztcclxuaW1wb3J0IHsgZ2V0TmV0d29ya0xpc3QsIGdldE5ldHdvcmtOYW1lLCBpc01haW5uZXQsIE5ldHdvcmssIG5ldHdvcmtzIH0gZnJvbSAnLi4vLi4vLi4vc3JjJztcclxuaW1wb3J0IHsgaXNTdXBwb3J0ZWRTY3JpcHRUeXBlIH0gZnJvbSAnLi4vLi4vLi4vc3JjL2JpdGdvL291dHB1dFNjcmlwdHMnO1xyXG5pbXBvcnQgeyBTaWduYXR1cmVUYXJnZXRUeXBlIH0gZnJvbSAnLi9Qc2J0JztcclxuXHJcbmNvbnN0IHJvb3RXYWxsZXRLZXlzID0gZ2V0RGVmYXVsdFdhbGxldEtleXMoKTtcclxuY29uc3Qgc2lnbnMgPSBbJ3Vuc2lnbmVkJywgJ2hhbGZzaWduZWQnLCAnZnVsbHNpZ25lZCddIGFzIGNvbnN0O1xyXG5cclxuY29uc3QgbmV1dHJhdGVkUm9vdFdhbGxldEtleXMgPSBuZXcgUm9vdFdhbGxldEtleXMoXHJcbiAgcm9vdFdhbGxldEtleXMudHJpcGxlLm1hcCgoYmlwMzIpID0+IGJpcDMyLm5ldXRlcmVkKCkpIGFzIFRyaXBsZTxCSVAzMkludGVyZmFjZT4sXHJcbiAgcm9vdFdhbGxldEtleXMuZGVyaXZhdGlvblByZWZpeGVzXHJcbik7XHJcblxyXG5jb25zdCBwc2J0SW5wdXRzID0gaW5wdXRTY3JpcHRUeXBlcy5tYXAoKHNjcmlwdFR5cGUpID0+ICh7IHNjcmlwdFR5cGUsIHZhbHVlOiBCaWdJbnQoMTAwMCkgfSkpO1xyXG5jb25zdCBwc2J0T3V0cHV0cyA9IG91dHB1dFNjcmlwdFR5cGVzLm1hcCgoc2NyaXB0VHlwZSkgPT4gKHsgc2NyaXB0VHlwZSwgdmFsdWU6IEJpZ0ludCg5MDApIH0pKTtcclxuXHJcbmNvbnN0IHR4SW5wdXRzID0gdHhuSW5wdXRTY3JpcHRUeXBlcy5tYXAoKHNjcmlwdFR5cGUpID0+ICh7IHNjcmlwdFR5cGUsIHZhbHVlOiBCaWdJbnQoMTAwMCkgfSkpO1xyXG5jb25zdCB0eE91dHB1dHMgPSB0eG5PdXRwdXRTY3JpcHRUeXBlcy5tYXAoKHNjcmlwdFR5cGUpID0+ICh7IHNjcmlwdFR5cGUsIHZhbHVlOiBCaWdJbnQoOTAwKSB9KSk7XHJcblxyXG5mdW5jdGlvbiBnZXRTaWdWYWxpZEFycmF5KHNjcmlwdFR5cGU6IElucHV0U2NyaXB0VHlwZSwgc2lnbjogU2lnbmF0dXJlVGFyZ2V0VHlwZSk6IFRyaXBsZTxib29sZWFuPiB7XHJcbiAgaWYgKHNjcmlwdFR5cGUgPT09ICdwMnNoUDJwaycgfHwgc2lnbiA9PT0gJ3Vuc2lnbmVkJykge1xyXG4gICAgcmV0dXJuIFtmYWxzZSwgZmFsc2UsIGZhbHNlXTtcclxuICB9XHJcbiAgaWYgKHNpZ24gPT09ICdoYWxmc2lnbmVkJykge1xyXG4gICAgcmV0dXJuIFt0cnVlLCBmYWxzZSwgZmFsc2VdO1xyXG4gIH1cclxuICByZXR1cm4gc2NyaXB0VHlwZSA9PT0gJ3AydHJNdXNpZzInID8gW3RydWUsIHRydWUsIGZhbHNlXSA6IFt0cnVlLCBmYWxzZSwgdHJ1ZV07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNpZ25Db3VudChzaWduOiBTaWduYXR1cmVUYXJnZXRUeXBlKSB7XHJcbiAgcmV0dXJuIHNpZ24gPT09ICd1bnNpZ25lZCcgPyAwIDogc2lnbiA9PT0gJ2hhbGZzaWduZWQnID8gMSA6IDI7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJ1blBzYnQobmV0d29yazogTmV0d29yaywgc2lnbjogU2lnbmF0dXJlVGFyZ2V0VHlwZSwgaW5wdXRzOiBJbnB1dFtdLCBvdXRwdXRzOiBPdXRwdXRbXSkge1xyXG4gIGNvbnN0IGNvaW4gPSBnZXROZXR3b3JrTmFtZShuZXR3b3JrKTtcclxuICBjb25zdCBzaWduYXR1cmVDb3VudCA9IHNpZ25Db3VudChzaWduKTtcclxuXHJcbiAgZGVzY3JpYmUoYHBzYnQgYnVpbGQsIHNpZ24gYW5kIHZlcmlmeSBmb3IgJHtjb2lufSAke3NpZ259YCwgZnVuY3Rpb24gKCkge1xyXG4gICAgaXQoYGdldFNpZ25hdHVyZVZhbGlkYXRpb25BcnJheSB3aXRoIGdsb2JhbFhwdWIgJHtjb2lufSAke3NpZ259YCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICBjb25zdCBwc2J0ID0gY29uc3RydWN0UHNidChpbnB1dHMsIG91dHB1dHMsIG5ldHdvcmssIHJvb3RXYWxsZXRLZXlzLCBzaWduKTtcclxuICAgICAgYWRkWHB1YnNUb1BzYnQocHNidCwgbmV1dHJhdGVkUm9vdFdhbGxldEtleXMpO1xyXG4gICAgICBwc2J0LmRhdGEuaW5wdXRzLmZvckVhY2goKGlucHV0LCBpbnB1dEluZGV4KSA9PiB7XHJcbiAgICAgICAgY29uc3QgaXNQMnNoUDJwayA9IGlucHV0c1tpbnB1dEluZGV4XS5zY3JpcHRUeXBlID09PSAncDJzaFAycGsnO1xyXG4gICAgICAgIGNvbnN0IGV4cGVjdGVkU2lnVmFsaWQgPSBnZXRTaWdWYWxpZEFycmF5KGlucHV0c1tpbnB1dEluZGV4XS5zY3JpcHRUeXBlLCBzaWduKTtcclxuICAgICAgICBwc2J0LmdldFNpZ25hdHVyZVZhbGlkYXRpb25BcnJheShpbnB1dEluZGV4KS5mb3JFYWNoKChzdiwgaSkgPT4ge1xyXG4gICAgICAgICAgaWYgKGlzUDJzaFAycGsgJiYgc2lnbiAhPT0gJ3Vuc2lnbmVkJyAmJiBpID09PSAwKSB7XHJcbiAgICAgICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChzdiwgdHJ1ZSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoc3YsIGV4cGVjdGVkU2lnVmFsaWRbaV0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KGBnZXRTaWduYXR1cmVWYWxpZGF0aW9uQXJyYXkgd2l0aCByb290Tm9kZXMgJHtjb2lufSAke3NpZ259YCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICBjb25zdCBwc2J0ID0gY29uc3RydWN0UHNidChpbnB1dHMsIG91dHB1dHMsIG5ldHdvcmssIHJvb3RXYWxsZXRLZXlzLCBzaWduKTtcclxuICAgICAgYWRkWHB1YnNUb1BzYnQocHNidCwgbmV1dHJhdGVkUm9vdFdhbGxldEtleXMpO1xyXG4gICAgICBwc2J0LmRhdGEuaW5wdXRzLmZvckVhY2goKGlucHV0LCBpbnB1dEluZGV4KSA9PiB7XHJcbiAgICAgICAgY29uc3QgaXNQMnNoUDJwayA9IGlucHV0c1tpbnB1dEluZGV4XS5zY3JpcHRUeXBlID09PSAncDJzaFAycGsnO1xyXG4gICAgICAgIGNvbnN0IGV4cGVjdGVkU2lnVmFsaWQgPSBnZXRTaWdWYWxpZEFycmF5KGlucHV0c1tpbnB1dEluZGV4XS5zY3JpcHRUeXBlLCBzaWduKTtcclxuICAgICAgICBwc2J0LmdldFNpZ25hdHVyZVZhbGlkYXRpb25BcnJheShpbnB1dEluZGV4LCB7IHJvb3ROb2RlczogbmV1dHJhdGVkUm9vdFdhbGxldEtleXMudHJpcGxlIH0pLmZvckVhY2goKHN2LCBpKSA9PiB7XHJcbiAgICAgICAgICBpZiAoaXNQMnNoUDJwayAmJiBzaWduICE9PSAndW5zaWduZWQnICYmIGkgPT09IDApIHtcclxuICAgICAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHN2LCB0cnVlKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChzdiwgZXhwZWN0ZWRTaWdWYWxpZFtpXSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoYGdldFNpZ25hdHVyZVZhbGlkYXRpb25BcnJheVBzYnQgICR7Y29pbn0gJHtzaWdufWAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgY29uc3QgcHNidCA9IGNvbnN0cnVjdFBzYnQoaW5wdXRzLCBvdXRwdXRzLCBuZXR3b3JrLCByb290V2FsbGV0S2V5cywgc2lnbik7XHJcbiAgICAgIGNvbnN0IHNpZ1ZhbGlkYXRpb25zID0gZ2V0U2lnbmF0dXJlVmFsaWRhdGlvbkFycmF5UHNidChwc2J0LCBuZXV0cmF0ZWRSb290V2FsbGV0S2V5cyk7XHJcbiAgICAgIHBzYnQuZGF0YS5pbnB1dHMuZm9yRWFjaCgoaW5wdXQsIGlucHV0SW5kZXgpID0+IHtcclxuICAgICAgICBjb25zdCBleHBlY3RlZFNpZ1ZhbGlkID0gZ2V0U2lnVmFsaWRBcnJheShpbnB1dHNbaW5wdXRJbmRleF0uc2NyaXB0VHlwZSwgc2lnbik7XHJcbiAgICAgICAgY29uc3Qgc2lnVmFsaWQgPSBzaWdWYWxpZGF0aW9ucy5maW5kKChzdikgPT4gc3ZbMF0gPT09IGlucHV0SW5kZXgpO1xyXG4gICAgICAgIGFzc2VydC5vayhzaWdWYWxpZCk7XHJcbiAgICAgICAgc2lnVmFsaWRbMV0uZm9yRWFjaCgoc3YsIGkpID0+IGFzc2VydC5zdHJpY3RFcXVhbChzdiwgZXhwZWN0ZWRTaWdWYWxpZFtpXSkpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KGBwc2J0IHNpZ25hdHVyZSBjb3VudHMgJHtjb2lufSAke3NpZ259YCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICBjb25zdCBwc2J0ID0gY29uc3RydWN0UHNidChpbnB1dHMsIG91dHB1dHMsIG5ldHdvcmssIHJvb3RXYWxsZXRLZXlzLCBzaWduKTtcclxuICAgICAgY29uc3QgY291bnRzID0gZ2V0U3RyaWN0U2lnbmF0dXJlQ291bnRzKHBzYnQpO1xyXG4gICAgICBjb25zdCBjb3VudHNGcm9tSW5wdXRzID0gZ2V0U3RyaWN0U2lnbmF0dXJlQ291bnRzKHBzYnQuZGF0YS5pbnB1dHMpO1xyXG5cclxuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGNvdW50cy5sZW5ndGgsIHBzYnQuZGF0YS5pbnB1dHMubGVuZ3RoKTtcclxuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGNvdW50c0Zyb21JbnB1dHMubGVuZ3RoLCBwc2J0LmRhdGEuaW5wdXRzLmxlbmd0aCk7XHJcbiAgICAgIHBzYnQuZGF0YS5pbnB1dHMuZm9yRWFjaCgoaW5wdXQsIGlucHV0SW5kZXgpID0+IHtcclxuICAgICAgICBjb25zdCBleHBlY3RlZENvdW50ID0gaW5wdXRzW2lucHV0SW5kZXhdLnNjcmlwdFR5cGUgPT09ICdwMnNoUDJwaycgJiYgc2lnbmF0dXJlQ291bnQgPiAwID8gMSA6IHNpZ25hdHVyZUNvdW50O1xyXG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChnZXRQc2J0SW5wdXRTaWduYXR1cmVDb3VudChpbnB1dCksIGV4cGVjdGVkQ291bnQpO1xyXG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChnZXRTdHJpY3RTaWduYXR1cmVDb3VudChpbnB1dCksIGV4cGVjdGVkQ291bnQpO1xyXG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChjb3VudHNbaW5wdXRJbmRleF0sIGV4cGVjdGVkQ291bnQpO1xyXG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChjb3VudHNGcm9tSW5wdXRzW2lucHV0SW5kZXhdLCBleHBlY3RlZENvdW50KTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAoc2lnbiA9PT0gJ2Z1bGxzaWduZWQnKSB7XHJcbiAgICAgICAgY29uc3QgdHggPSBwc2J0LmZpbmFsaXplQWxsSW5wdXRzKCkuZXh0cmFjdFRyYW5zYWN0aW9uKCkgYXMgVXR4b1RyYW5zYWN0aW9uPGJpZ2ludD47XHJcbiAgICAgICAgY29uc3QgY291bnRzID0gZ2V0U3RyaWN0U2lnbmF0dXJlQ291bnRzKHR4KTtcclxuICAgICAgICBjb25zdCBjb3VudHNGcm9tSW5zID0gZ2V0U3RyaWN0U2lnbmF0dXJlQ291bnRzKHR4Lmlucyk7XHJcblxyXG4gICAgICAgIHR4Lmlucy5mb3JFYWNoKChpbnB1dCwgaW5wdXRJbmRleCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZXhwZWN0ZWRDb3VudCA9IGlucHV0c1tpbnB1dEluZGV4XS5zY3JpcHRUeXBlID09PSAncDJzaFAycGsnID8gMSA6IHNpZ25hdHVyZUNvdW50O1xyXG4gICAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGdldFN0cmljdFNpZ25hdHVyZUNvdW50KGlucHV0KSwgZXhwZWN0ZWRDb3VudCk7XHJcbiAgICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoY291bnRzW2lucHV0SW5kZXhdLCBleHBlY3RlZENvdW50KTtcclxuICAgICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChjb3VudHNGcm9tSW5zW2lucHV0SW5kZXhdLCBleHBlY3RlZENvdW50KTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJ1blR4PFROdW1iZXIgZXh0ZW5kcyBudW1iZXIgfCBiaWdpbnQ+KFxyXG4gIG5ldHdvcms6IE5ldHdvcmssXHJcbiAgc2lnbjogU2lnbmF0dXJlVGFyZ2V0VHlwZSxcclxuICBpbnB1dHM6IFR4bklucHV0PFROdW1iZXI+W10sXHJcbiAgb3V0cHV0czogVHhuT3V0cHV0PFROdW1iZXI+W11cclxuKSB7XHJcbiAgY29uc3QgY29pbiA9IGdldE5ldHdvcmtOYW1lKG5ldHdvcmspO1xyXG4gIGNvbnN0IHNpZ25hdHVyZUNvdW50ID0gc2lnbkNvdW50KHNpZ24pO1xyXG4gIGRlc2NyaWJlKGB0eCBidWlsZCwgc2lnbiBhbmQgdmVyaWZ5IGZvciAke2NvaW59ICR7c2lnbn1gLCBmdW5jdGlvbiAoKSB7XHJcbiAgICBpdChgdHggc2lnbmF0dXJlIGNvdW50cyAke2NvaW59ICR7c2lnbn1gLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGNvbnN0IHR4YiA9IGNvbnN0cnVjdFR4bkJ1aWxkZXIoaW5wdXRzLCBvdXRwdXRzLCBuZXR3b3JrLCByb290V2FsbGV0S2V5cywgc2lnbik7XHJcbiAgICAgIGNvbnN0IHR4ID0gc2lnbiA9PT0gJ2Z1bGxzaWduZWQnID8gdHhiLmJ1aWxkKCkgOiB0eGIuYnVpbGRJbmNvbXBsZXRlKCk7XHJcblxyXG4gICAgICBjb25zdCBjb3VudHMgPSBnZXRTdHJpY3RTaWduYXR1cmVDb3VudHModHgpO1xyXG4gICAgICBjb25zdCBjb3VudHNGcm9tSW5zID0gZ2V0U3RyaWN0U2lnbmF0dXJlQ291bnRzKHR4Lmlucyk7XHJcblxyXG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwoY291bnRzLmxlbmd0aCwgdHguaW5zLmxlbmd0aCk7XHJcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChjb3VudHNGcm9tSW5zLmxlbmd0aCwgdHguaW5zLmxlbmd0aCk7XHJcbiAgICAgIHR4Lmlucy5mb3JFYWNoKChpbnB1dCwgaW5wdXRJbmRleCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGV4cGVjdGVkQ291bnQgPSBpbnB1dHNbaW5wdXRJbmRleF0uc2NyaXB0VHlwZSA9PT0gJ3Ayc2hQMnBrJyAmJiBzaWduYXR1cmVDb3VudCA+IDAgPyAxIDogc2lnbmF0dXJlQ291bnQ7XHJcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGdldFN0cmljdFNpZ25hdHVyZUNvdW50KGlucHV0KSwgZXhwZWN0ZWRDb3VudCk7XHJcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGNvdW50c1tpbnB1dEluZGV4XSwgZXhwZWN0ZWRDb3VudCk7XHJcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGNvdW50c0Zyb21JbnNbaW5wdXRJbmRleF0sIGV4cGVjdGVkQ291bnQpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59XHJcblxyXG5zaWducy5mb3JFYWNoKChzaWduKSA9PiB7XHJcbiAgZ2V0TmV0d29ya0xpc3QoKVxyXG4gICAgLmZpbHRlcigodikgPT4gaXNNYWlubmV0KHYpICYmIHYgIT09IG5ldHdvcmtzLmJpdGNvaW5zdilcclxuICAgIC5mb3JFYWNoKChuZXR3b3JrKSA9PiB7XHJcbiAgICAgIGNvbnN0IHN1cHBvcnRlZFBzYnRJbnB1dHMgPSBwc2J0SW5wdXRzLmZpbHRlcigoaW5wdXQpID0+XHJcbiAgICAgICAgaXNTdXBwb3J0ZWRTY3JpcHRUeXBlKG5ldHdvcmssIGlucHV0LnNjcmlwdFR5cGUgPT09ICd0YXByb290S2V5UGF0aFNwZW5kJyA/ICdwMnRyTXVzaWcyJyA6IGlucHV0LnNjcmlwdFR5cGUpXHJcbiAgICAgICk7XHJcbiAgICAgIGNvbnN0IHN1cHBvcnRlZFBzYnRPdXRwdXRzID0gcHNidE91dHB1dHMuZmlsdGVyKChvdXRwdXQpID0+IGlzU3VwcG9ydGVkU2NyaXB0VHlwZShuZXR3b3JrLCBvdXRwdXQuc2NyaXB0VHlwZSkpO1xyXG4gICAgICBydW5Qc2J0KG5ldHdvcmssIHNpZ24sIHN1cHBvcnRlZFBzYnRJbnB1dHMsIHN1cHBvcnRlZFBzYnRPdXRwdXRzKTtcclxuXHJcbiAgICAgIGNvbnN0IHN1cHBvcnRlZFR4SW5wdXRzID0gdHhJbnB1dHMuZmlsdGVyKChpbnB1dCkgPT4gaXNTdXBwb3J0ZWRTY3JpcHRUeXBlKG5ldHdvcmssIGlucHV0LnNjcmlwdFR5cGUpKTtcclxuICAgICAgY29uc3Qgc3VwcG9ydGVkVHhPdXRwdXRzID0gdHhPdXRwdXRzLmZpbHRlcigob3V0cHV0KSA9PiBpc1N1cHBvcnRlZFNjcmlwdFR5cGUobmV0d29yaywgb3V0cHV0LnNjcmlwdFR5cGUpKTtcclxuICAgICAgcnVuVHgobmV0d29yaywgc2lnbiwgc3VwcG9ydGVkVHhJbnB1dHMsIHN1cHBvcnRlZFR4T3V0cHV0cyk7XHJcbiAgICB9KTtcclxufSk7XHJcbiJdfQ==