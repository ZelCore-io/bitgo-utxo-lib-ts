"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.from = exports.preform = exports.equate = void 0;
const t = require("assert");
const bitcoinjs_lib_1 = require("bitcoinjs-lib");
function tryHex(x) {
    if (Buffer.isBuffer(x))
        return x.toString('hex');
    if (Array.isArray(x))
        return x.map(tryHex);
    return x;
}
function fromHex(x) {
    if (typeof x === 'string')
        return Buffer.from(x, 'hex');
    if (Array.isArray(x))
        return x.map(fromHex);
    return x;
}
function tryASM(x) {
    if (Buffer.isBuffer(x))
        return bitcoinjs_lib_1.script.toASM(x);
    return x;
}
function asmToBuffer(x) {
    if (x === '')
        return Buffer.alloc(0);
    return bitcoinjs_lib_1.script.fromASM(x);
}
function carryOver(a, b) {
    for (const k in b) {
        if (!k)
            continue;
        if (k in a && k === 'redeem') {
            carryOver(a[k], b[k]);
            continue;
        }
        // don't, the value was specified
        if (k in a)
            continue;
        // otherwise, expect match
        a[k] = b[k];
    }
}
// eslint-disable-next-line @typescript-eslint/no-explicit-any
function equateBase(a, b, context) {
    if ('output' in b)
        t.strictEqual(tryASM(a.output), tryASM(b.output), `Inequal ${context}output`);
    if ('input' in b) {
        t.strictEqual(tryASM(a.input), tryASM(b.input), `Inequal ${context}input`);
    }
    if ('witness' in b)
        t.deepStrictEqual(tryHex(a.witness), tryHex(b.witness), `Inequal ${context}witness`);
}
// eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types
function equate(a, b, args) {
    b = Object.assign({}, b);
    carryOver(b, args);
    // by null, we mean 'undefined', but JSON
    if (b.input === null)
        b.input = undefined;
    if (b.output === null)
        b.output = undefined;
    if (b.witness === null)
        b.witness = undefined;
    if (b.redeem) {
        if (b.redeem.input === null)
            b.redeem.input = undefined;
        if (b.redeem.output === null)
            b.redeem.output = undefined;
        if (b.redeem.witness === null)
            b.redeem.witness = undefined;
    }
    equateBase(a, b, '');
    if (b.redeem)
        equateBase(a.redeem, b.redeem, 'redeem.');
    if (b.network)
        t.deepStrictEqual(a.network, bitcoinjs_lib_1.networks[b.network], 'Inequal *.network');
    // contextual
    if (b.signature === null)
        b.signature = undefined;
    if (b.signatures === null)
        b.signatures = undefined;
    if ('address' in b)
        t.strictEqual(a.address, b.address, 'Inequal *.address');
    if ('name' in b)
        t.strictEqual(a.name, b.name, 'Inequal *.name');
    if ('hash' in b) {
        t.strictEqual(tryHex(a.hash), tryHex(b.hash), 'Inequal *.hash');
    }
    if ('pubkey' in b) {
        t.strictEqual(tryHex(a.pubkey), tryHex(b.pubkey), 'Inequal *.pubkey');
    }
    if ('signature' in b)
        t.strictEqual(tryHex(a.signature), tryHex(b.signature), 'Inequal signature');
    if ('m' in b)
        t.strictEqual(a.m, b.m, 'Inequal *.m');
    if ('n' in b)
        t.strictEqual(a.n, b.n, 'Inequal *.n');
    if ('pubkeys' in b)
        t.deepStrictEqual(tryHex(a.pubkeys), tryHex(b.pubkeys), 'Inequal *.pubkeys');
    if ('signatures' in b)
        t.deepStrictEqual(tryHex(a.signatures), tryHex(b.signatures), 'Inequal *.signatures');
    if ('data' in b) {
        t.deepStrictEqual(tryHex(a.data), tryHex(b.data), 'Inequal *.data');
    }
    if ('controlBlock' in b)
        t.strictEqual(tryHex(a.controlBlock), tryHex(b.controlBlock), 'Inequal control block');
    if ('annex' in b) {
        t.strictEqual(tryHex(a.annex), tryHex(b.annex), 'Inequal annex');
    }
}
exports.equate = equate;
// eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types
function preform(x) {
    x = Object.assign({}, x);
    if (x.network)
        x.network = bitcoinjs_lib_1.networks[x.network];
    if (typeof x.inputHex === 'string') {
        x.input = Buffer.from(x.inputHex, 'hex');
        delete x.inputHex;
    }
    if (typeof x.outputHex === 'string') {
        x.output = Buffer.from(x.outputHex, 'hex');
        delete x.outputHex;
    }
    if (typeof x.output === 'string')
        x.output = asmToBuffer(x.output);
    if (typeof x.input === 'string')
        x.input = asmToBuffer(x.input);
    if (Array.isArray(x.witness))
        x.witness = x.witness.map(fromHex);
    if (x.data)
        x.data = x.data.map(fromHex);
    if (x.hash)
        x.hash = Buffer.from(x.hash, 'hex');
    if (x.pubkey)
        x.pubkey = Buffer.from(x.pubkey, 'hex');
    if (x.signature)
        x.signature = Buffer.from(x.signature, 'hex');
    if (x.controlBlock)
        x.controlBlock = Buffer.from(x.controlBlock, 'hex');
    if (x.annex)
        x.annex = Buffer.from(x.annex, 'hex');
    if (x.pubkeys)
        x.pubkeys = x.pubkeys.map(fromHex);
    if (x.signatures) {
        x.signatures = x.signatures.map((y) => {
            return Number.isFinite(y) ? y : Buffer.from(y, 'hex');
        });
    }
    if (x.redeem) {
        x.redeem = preform(x.redeem);
    }
    if (x.redeems) {
        x.redeems = x.redeems.map(preform);
    }
    return x;
}
exports.preform = preform;
// eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types
function from(path, object, result) {
    const paths = path.split('.');
    result = result || {};
    let r = result;
    paths.forEach((k, i) => {
        if (i < paths.length - 1) {
            r[k] = r[k] || {};
            // recurse
            r = r[k];
            object = object[k];
        }
        else {
            r[k] = object[k];
        }
    });
    return result;
}
exports.from = from;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudHMudXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi90ZXN0L3BheW1lbnRzLnV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDRCQUE0QjtBQUM1QixpREFBeUU7QUFFekUsU0FBUyxNQUFNLENBQUMsQ0FBb0I7SUFDbEMsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUFFLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQUUsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBYSxDQUFDO0lBQ3ZELE9BQU8sQ0FBQyxDQUFDO0FBQ1gsQ0FBQztBQUVELFNBQVMsT0FBTyxDQUFDLENBQW9CO0lBQ25DLElBQUksT0FBTyxDQUFDLEtBQUssUUFBUTtRQUFFLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDeEQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQWEsQ0FBQztJQUN4RCxPQUFPLENBQUMsQ0FBQztBQUNYLENBQUM7QUFDRCxTQUFTLE1BQU0sQ0FBQyxDQUFTO0lBQ3ZCLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFBRSxPQUFPLHNCQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hELE9BQU8sQ0FBQyxDQUFDO0FBQ1gsQ0FBQztBQUNELFNBQVMsV0FBVyxDQUFDLENBQVM7SUFDNUIsSUFBSSxDQUFDLEtBQUssRUFBRTtRQUFFLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyQyxPQUFPLHNCQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzVC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XG5pbXBvcnQgeyBzY3JpcHQgYXMgYnNjcmlwdCwgbmV0d29ya3MgYXMgQk5FVFdPUktTIH0gZnJvbSAnYml0Y29pbmpzLWxpYic7XHJcblxyXG5mdW5jdGlvbiB0cnlIZXgoeDogQnVmZmVyIHwgQnVmZmVyW10pOiBzdHJpbmcgfCBzdHJpbmdbXSB7XHJcbiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcih4KSkgcmV0dXJuIHgudG9TdHJpbmcoJ2hleCcpO1xyXG4gIGlmIChBcnJheS5pc0FycmF5KHgpKSByZXR1cm4geC5tYXAodHJ5SGV4KSBhcyBzdHJpbmdbXTtcclxuICByZXR1cm4geDtcclxufVxyXG5cclxuZnVuY3Rpb24gZnJvbUhleCh4OiBzdHJpbmcgfCBzdHJpbmdbXSk6IEJ1ZmZlciB8IEJ1ZmZlcltdIHtcclxuICBpZiAodHlwZW9mIHggPT09ICdzdHJpbmcnKSByZXR1cm4gQnVmZmVyLmZyb20oeCwgJ2hleCcpO1xyXG4gIGlmIChBcnJheS5pc0FycmF5KHgpKSByZXR1cm4geC5tYXAoZnJvbUhleCkgYXMgQnVmZmVyW107XHJcbiAgcmV0dXJuIHg7XHJcbn1cclxuZnVuY3Rpb24gdHJ5QVNNKHg6IEJ1ZmZlcik6IHN0cmluZyB7XHJcbiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcih4KSkgcmV0dXJuIGJzY3JpcHQudG9BU00oeCk7XHJcbiAgcmV0dXJuIHg7XHJcbn1cclxuZnVuY3Rpb24gYXNtVG9CdWZmZXIoeDogc3RyaW5nKTogQnVmZmVyIHtcclxuICBpZiAoeCA9PT0gJycpIHJldHVybiBCdWZmZXIuYWxsb2MoMCk7XHJcbiAgcmV0dXJuIGJzY3JpcHQuZnJvbUFTTSh4KTtcclxufVxyXG5mdW5jdGlvbiBjYXJyeU92ZXIoYTogYW55LCBiOiBhbnkpOiB2b2lkIHtcclxuICBmb3IgKGNvbnN0IGsgaW4gYikge1xyXG4gICAgaWYgKCFrKSBjb250aW51ZTtcclxuICAgIGlmIChrIGluIGEgJiYgayA9PT0gJ3JlZGVlbScpIHtcclxuICAgICAgY2FycnlPdmVyKGFba10sIGJba10pO1xyXG4gICAgICBjb250aW51ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBkb24ndCwgdGhlIHZhbHVlIHdhcyBzcGVjaWZpZWRcclxuICAgIGlmIChrIGluIGEpIGNvbnRpbnVlO1xyXG5cclxuICAgIC8vIG90aGVyd2lzZSwgZXhwZWN0IG1hdGNoXHJcbiAgICBhW2tdID0gYltrXTtcclxuICB9XHJcbn1cclxuXHJcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XHJcbmZ1bmN0aW9uIGVxdWF0ZUJhc2UoYTogYW55LCBiOiBhbnksIGNvbnRleHQ6IHN0cmluZyk6IHZvaWQge1xyXG4gIGlmICgnb3V0cHV0JyBpbiBiKSB0LnN0cmljdEVxdWFsKHRyeUFTTShhLm91dHB1dCksIHRyeUFTTShiLm91dHB1dCksIGBJbmVxdWFsICR7Y29udGV4dH1vdXRwdXRgKTtcclxuICBpZiAoJ2lucHV0JyBpbiBiKSB7XHJcbiAgICB0LnN0cmljdEVxdWFsKHRyeUFTTShhLmlucHV0KSwgdHJ5QVNNKGIuaW5wdXQpLCBgSW5lcXVhbCAke2NvbnRleHR9aW5wdXRgKTtcclxuICB9XHJcbiAgaWYgKCd3aXRuZXNzJyBpbiBiKSB0LmRlZXBTdHJpY3RFcXVhbCh0cnlIZXgoYS53aXRuZXNzKSwgdHJ5SGV4KGIud2l0bmVzcyksIGBJbmVxdWFsICR7Y29udGV4dH13aXRuZXNzYCk7XHJcbn1cclxuXHJcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvZXhwbGljaXQtbW9kdWxlLWJvdW5kYXJ5LXR5cGVzXHJcbmV4cG9ydCBmdW5jdGlvbiBlcXVhdGUoYTogYW55LCBiOiBhbnksIGFyZ3M/OiBhbnkpOiB2b2lkIHtcclxuICBiID0gT2JqZWN0LmFzc2lnbih7fSwgYik7XHJcbiAgY2FycnlPdmVyKGIsIGFyZ3MpO1xyXG5cclxuICAvLyBieSBudWxsLCB3ZSBtZWFuICd1bmRlZmluZWQnLCBidXQgSlNPTlxyXG4gIGlmIChiLmlucHV0ID09PSBudWxsKSBiLmlucHV0ID0gdW5kZWZpbmVkO1xyXG4gIGlmIChiLm91dHB1dCA9PT0gbnVsbCkgYi5vdXRwdXQgPSB1bmRlZmluZWQ7XHJcbiAgaWYgKGIud2l0bmVzcyA9PT0gbnVsbCkgYi53aXRuZXNzID0gdW5kZWZpbmVkO1xyXG4gIGlmIChiLnJlZGVlbSkge1xyXG4gICAgaWYgKGIucmVkZWVtLmlucHV0ID09PSBudWxsKSBiLnJlZGVlbS5pbnB1dCA9IHVuZGVmaW5lZDtcclxuICAgIGlmIChiLnJlZGVlbS5vdXRwdXQgPT09IG51bGwpIGIucmVkZWVtLm91dHB1dCA9IHVuZGVmaW5lZDtcclxuICAgIGlmIChiLnJlZGVlbS53aXRuZXNzID09PSBudWxsKSBiLnJlZGVlbS53aXRuZXNzID0gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgZXF1YXRlQmFzZShhLCBiLCAnJyk7XHJcbiAgaWYgKGIucmVkZWVtKSBlcXVhdGVCYXNlKGEucmVkZWVtLCBiLnJlZGVlbSwgJ3JlZGVlbS4nKTtcclxuICBpZiAoYi5uZXR3b3JrKSB0LmRlZXBTdHJpY3RFcXVhbChhLm5ldHdvcmssIChCTkVUV09SS1MgYXMgYW55KVtiLm5ldHdvcmtdLCAnSW5lcXVhbCAqLm5ldHdvcmsnKTtcclxuXHJcbiAgLy8gY29udGV4dHVhbFxyXG4gIGlmIChiLnNpZ25hdHVyZSA9PT0gbnVsbCkgYi5zaWduYXR1cmUgPSB1bmRlZmluZWQ7XHJcbiAgaWYgKGIuc2lnbmF0dXJlcyA9PT0gbnVsbCkgYi5zaWduYXR1cmVzID0gdW5kZWZpbmVkO1xyXG4gIGlmICgnYWRkcmVzcycgaW4gYikgdC5zdHJpY3RFcXVhbChhLmFkZHJlc3MsIGIuYWRkcmVzcywgJ0luZXF1YWwgKi5hZGRyZXNzJyk7XHJcbiAgaWYgKCduYW1lJyBpbiBiKSB0LnN0cmljdEVxdWFsKGEubmFtZSwgYi5uYW1lLCAnSW5lcXVhbCAqLm5hbWUnKTtcclxuICBpZiAoJ2hhc2gnIGluIGIpIHtcclxuICAgIHQuc3RyaWN0RXF1YWwodHJ5SGV4KGEuaGFzaCksIHRyeUhleChiLmhhc2gpLCAnSW5lcXVhbCAqLmhhc2gnKTtcclxuICB9XHJcbiAgaWYgKCdwdWJrZXknIGluIGIpIHtcclxuICAgIHQuc3RyaWN0RXF1YWwodHJ5SGV4KGEucHVia2V5KSwgdHJ5SGV4KGIucHVia2V5KSwgJ0luZXF1YWwgKi5wdWJrZXknKTtcclxuICB9XHJcbiAgaWYgKCdzaWduYXR1cmUnIGluIGIpIHQuc3RyaWN0RXF1YWwodHJ5SGV4KGEuc2lnbmF0dXJlKSwgdHJ5SGV4KGIuc2lnbmF0dXJlKSwgJ0luZXF1YWwgc2lnbmF0dXJlJyk7XHJcbiAgaWYgKCdtJyBpbiBiKSB0LnN0cmljdEVxdWFsKGEubSwgYi5tLCAnSW5lcXVhbCAqLm0nKTtcclxuICBpZiAoJ24nIGluIGIpIHQuc3RyaWN0RXF1YWwoYS5uLCBiLm4sICdJbmVxdWFsICoubicpO1xyXG4gIGlmICgncHVia2V5cycgaW4gYikgdC5kZWVwU3RyaWN0RXF1YWwodHJ5SGV4KGEucHVia2V5cyksIHRyeUhleChiLnB1YmtleXMpLCAnSW5lcXVhbCAqLnB1YmtleXMnKTtcclxuICBpZiAoJ3NpZ25hdHVyZXMnIGluIGIpIHQuZGVlcFN0cmljdEVxdWFsKHRyeUhleChhLnNpZ25hdHVyZXMpLCB0cnlIZXgoYi5zaWduYXR1cmVzKSwgJ0luZXF1YWwgKi5zaWduYXR1cmVzJyk7XHJcbiAgaWYgKCdkYXRhJyBpbiBiKSB7XHJcbiAgICB0LmRlZXBTdHJpY3RFcXVhbCh0cnlIZXgoYS5kYXRhKSwgdHJ5SGV4KGIuZGF0YSksICdJbmVxdWFsICouZGF0YScpO1xyXG4gIH1cclxuICBpZiAoJ2NvbnRyb2xCbG9jaycgaW4gYikgdC5zdHJpY3RFcXVhbCh0cnlIZXgoYS5jb250cm9sQmxvY2spLCB0cnlIZXgoYi5jb250cm9sQmxvY2spLCAnSW5lcXVhbCBjb250cm9sIGJsb2NrJyk7XHJcbiAgaWYgKCdhbm5leCcgaW4gYikge1xyXG4gICAgdC5zdHJpY3RFcXVhbCh0cnlIZXgoYS5hbm5leCksIHRyeUhleChiLmFubmV4KSwgJ0luZXF1YWwgYW5uZXgnKTtcclxuICB9XHJcbn1cclxuXHJcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvZXhwbGljaXQtbW9kdWxlLWJvdW5kYXJ5LXR5cGVzXHJcbmV4cG9ydCBmdW5jdGlvbiBwcmVmb3JtKHg6IGFueSk6IGFueSB7XHJcbiAgeCA9IE9iamVjdC5hc3NpZ24oe30sIHgpO1xyXG5cclxuICBpZiAoeC5uZXR3b3JrKSB4Lm5ldHdvcmsgPSAoQk5FVFdPUktTIGFzIGFueSlbeC5uZXR3b3JrXTtcclxuICBpZiAodHlwZW9mIHguaW5wdXRIZXggPT09ICdzdHJpbmcnKSB7XHJcbiAgICB4LmlucHV0ID0gQnVmZmVyLmZyb20oeC5pbnB1dEhleCwgJ2hleCcpO1xyXG4gICAgZGVsZXRlIHguaW5wdXRIZXg7XHJcbiAgfVxyXG4gIGlmICh0eXBlb2YgeC5vdXRwdXRIZXggPT09ICdzdHJpbmcnKSB7XHJcbiAgICB4Lm91dHB1dCA9IEJ1ZmZlci5mcm9tKHgub3V0cHV0SGV4LCAnaGV4Jyk7XHJcbiAgICBkZWxldGUgeC5vdXRwdXRIZXg7XHJcbiAgfVxyXG4gIGlmICh0eXBlb2YgeC5vdXRwdXQgPT09ICdzdHJpbmcnKSB4Lm91dHB1dCA9IGFzbVRvQnVmZmVyKHgub3V0cHV0KTtcclxuICBpZiAodHlwZW9mIHguaW5wdXQgPT09ICdzdHJpbmcnKSB4LmlucHV0ID0gYXNtVG9CdWZmZXIoeC5pbnB1dCk7XHJcbiAgaWYgKEFycmF5LmlzQXJyYXkoeC53aXRuZXNzKSkgeC53aXRuZXNzID0geC53aXRuZXNzLm1hcChmcm9tSGV4KTtcclxuXHJcbiAgaWYgKHguZGF0YSkgeC5kYXRhID0geC5kYXRhLm1hcChmcm9tSGV4KTtcclxuICBpZiAoeC5oYXNoKSB4Lmhhc2ggPSBCdWZmZXIuZnJvbSh4Lmhhc2gsICdoZXgnKTtcclxuICBpZiAoeC5wdWJrZXkpIHgucHVia2V5ID0gQnVmZmVyLmZyb20oeC5wdWJrZXksICdoZXgnKTtcclxuICBpZiAoeC5zaWduYXR1cmUpIHguc2lnbmF0dXJlID0gQnVmZmVyLmZyb20oeC5zaWduYXR1cmUsICdoZXgnKTtcclxuICBpZiAoeC5jb250cm9sQmxvY2spIHguY29udHJvbEJsb2NrID0gQnVmZmVyLmZyb20oeC5jb250cm9sQmxvY2ssICdoZXgnKTtcclxuICBpZiAoeC5hbm5leCkgeC5hbm5leCA9IEJ1ZmZlci5mcm9tKHguYW5uZXgsICdoZXgnKTtcclxuICBpZiAoeC5wdWJrZXlzKSB4LnB1YmtleXMgPSB4LnB1YmtleXMubWFwKGZyb21IZXgpO1xyXG4gIGlmICh4LnNpZ25hdHVyZXMpIHtcclxuICAgIHguc2lnbmF0dXJlcyA9IHguc2lnbmF0dXJlcy5tYXAoKHk6IGFueSkgPT4ge1xyXG4gICAgICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKHkpID8geSA6IEJ1ZmZlci5mcm9tKHksICdoZXgnKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBpZiAoeC5yZWRlZW0pIHtcclxuICAgIHgucmVkZWVtID0gcHJlZm9ybSh4LnJlZGVlbSk7XHJcbiAgfVxyXG4gIGlmICh4LnJlZGVlbXMpIHtcclxuICAgIHgucmVkZWVtcyA9IHgucmVkZWVtcy5tYXAocHJlZm9ybSk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4geDtcclxufVxyXG5cclxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9leHBsaWNpdC1tb2R1bGUtYm91bmRhcnktdHlwZXNcclxuZXhwb3J0IGZ1bmN0aW9uIGZyb20ocGF0aDogc3RyaW5nLCBvYmplY3Q6IGFueSwgcmVzdWx0PzogYW55KTogYW55IHtcclxuICBjb25zdCBwYXRocyA9IHBhdGguc3BsaXQoJy4nKTtcclxuICByZXN1bHQgPSByZXN1bHQgfHwge307XHJcblxyXG4gIGxldCByID0gcmVzdWx0O1xyXG4gIHBhdGhzLmZvckVhY2goKGssIGkpID0+IHtcclxuICAgIGlmIChpIDwgcGF0aHMubGVuZ3RoIC0gMSkge1xyXG4gICAgICByW2tdID0gcltrXSB8fCB7fTtcclxuXHJcbiAgICAgIC8vIHJlY3Vyc2VcclxuICAgICAgciA9IHJba107XHJcbiAgICAgIG9iamVjdCA9IG9iamVjdFtrXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJba10gPSBvYmplY3Rba107XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIHJldHVybiByZXN1bHQ7XHJcbn1cclxuIl19