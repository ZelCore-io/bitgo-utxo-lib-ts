"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert = require("assert");
const mocha_1 = require("mocha");
const src_1 = require("../../src");
const testutil_1 = require("../../src/testutil");
const bitgo_1 = require("../../src/bitgo");
const outputScripts_1 = require("../../src/bitgo/outputScripts");
const outputScripts_util_1 = require("./generate/outputScripts.util");
const fixtures_1 = require("./generate/fixtures");
const transaction_util_1 = require("../transaction_util");
const compare_1 = require("./compare");
const testutil_2 = require("../testutil");
const fixtureTxTypes = ['deposit', 'spend'];
function getScriptTypes() {
    // FIXME(BG-66941): p2trMusig2 signing does not work in this test suite yet
    //  because the test suite is written with TransactionBuilder
    return outputScripts_util_1.scriptTypes.filter((scriptType) => scriptType !== 'p2trMusig2');
}
function runTestParse(protocol, txType, scriptType, amountType) {
    if (txType === 'deposit' && !(0, outputScripts_util_1.isSupportedDepositType)(protocol.network, scriptType)) {
        return;
    }
    if (txType === 'spend' && !(0, outputScripts_util_1.isSupportedSpendType)(protocol.network, scriptType)) {
        return;
    }
    const fixtureName = `${txType}_${scriptType}.json`;
    (0, mocha_1.describe)(`${fixtureName} amountType=${amountType}`, function () {
        let fixture;
        let txBuffer;
        let parsedTx;
        before(async function () {
            var _a;
            fixture = await (0, fixtures_1.readFixture)({
                network: protocol.network,
                version: (_a = protocol.version) !== null && _a !== void 0 ? _a : (0, bitgo_1.getDefaultTransactionVersion)(protocol.network),
            }, fixtureName);
            txBuffer = Buffer.from(fixture.transaction.hex, 'hex');
            parsedTx = (0, bitgo_1.createTransactionFromBuffer)(txBuffer, protocol.network, {
                version: protocol.version,
                amountType,
            });
        });
        function getPrevOutput(input) {
            if (input.hash) {
                input = {
                    ...input,
                    ...(0, bitgo_1.getOutputIdForInput)(input),
                };
            }
            const inputTx = fixture.inputs.find((tx) => tx.txid === input.txid);
            if (!inputTx) {
                throw new Error(`could not find inputTx`);
            }
            const prevOutput = inputTx.vout[input.index];
            if (!prevOutput) {
                throw new Error(`could not prevOutput`);
            }
            return prevOutput;
        }
        function getPrevOutputValue(input) {
            return (0, testutil_2.decimalCoinsToSats)(getPrevOutput(input).value, amountType);
        }
        function getPrevOutputScript(input) {
            return Buffer.from(getPrevOutput(input).scriptPubKey.hex, 'hex');
        }
        function getPrevOutputs() {
            return parsedTx.ins.map((i) => ({
                ...(0, bitgo_1.getOutputIdForInput)(i),
                script: getPrevOutputScript(i),
                value: getPrevOutputValue(i),
                prevTx: txBuffer,
            }));
        }
        (0, mocha_1.it)(`round-trip`, function () {
            (0, transaction_util_1.parseTransactionRoundTrip)(Buffer.from(fixture.transaction.hex, 'hex'), protocol.network, {
                inputs: getPrevOutputs(),
                amountType,
                version: protocol.version,
                // FIXME: prevTx parsing for Zcash not working yet
                roundTripPsbt: txType === 'spend' && protocol.network !== src_1.networks.zcashTest,
            });
        });
        (0, mocha_1.it)(`round-trip (high-precision values)`, function () {
            if (amountType !== 'bigint') {
                return;
            }
            const tx = (0, bitgo_1.createTransactionFromBuffer)(Buffer.from(fixture.transaction.hex, 'hex'), protocol.network, {
                amountType,
            });
            tx.outs.forEach((o) => {
                o.value = (BigInt(1e16) + BigInt(1));
                assert.notStrictEqual(BigInt(Number(o.value)), o.value);
            });
            const txRoundTrip = (0, transaction_util_1.parseTransactionRoundTrip)(tx.toBuffer(), protocol.network, { amountType });
            assert.strictEqual(txRoundTrip.outs.length, tx.outs.length);
            txRoundTrip.outs.forEach((o, i) => {
                assert.deepStrictEqual(o, tx.outs[i]);
            });
        });
        (0, mocha_1.it)(`recreate from unsigned hex`, function () {
            if (txType === 'deposit') {
                return;
            }
            const txbUnsigned = (0, bitgo_1.createTransactionBuilderForNetwork)(protocol.network, { version: protocol.version });
            getPrevOutputs().forEach((o) => {
                txbUnsigned.addInput(o.txid, o.vout);
            });
            fixture.transaction.vout.forEach((o) => {
                txbUnsigned.addOutput(Buffer.from(o.scriptPubKey.hex, 'hex'), (0, testutil_2.decimalCoinsToSats)(o.value, amountType));
            });
            const tx = (0, bitgo_1.createTransactionFromBuffer)(txbUnsigned.buildIncomplete().toBuffer(), protocol.network, {
                version: protocol.version,
                amountType,
            });
            const txb = (0, bitgo_1.createTransactionBuilderFromTransaction)(tx, getPrevOutputs());
            const signKeys = [fixtures_1.fixtureKeys[0], fixtures_1.fixtureKeys[2]];
            const publicKeys = fixtures_1.fixtureKeys.map((k) => k.publicKey);
            getPrevOutputs().forEach(({ value }, vin) => {
                signKeys.forEach((key) => {
                    (0, bitgo_1.signInput2Of3)(txb, vin, scriptType, publicKeys, key, (0, testutil_1.getDefaultCosigner)(publicKeys, key.publicKey), value);
                });
            });
            assert.strictEqual(txb.build().version, tx.version);
            assert.strictEqual(txb.build().toBuffer().toString('hex'), fixture.transaction.hex);
        });
        (0, mocha_1.it)('compare against RPC data', function () {
            assert.deepStrictEqual((0, compare_1.normalizeRpcTransaction)(fixture.transaction, protocol.network), (0, compare_1.normalizeParsedTransaction)(parsedTx, protocol.network));
        });
        (0, mocha_1.it)(`parseSignatureScript`, function () {
            if (txType === 'deposit') {
                return;
            }
            parsedTx.ins.forEach((input, i) => {
                const result = (0, bitgo_1.parseSignatureScript)(input);
                assert.strict(result.publicKeys !== undefined);
                assert.strictEqual(result.publicKeys.length, scriptType === 'p2tr' ? 2 : 3);
            });
        });
        if (txType === 'deposit') {
            return;
        }
        (0, mocha_1.it)(`verifySignatures for original transaction`, function () {
            parsedTx.ins.forEach((input, i) => {
                const prevOutValue = getPrevOutputValue(input);
                const result = (0, bitgo_1.parseSignatureScript2Of3)(input);
                assert.ok(result.scriptType !== 'taprootKeyPathSpend');
                if (!result.publicKeys) {
                    throw new Error(`expected publicKeys`);
                }
                assert.strictEqual(result.publicKeys.length, scriptType === 'p2tr' ? 2 : 3);
                if (scriptType === 'p2tr') {
                    // TODO implement verifySignature for p2tr
                    this.skip();
                }
                result.publicKeys.forEach((publicKey, publicKeyIndex) => {
                    assert.strictEqual((0, bitgo_1.verifySignature)(parsedTx, i, prevOutValue, {
                        publicKey,
                    }), publicKeyIndex === 0 || publicKeyIndex === 2);
                });
                assert.strictEqual((0, bitgo_1.verifySignature)(parsedTx, i, prevOutValue), true);
            });
        });
        function getRebuiltTransaction(signKeys) {
            assert.strict(parsedTx.outs.length === 1);
            assert.strict((0, outputScripts_1.isScriptType2Of3)(scriptType));
            const recipientScript = parsedTx.outs[0].script;
            return (0, outputScripts_util_1.createSpendTransactionFromPrevOutputs)(fixtures_1.fixtureKeys, scriptType, getPrevOutputs(), recipientScript, protocol.network, { signKeys, version: protocol.version });
        }
        (0, mocha_1.it)(`verifySignatures with one or two signatures`, function () {
            fixtures_1.fixtureKeys.forEach((key1) => {
                const rebuiltTx = getRebuiltTransaction([key1]);
                const prevOutputs = rebuiltTx.ins.map((v) => ({
                    script: getPrevOutputScript(v),
                    value: getPrevOutputValue(v),
                }));
                rebuiltTx.ins.forEach((input, i) => {
                    assert.strict((0, bitgo_1.verifySignature)(rebuiltTx, i, getPrevOutputValue(input), {}, prevOutputs));
                });
                fixtures_1.fixtureKeys.forEach((key2) => {
                    if (key1 === key2) {
                        return;
                    }
                    if (scriptType === 'p2tr') {
                        const keypair = [fixtures_1.fixtureKeys[0], fixtures_1.fixtureKeys[2]];
                        if (!keypair.includes(key1) || !keypair.includes(key2)) {
                            return;
                        }
                    }
                    const rebuiltTx = getRebuiltTransaction([key1, key2]);
                    rebuiltTx.ins.forEach((input, i) => {
                        assert.strict((0, bitgo_1.verifySignature)(rebuiltTx, i, getPrevOutputValue(input), {}, prevOutputs));
                    });
                });
            });
        });
        (0, mocha_1.it)('createSpendTransaction match', function () {
            const rebuiltTx = getRebuiltTransaction();
            assert.strictEqual(rebuiltTx.toBuffer().toString('hex'), fixture.transaction.hex);
        });
    });
}
(0, mocha_1.describe)(`regtest fixtures`, function () {
    (0, src_1.getNetworkList)().forEach((network) => {
        if (!(0, src_1.isTestnet)(network)) {
            return;
        }
        const allVersions = (0, fixtures_1.getProtocolVersions)(network);
        (0, mocha_1.it)('tests default version', function () {
            assert.strictEqual(allVersions.filter((v) => v === (0, bitgo_1.getDefaultTransactionVersion)(network)).length, 1);
        });
        (0, fixtures_1.getProtocolVersions)(network).forEach((version) => {
            const isDefault = version === (0, bitgo_1.getDefaultTransactionVersion)(network);
            (0, mocha_1.describe)(`${(0, src_1.getNetworkName)(network)} fixtures (version=${version}, isDefault=${isDefault})`, function () {
                getScriptTypes().forEach((scriptType) => {
                    fixtureTxTypes.forEach((txType) => {
                        runTestParse({ network, version }, txType, scriptType, network === src_1.networks.dogecoinTest ? 'bigint' : 'number');
                    });
                });
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90ZXN0L2ludGVncmF0aW9uX2xvY2FsX3JwYy9wYXJzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlDQUFpQztBQUNqQyxpQ0FBcUM7QUFHckMsbUNBQTBGO0FBQzFGLGlEQUF3RDtBQUV4RCwyQ0FjeUI7QUFDekIsaUVBQWlGO0FBRWpGLHNFQU11QztBQUN2QyxrREFNNkI7QUFDN0IsMERBQWdFO0FBQ2hFLHVDQUFnRjtBQUNoRiwwQ0FBaUQ7QUFFakQsTUFBTSxjQUFjLEdBQUcsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFVLENBQUM7QUFHckQsU0FBUyxjQUFjO0lBQ3JCLDJFQUEyRTtJQUMzRSw2REFBNkQ7SUFDN0QsT0FBTyxnQ0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsVUFBVSxLQUFLLFlBQVksQ0FBQyxDQUFDO0FBQ3pFLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FDbkIsUUFBa0IsRUFDbEIsTUFBcUIsRUFDckIsVUFBc0IsRUFDdEIsVUFBK0I7SUFFL0IsSUFBSSxNQUFNLEtBQUssU0FBUyxJQUFJLENBQUMsSUFBQSwyQ0FBc0IsRUFBQyxRQUFRLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxFQUFFO1FBQ2pGLE9BQU87S0FDUjtJQUVELElBQUksTUFBTSxLQUFLLE9BQU8sSUFBSSxDQUFDLElBQUEseUNBQW9CLEVBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsRUFBRTtRQUM3RSxPQUFPO0tBQ1I7SUFFRCxNQUFNLFdBQVcsR0FBRyxHQUFHLE1BQU0sSUFBSSxVQUFVLE9BQU8sQ0FBQztJQUNuRCxJQUFBLGdCQUFRLEVBQUMsR0FBRyxXQUFXLGVBQWUsVUFBVSxFQUFFLEVBQUU7UUFDbEQsSUFBSSxPQUFxQyxDQUFDO1FBQzFDLElBQUksUUFBZ0IsQ0FBQztRQUNyQixJQUFJLFFBQWtDLENBQUM7UUFF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SUFBQSxvQkFBYyxFQUFDLE9BQU8sQ0FBQyxzQkFBc0IsT0FBTyxlQUFlLFNBQVMsR0FBRyxFQUFFO2dCQUMzRixjQUFjLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtvQkFDdEMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO3dCQUNoQyxZQUFZLENBQ1YsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEVBQ3BCLE1BQU0sRUFDTixVQUFVLEVBQ1YsT0FBTyxLQUFLLGNBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUN4RCxDQUFDO29CQUNKLENBQUMsQ0FBQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhc3NlcnQgZnJvbSAnYXNzZXJ0JztcclxuaW1wb3J0IHsgZGVzY3JpYmUsIGl0IH0gZnJvbSAnbW9jaGEnO1xyXG5pbXBvcnQgeyBCSVAzMkludGVyZmFjZSB9IGZyb20gJ2JpcDMyJztcclxuXHJcbmltcG9ydCB7IGlzVGVzdG5ldCwgVHhPdXRwdXQsIGdldE5ldHdvcmtMaXN0LCBnZXROZXR3b3JrTmFtZSwgbmV0d29ya3MgfSBmcm9tICcuLi8uLi9zcmMnO1xyXG5pbXBvcnQgeyBnZXREZWZhdWx0Q29zaWduZXIgfSBmcm9tICcuLi8uLi9zcmMvdGVzdHV0aWwnO1xyXG5cclxuaW1wb3J0IHtcclxuICBjcmVhdGVUcmFuc2FjdGlvbkJ1aWxkZXJGb3JOZXR3b3JrLFxyXG4gIGNyZWF0ZVRyYW5zYWN0aW9uQnVpbGRlckZyb21UcmFuc2FjdGlvbixcclxuICBjcmVhdGVUcmFuc2FjdGlvbkZyb21CdWZmZXIsXHJcbiAgZ2V0RGVmYXVsdFRyYW5zYWN0aW9uVmVyc2lvbixcclxuICBnZXRPdXRwdXRJZEZvcklucHV0LFxyXG4gIFBhcnNlZFNpZ25hdHVyZVNjcmlwdFAybXMsXHJcbiAgcGFyc2VTaWduYXR1cmVTY3JpcHQsXHJcbiAgcGFyc2VTaWduYXR1cmVTY3JpcHQyT2YzLFxyXG4gIHNpZ25JbnB1dDJPZjMsXHJcbiAgVHJpcGxlLFxyXG4gIFR4T3V0UG9pbnQsXHJcbiAgVXR4b1RyYW5zYWN0aW9uLFxyXG4gIHZlcmlmeVNpZ25hdHVyZSxcclxufSBmcm9tICcuLi8uLi9zcmMvYml0Z28nO1xyXG5pbXBvcnQgeyBpc1NjcmlwdFR5cGUyT2YzLCBTY3JpcHRUeXBlMk9mMyB9IGZyb20gJy4uLy4uL3NyYy9iaXRnby9vdXRwdXRTY3JpcHRzJztcclxuXHJcbmltcG9ydCB7XHJcbiAgY3JlYXRlU3BlbmRUcmFuc2FjdGlvbkZyb21QcmV2T3V0cHV0cyxcclxuICBpc1N1cHBvcnRlZERlcG9zaXRUeXBlLFxyXG4gIGlzU3VwcG9ydGVkU3BlbmRUeXBlLFxyXG4gIFNjcmlwdFR5cGUsXHJcbiAgc2NyaXB0VHlwZXMsXHJcbn0gZnJvbSAnLi9nZW5lcmF0ZS9vdXRwdXRTY3JpcHRzLnV0aWwnO1xyXG5pbXBvcnQge1xyXG4gIGZpeHR1cmVLZXlzLFxyXG4gIGdldFByb3RvY29sVmVyc2lvbnMsXHJcbiAgUHJvdG9jb2wsXHJcbiAgcmVhZEZpeHR1cmUsXHJcbiAgVHJhbnNhY3Rpb25GaXh0dXJlV2l0aElucHV0cyxcclxufSBmcm9tICcuL2dlbmVyYXRlL2ZpeHR1cmVzJztcclxuaW1wb3J0IHsgcGFyc2VUcmFuc2FjdGlvblJvdW5kVHJpcCB9IGZyb20gJy4uL3RyYW5zYWN0aW9uX3V0aWwnO1xyXG5pbXBvcnQgeyBub3JtYWxpemVQYXJzZWRUcmFuc2FjdGlvbiwgbm9ybWFsaXplUnBjVHJhbnNhY3Rpb24gfSBmcm9tICcuL2NvbXBhcmUnO1xyXG5pbXBvcnQgeyBkZWNpbWFsQ29pbnNUb1NhdHMgfSBmcm9tICcuLi90ZXN0dXRpbCc7XHJcblxyXG5jb25zdCBmaXh0dXJlVHhUeXBlcyA9IFsnZGVwb3NpdCcsICdzcGVuZCddIGFzIGNvbnN0O1xyXG50eXBlIEZpeHR1cmVUeFR5cGUgPSAodHlwZW9mIGZpeHR1cmVUeFR5cGVzKVtudW1iZXJdO1xyXG5cclxuZnVuY3Rpb24gZ2V0U2NyaXB0VHlwZXMoKSB7XHJcbiAgLy8gRklYTUUoQkctNjY5NDEpOiBwMnRyTXVzaWcyIHNpZ25pbmcgZG9lcyBub3Qgd29yayBpbiB0aGlzIHRlc3Qgc3VpdGUgeWV0XHJcbiAgLy8gIGJlY2F1c2UgdGhlIHRlc3Qgc3VpdGUgaXMgd3JpdHRlbiB3aXRoIFRyYW5zYWN0aW9uQnVpbGRlclxyXG4gIHJldHVybiBzY3JpcHRUeXBlcy5maWx0ZXIoKHNjcmlwdFR5cGUpID0+IHNjcmlwdFR5cGUgIT09ICdwMnRyTXVzaWcyJyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJ1blRlc3RQYXJzZTxUTnVtYmVyIGV4dGVuZHMgbnVtYmVyIHwgYmlnaW50PihcclxuICBwcm90b2NvbDogUHJvdG9jb2wsXHJcbiAgdHhUeXBlOiBGaXh0dXJlVHhUeXBlLFxyXG4gIHNjcmlwdFR5cGU6IFNjcmlwdFR5cGUsXHJcbiAgYW1vdW50VHlwZTogJ251bWJlcicgfCAnYmlnaW50J1xyXG4pIHtcclxuICBpZiAodHhUeXBlID09PSAnZGVwb3NpdCcgJiYgIWlzU3VwcG9ydGVkRGVwb3NpdFR5cGUocHJvdG9jb2wubmV0d29yaywgc2NyaXB0VHlwZSkpIHtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIGlmICh0eFR5cGUgPT09ICdzcGVuZCcgJiYgIWlzU3VwcG9ydGVkU3BlbmRUeXBlKHByb3RvY29sLm5ldHdvcmssIHNjcmlwdFR5cGUpKSB7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBjb25zdCBmaXh0dXJlTmFtZSA9IGAke3R4VHlwZX1fJHtzY3JpcHRUeXBlfS5qc29uYDtcclxuICBkZXNjcmliZShgJHtmaXh0dXJlTmFtZX0gYW1vdW50VHlwZT0ke2Ftb3VudFR5cGV9YCwgZnVuY3Rpb24gKCkge1xyXG4gICAgbGV0IGZpeHR1cmU6IFRyYW5zYWN0aW9uRml4dHVyZVdpdGhJbnB1dHM7XHJcbiAgICBsZXQgdHhCdWZmZXI6IEJ1ZmZlcjtcclxuICAgIGxldCBwYXJzZWRUeDogVXR4b1RyYW5zYWN0aW9uPFROdW1iZXI+O1xyXG5cclxuICAgIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGZpeHR1cmUgPSBhd2FpdCByZWFkRml4dHVyZShcclxuICAgICAgICB7XHJcbiAgICAgICAgICBuZXR3b3JrOiBwcm90b2NvbC5uZXR3b3JrLFxyXG4gICAgICAgICAgdmVyc2lvbjogcHJvdG9jb2wudmVyc2lvbiA/PyBnZXREZWZhdWx0VHJhbnNhY3Rpb25WZXJzaW9uKHByb3RvY29sLm5ldHdvcmspLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZml4dHVyZU5hbWVcclxuICAgICAgKTtcclxuICAgICAgdHhCdWZmZXIgPSBCdWZmZXIuZnJvbShmaXh0dXJlLnRyYW5zYWN0aW9uLmhleCwgJ2hleCcpO1xyXG4gICAgICBwYXJzZWRUeCA9IGNyZWF0ZVRyYW5zYWN0aW9uRnJvbUJ1ZmZlcjxUTnVtYmVyPih0eEJ1ZmZlciwgcHJvdG9jb2wubmV0d29yaywge1xyXG4gICAgICAgIHZlcnNpb246IHByb3RvY29sLnZlcnNpb24sXHJcbiAgICAgICAgYW1vdW50VHlwZSxcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0eXBlIElucHV0TG9va3VwID0geyB0eGlkPzogc3RyaW5nOyBoYXNoPzogQnVmZmVyOyBpbmRleDogbnVtYmVyIH07XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0UHJldk91dHB1dChpbnB1dDogSW5wdXRMb29rdXApIHtcclxuICAgICAgaWYgKGlucHV0Lmhhc2gpIHtcclxuICAgICAgICBpbnB1dCA9IHtcclxuICAgICAgICAgIC4uLmlucHV0LFxyXG4gICAgICAgICAgLi4uZ2V0T3V0cHV0SWRGb3JJbnB1dChpbnB1dCBhcyB7IGhhc2g6IEJ1ZmZlcjsgaW5kZXg6IG51bWJlciB9KSxcclxuICAgICAgICB9O1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBpbnB1dFR4ID0gZml4dHVyZS5pbnB1dHMuZmluZCgodHgpID0+IHR4LnR4aWQgPT09IGlucHV0LnR4aWQpO1xyXG4gICAgICBpZiAoIWlucHV0VHgpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGNvdWxkIG5vdCBmaW5kIGlucHV0VHhgKTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBwcmV2T3V0cHV0ID0gaW5wdXRUeC52b3V0W2lucHV0LmluZGV4XTtcclxuICAgICAgaWYgKCFwcmV2T3V0cHV0KSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBjb3VsZCBub3QgcHJldk91dHB1dGApO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBwcmV2T3V0cHV0O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFByZXZPdXRwdXRWYWx1ZShpbnB1dDogSW5wdXRMb29rdXApOiBUTnVtYmVyIHtcclxuICAgICAgcmV0dXJuIGRlY2ltYWxDb2luc1RvU2F0czxUTnVtYmVyPihnZXRQcmV2T3V0cHV0KGlucHV0KS52YWx1ZSwgYW1vdW50VHlwZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0UHJldk91dHB1dFNjcmlwdChpbnB1dDogSW5wdXRMb29rdXApOiBCdWZmZXIge1xyXG4gICAgICByZXR1cm4gQnVmZmVyLmZyb20oZ2V0UHJldk91dHB1dChpbnB1dCkuc2NyaXB0UHViS2V5LmhleCwgJ2hleCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFByZXZPdXRwdXRzKCk6IChUeE91dFBvaW50ICYgVHhPdXRwdXQ8VE51bWJlcj4pW10ge1xyXG4gICAgICByZXR1cm4gcGFyc2VkVHguaW5zLm1hcCgoaSkgPT4gKHtcclxuICAgICAgICAuLi5nZXRPdXRwdXRJZEZvcklucHV0KGkpLFxyXG4gICAgICAgIHNjcmlwdDogZ2V0UHJldk91dHB1dFNjcmlwdChpKSxcclxuICAgICAgICB2YWx1ZTogZ2V0UHJldk91dHB1dFZhbHVlKGkpLFxyXG4gICAgICAgIHByZXZUeDogdHhCdWZmZXIsXHJcbiAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBpdChgcm91bmQtdHJpcGAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgcGFyc2VUcmFuc2FjdGlvblJvdW5kVHJpcChCdWZmZXIuZnJvbShmaXh0dXJlLnRyYW5zYWN0aW9uLmhleCwgJ2hleCcpLCBwcm90b2NvbC5uZXR3b3JrLCB7XHJcbiAgICAgICAgaW5wdXRzOiBnZXRQcmV2T3V0cHV0cygpLFxyXG4gICAgICAgIGFtb3VudFR5cGUsXHJcbiAgICAgICAgdmVyc2lvbjogcHJvdG9jb2wudmVyc2lvbixcclxuICAgICAgICAvLyBGSVhNRTogcHJldlR4IHBhcnNpbmcgZm9yIFpjYXNoIG5vdCB3b3JraW5nIHlldFxyXG4gICAgICAgIHJvdW5kVHJpcFBzYnQ6IHR4VHlwZSA9PT0gJ3NwZW5kJyAmJiBwcm90b2NvbC5uZXR3b3JrICE9PSBuZXR3b3Jrcy56Y2FzaFRlc3QsXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoYHJvdW5kLXRyaXAgKGhpZ2gtcHJlY2lzaW9uIHZhbHVlcylgLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGlmIChhbW91bnRUeXBlICE9PSAnYmlnaW50Jykge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB0eCA9IGNyZWF0ZVRyYW5zYWN0aW9uRnJvbUJ1ZmZlcjxUTnVtYmVyPihCdWZmZXIuZnJvbShmaXh0dXJlLnRyYW5zYWN0aW9uLmhleCwgJ2hleCcpLCBwcm90b2NvbC5uZXR3b3JrLCB7XHJcbiAgICAgICAgYW1vdW50VHlwZSxcclxuICAgICAgfSk7XHJcbiAgICAgIHR4Lm91dHMuZm9yRWFjaCgobykgPT4ge1xyXG4gICAgICAgIG8udmFsdWUgPSAoQmlnSW50KDFlMTYpICsgQmlnSW50KDEpKSBhcyBUTnVtYmVyO1xyXG4gICAgICAgIGFzc2VydC5ub3RTdHJpY3RFcXVhbChCaWdJbnQoTnVtYmVyKG8udmFsdWUpKSwgby52YWx1ZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zdCB0eFJvdW5kVHJpcCA9IHBhcnNlVHJhbnNhY3Rpb25Sb3VuZFRyaXAodHgudG9CdWZmZXIoKSwgcHJvdG9jb2wubmV0d29yaywgeyBhbW91bnRUeXBlIH0pO1xyXG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwodHhSb3VuZFRyaXAub3V0cy5sZW5ndGgsIHR4Lm91dHMubGVuZ3RoKTtcclxuICAgICAgdHhSb3VuZFRyaXAub3V0cy5mb3JFYWNoKChvLCBpKSA9PiB7XHJcbiAgICAgICAgYXNzZXJ0LmRlZXBTdHJpY3RFcXVhbChvLCB0eC5vdXRzW2ldKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChgcmVjcmVhdGUgZnJvbSB1bnNpZ25lZCBoZXhgLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGlmICh0eFR5cGUgPT09ICdkZXBvc2l0Jykge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB0eGJVbnNpZ25lZCA9IGNyZWF0ZVRyYW5zYWN0aW9uQnVpbGRlckZvck5ldHdvcms8VE51bWJlcj4ocHJvdG9jb2wubmV0d29yaywgeyB2ZXJzaW9uOiBwcm90b2NvbC52ZXJzaW9uIH0pO1xyXG4gICAgICBnZXRQcmV2T3V0cHV0cygpLmZvckVhY2goKG8pID0+IHtcclxuICAgICAgICB0eGJVbnNpZ25lZC5hZGRJbnB1dChvLnR4aWQsIG8udm91dCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBmaXh0dXJlLnRyYW5zYWN0aW9uLnZvdXQuZm9yRWFjaCgobykgPT4ge1xyXG4gICAgICAgIHR4YlVuc2lnbmVkLmFkZE91dHB1dChCdWZmZXIuZnJvbShvLnNjcmlwdFB1YktleS5oZXgsICdoZXgnKSwgZGVjaW1hbENvaW5zVG9TYXRzPFROdW1iZXI+KG8udmFsdWUsIGFtb3VudFR5cGUpKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCB0eCA9IGNyZWF0ZVRyYW5zYWN0aW9uRnJvbUJ1ZmZlcjxUTnVtYmVyPih0eGJVbnNpZ25lZC5idWlsZEluY29tcGxldGUoKS50b0J1ZmZlcigpLCBwcm90b2NvbC5uZXR3b3JrLCB7XHJcbiAgICAgICAgdmVyc2lvbjogcHJvdG9jb2wudmVyc2lvbixcclxuICAgICAgICBhbW91bnRUeXBlLFxyXG4gICAgICB9KTtcclxuICAgICAgY29uc3QgdHhiID0gY3JlYXRlVHJhbnNhY3Rpb25CdWlsZGVyRnJvbVRyYW5zYWN0aW9uKHR4LCBnZXRQcmV2T3V0cHV0cygpKTtcclxuICAgICAgY29uc3Qgc2lnbktleXMgPSBbZml4dHVyZUtleXNbMF0sIGZpeHR1cmVLZXlzWzJdXTtcclxuICAgICAgY29uc3QgcHVibGljS2V5cyA9IGZpeHR1cmVLZXlzLm1hcCgoaykgPT4gay5wdWJsaWNLZXkpIGFzIFRyaXBsZTxCdWZmZXI+O1xyXG4gICAgICBnZXRQcmV2T3V0cHV0cygpLmZvckVhY2goKHsgdmFsdWUgfSwgdmluKSA9PiB7XHJcbiAgICAgICAgc2lnbktleXMuZm9yRWFjaCgoa2V5KSA9PiB7XHJcbiAgICAgICAgICBzaWduSW5wdXQyT2YzKFxyXG4gICAgICAgICAgICB0eGIsXHJcbiAgICAgICAgICAgIHZpbixcclxuICAgICAgICAgICAgc2NyaXB0VHlwZSBhcyBTY3JpcHRUeXBlMk9mMyxcclxuICAgICAgICAgICAgcHVibGljS2V5cyxcclxuICAgICAgICAgICAga2V5LFxyXG4gICAgICAgICAgICBnZXREZWZhdWx0Q29zaWduZXIocHVibGljS2V5cywga2V5LnB1YmxpY0tleSksXHJcbiAgICAgICAgICAgIHZhbHVlXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh0eGIuYnVpbGQoKS52ZXJzaW9uLCB0eC52ZXJzaW9uKTtcclxuXHJcbiAgICAgIGFzc2VydC5zdHJpY3RFcXVhbCh0eGIuYnVpbGQoKS50b0J1ZmZlcigpLnRvU3RyaW5nKCdoZXgnKSwgZml4dHVyZS50cmFuc2FjdGlvbi5oZXgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2NvbXBhcmUgYWdhaW5zdCBSUEMgZGF0YScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgYXNzZXJ0LmRlZXBTdHJpY3RFcXVhbChcclxuICAgICAgICBub3JtYWxpemVScGNUcmFuc2FjdGlvbihmaXh0dXJlLnRyYW5zYWN0aW9uLCBwcm90b2NvbC5uZXR3b3JrKSxcclxuICAgICAgICBub3JtYWxpemVQYXJzZWRUcmFuc2FjdGlvbihwYXJzZWRUeCwgcHJvdG9jb2wubmV0d29yaylcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KGBwYXJzZVNpZ25hdHVyZVNjcmlwdGAsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgaWYgKHR4VHlwZSA9PT0gJ2RlcG9zaXQnKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBwYXJzZWRUeC5pbnMuZm9yRWFjaCgoaW5wdXQsIGkpID0+IHtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBwYXJzZVNpZ25hdHVyZVNjcmlwdChpbnB1dCkgYXMgUGFyc2VkU2lnbmF0dXJlU2NyaXB0UDJtcztcclxuXHJcbiAgICAgICAgYXNzZXJ0LnN0cmljdChyZXN1bHQucHVibGljS2V5cyAhPT0gdW5kZWZpbmVkKTtcclxuICAgICAgICBhc3NlcnQuc3RyaWN0RXF1YWwocmVzdWx0LnB1YmxpY0tleXMubGVuZ3RoLCBzY3JpcHRUeXBlID09PSAncDJ0cicgPyAyIDogMyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHR4VHlwZSA9PT0gJ2RlcG9zaXQnKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpdChgdmVyaWZ5U2lnbmF0dXJlcyBmb3Igb3JpZ2luYWwgdHJhbnNhY3Rpb25gLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIHBhcnNlZFR4Lmlucy5mb3JFYWNoKChpbnB1dCwgaSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHByZXZPdXRWYWx1ZSA9IGdldFByZXZPdXRwdXRWYWx1ZShpbnB1dCk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcGFyc2VTaWduYXR1cmVTY3JpcHQyT2YzKGlucHV0KTtcclxuICAgICAgICBhc3NlcnQub2socmVzdWx0LnNjcmlwdFR5cGUgIT09ICd0YXByb290S2V5UGF0aFNwZW5kJyk7XHJcbiAgICAgICAgaWYgKCFyZXN1bHQucHVibGljS2V5cykge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBleHBlY3RlZCBwdWJsaWNLZXlzYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChyZXN1bHQucHVibGljS2V5cy5sZW5ndGgsIHNjcmlwdFR5cGUgPT09ICdwMnRyJyA/IDIgOiAzKTtcclxuXHJcbiAgICAgICAgaWYgKHNjcmlwdFR5cGUgPT09ICdwMnRyJykge1xyXG4gICAgICAgICAgLy8gVE9ETyBpbXBsZW1lbnQgdmVyaWZ5U2lnbmF0dXJlIGZvciBwMnRyXHJcbiAgICAgICAgICB0aGlzLnNraXAoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlc3VsdC5wdWJsaWNLZXlzLmZvckVhY2goKHB1YmxpY0tleSwgcHVibGljS2V5SW5kZXgpID0+IHtcclxuICAgICAgICAgIGFzc2VydC5zdHJpY3RFcXVhbChcclxuICAgICAgICAgICAgdmVyaWZ5U2lnbmF0dXJlKHBhcnNlZFR4LCBpLCBwcmV2T3V0VmFsdWUsIHtcclxuICAgICAgICAgICAgICBwdWJsaWNLZXksXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICBwdWJsaWNLZXlJbmRleCA9PT0gMCB8fCBwdWJsaWNLZXlJbmRleCA9PT0gMlxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKHZlcmlmeVNpZ25hdHVyZShwYXJzZWRUeCwgaSwgcHJldk91dFZhbHVlKSwgdHJ1ZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0UmVidWlsdFRyYW5zYWN0aW9uKHNpZ25LZXlzPzogQklQMzJJbnRlcmZhY2VbXSkge1xyXG4gICAgICBhc3NlcnQuc3RyaWN0KHBhcnNlZFR4Lm91dHMubGVuZ3RoID09PSAxKTtcclxuICAgICAgYXNzZXJ0LnN0cmljdChpc1NjcmlwdFR5cGUyT2YzKHNjcmlwdFR5cGUpKTtcclxuICAgICAgY29uc3QgcmVjaXBpZW50U2NyaXB0ID0gcGFyc2VkVHgub3V0c1swXS5zY3JpcHQ7XHJcbiAgICAgIHJldHVybiBjcmVhdGVTcGVuZFRyYW5zYWN0aW9uRnJvbVByZXZPdXRwdXRzKFxyXG4gICAgICAgIGZpeHR1cmVLZXlzLFxyXG4gICAgICAgIHNjcmlwdFR5cGUsXHJcbiAgICAgICAgZ2V0UHJldk91dHB1dHMoKSxcclxuICAgICAgICByZWNpcGllbnRTY3JpcHQsXHJcbiAgICAgICAgcHJvdG9jb2wubmV0d29yayxcclxuICAgICAgICB7IHNpZ25LZXlzLCB2ZXJzaW9uOiBwcm90b2NvbC52ZXJzaW9uIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBpdChgdmVyaWZ5U2lnbmF0dXJlcyB3aXRoIG9uZSBvciB0d28gc2lnbmF0dXJlc2AsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgZml4dHVyZUtleXMuZm9yRWFjaCgoa2V5MSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJlYnVpbHRUeCA9IGdldFJlYnVpbHRUcmFuc2FjdGlvbihba2V5MV0pO1xyXG4gICAgICAgIGNvbnN0IHByZXZPdXRwdXRzID0gcmVidWlsdFR4Lmlucy5tYXAoKHYpID0+ICh7XHJcbiAgICAgICAgICBzY3JpcHQ6IGdldFByZXZPdXRwdXRTY3JpcHQodiksXHJcbiAgICAgICAgICB2YWx1ZTogZ2V0UHJldk91dHB1dFZhbHVlKHYpLFxyXG4gICAgICAgIH0pKTtcclxuICAgICAgICByZWJ1aWx0VHguaW5zLmZvckVhY2goKGlucHV0LCBpKSA9PiB7XHJcbiAgICAgICAgICBhc3NlcnQuc3RyaWN0KHZlcmlmeVNpZ25hdHVyZShyZWJ1aWx0VHgsIGksIGdldFByZXZPdXRwdXRWYWx1ZShpbnB1dCksIHt9LCBwcmV2T3V0cHV0cykpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBmaXh0dXJlS2V5cy5mb3JFYWNoKChrZXkyKSA9PiB7XHJcbiAgICAgICAgICBpZiAoa2V5MSA9PT0ga2V5Mikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgaWYgKHNjcmlwdFR5cGUgPT09ICdwMnRyJykge1xyXG4gICAgICAgICAgICBjb25zdCBrZXlwYWlyID0gW2ZpeHR1cmVLZXlzWzBdLCBmaXh0dXJlS2V5c1syXV07XHJcbiAgICAgICAgICAgIGlmICgha2V5cGFpci5pbmNsdWRlcyhrZXkxKSB8fCAha2V5cGFpci5pbmNsdWRlcyhrZXkyKSkge1xyXG4gICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGNvbnN0IHJlYnVpbHRUeCA9IGdldFJlYnVpbHRUcmFuc2FjdGlvbihba2V5MSwga2V5Ml0pO1xyXG4gICAgICAgICAgcmVidWlsdFR4Lmlucy5mb3JFYWNoKChpbnB1dCwgaSkgPT4ge1xyXG4gICAgICAgICAgICBhc3NlcnQuc3RyaWN0KHZlcmlmeVNpZ25hdHVyZShyZWJ1aWx0VHgsIGksIGdldFByZXZPdXRwdXRWYWx1ZShpbnB1dCksIHt9LCBwcmV2T3V0cHV0cykpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ2NyZWF0ZVNwZW5kVHJhbnNhY3Rpb24gbWF0Y2gnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGNvbnN0IHJlYnVpbHRUeCA9IGdldFJlYnVpbHRUcmFuc2FjdGlvbigpO1xyXG4gICAgICBhc3NlcnQuc3RyaWN0RXF1YWwocmVidWlsdFR4LnRvQnVmZmVyKCkudG9TdHJpbmcoJ2hleCcpLCBmaXh0dXJlLnRyYW5zYWN0aW9uLmhleCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufVxyXG5cclxuZGVzY3JpYmUoYHJlZ3Rlc3QgZml4dHVyZXNgLCBmdW5jdGlvbiAoKSB7XHJcbiAgZ2V0TmV0d29ya0xpc3QoKS5mb3JFYWNoKChuZXR3b3JrKSA9PiB7XHJcbiAgICBpZiAoIWlzVGVzdG5ldChuZXR3b3JrKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYWxsVmVyc2lvbnMgPSBnZXRQcm90b2NvbFZlcnNpb25zKG5ldHdvcmspO1xyXG4gICAgaXQoJ3Rlc3RzIGRlZmF1bHQgdmVyc2lvbicsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgYXNzZXJ0LnN0cmljdEVxdWFsKGFsbFZlcnNpb25zLmZpbHRlcigodikgPT4gdiA9PT0gZ2V0RGVmYXVsdFRyYW5zYWN0aW9uVmVyc2lvbihuZXR3b3JrKSkubGVuZ3RoLCAxKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGdldFByb3RvY29sVmVyc2lvbnMobmV0d29yaykuZm9yRWFjaCgodmVyc2lvbikgPT4ge1xyXG4gICAgICBjb25zdCBpc0RlZmF1bHQgPSB2ZXJzaW9uID09PSBnZXREZWZhdWx0VHJhbnNhY3Rpb25WZXJzaW9uKG5ldHdvcmspO1xyXG4gICAgICBkZXNjcmliZShgJHtnZXROZXR3b3JrTmFtZShuZXR3b3JrKX0gZml4dHVyZXMgKHZlcnNpb249JHt2ZXJzaW9ufSwgaXNEZWZhdWx0PSR7aXNEZWZhdWx0fSlgLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgZ2V0U2NyaXB0VHlwZXMoKS5mb3JFYWNoKChzY3JpcHRUeXBlKSA9PiB7XHJcbiAgICAgICAgICBmaXh0dXJlVHhUeXBlcy5mb3JFYWNoKCh0eFR5cGUpID0+IHtcclxuICAgICAgICAgICAgcnVuVGVzdFBhcnNlKFxyXG4gICAgICAgICAgICAgIHsgbmV0d29yaywgdmVyc2lvbiB9LFxyXG4gICAgICAgICAgICAgIHR4VHlwZSxcclxuICAgICAgICAgICAgICBzY3JpcHRUeXBlLFxyXG4gICAgICAgICAgICAgIG5ldHdvcmsgPT09IG5ldHdvcmtzLmRvZ2Vjb2luVGVzdCA/ICdiaWdpbnQnIDogJ251bWJlcidcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl19