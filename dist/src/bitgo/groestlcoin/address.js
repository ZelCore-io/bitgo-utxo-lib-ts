"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.toOutputScript = exports.fromOutputScript = exports.toBase58Check = exports.fromBase58Check = void 0;
const assert = require("assert");
const types = require("bitcoinjs-lib/src/types");
const bitcoinjs_lib_1 = require("bitcoinjs-lib");
const networks_1 = require("../../networks");
const crypto_1 = require("./crypto");
const bs58checkBase = require('bs58check/base');
const typeforce = require('typeforce');
const bech32_1 = require('bech32');
const FUTURE_SEGWIT_MAX_SIZE = 40;
const FUTURE_SEGWIT_MIN_SIZE = 2;
const FUTURE_SEGWIT_MAX_VERSION = 16;
const FUTURE_SEGWIT_MIN_VERSION = 1;
const FUTURE_SEGWIT_VERSION_DIFF = 0x50;
function fromBech32(address) {
    let result;
    let version;
    try {
        result = bech32_1.bech32.decode(address);
    }
    catch (e) { }
    if (result) {
        version = result.words[0];
        if (version !== 0)
            throw new TypeError(address + ' uses wrong encoding');
    }
    else {
        result = bech32_1.bech32m.decode(address);
        version = result.words[0];
        if (version === 0)
            throw new TypeError(address + ' uses wrong encoding');
    }
    const data = bech32_1.bech32.fromWords(result.words.slice(1));
    return {
        version,
        prefix: result.prefix,
        data: Buffer.from(data),
    };
}
function fromBase58Check(address) {
    const payload = bs58checkBase(crypto_1.groestl).decode(address);
    // TODO: 4.0.0, move to "toOutputScript"
    if (payload.length < 21)
        throw new TypeError(address + ' is too short');
    if (payload.length > 21)
        throw new TypeError(address + ' is too long');
    const version = payload.readUInt8(0);
    const hash = payload.slice(1);
    return { version, hash };
}
exports.fromBase58Check = fromBase58Check;
function toBase58Check(hash, version) {
    typeforce(types.tuple(types.Hash160bit, types.UInt8), arguments);
    const payload = Buffer.allocUnsafe(21);
    payload.writeUInt8(version, 0);
    hash.copy(payload, 1);
    return bs58checkBase(crypto_1.groestl).encode(payload);
}
exports.toBase58Check = toBase58Check;
function fromOutputScript(output, network) {
    assert((0, networks_1.isGroestlcoin)(network));
    try {
        return bitcoinjs_lib_1.payments.p2pkh({ output, network }).address;
    }
    catch (e) { }
    try {
        return bitcoinjs_lib_1.payments.p2sh({ output, network }).address;
    }
    catch (e) { }
    try {
        return bitcoinjs_lib_1.payments.p2wpkh({ output, network }).address;
    }
    catch (e) { }
    try {
        return bitcoinjs_lib_1.payments.p2wsh({ output, network }).address;
    }
    catch (e) { }
    try {
        return bitcoinjs_lib_1.payments.p2tr({ output, network }).address;
    }
    catch (e) { }
    throw new Error(bitcoinjs_lib_1.script.toASM(output) + ' has no matching Address');
}
exports.fromOutputScript = fromOutputScript;
function toOutputScript(address, network) {
    let decodeBase58;
    let decodeBech32;
    try {
        decodeBase58 = fromBase58Check(address);
    }
    catch (e) { }
    if (decodeBase58) {
        if (decodeBase58.version === network.pubKeyHash)
            return bitcoinjs_lib_1.payments.p2pkh({ hash: decodeBase58.hash }).output;
        if (decodeBase58.version === network.scriptHash)
            return bitcoinjs_lib_1.payments.p2sh({ hash: decodeBase58.hash }).output;
    }
    else {
        try {
            decodeBech32 = fromBech32(address);
        }
        catch (e) { }
        if (decodeBech32) {
            if (decodeBech32.prefix !== network.bech32)
                throw new Error(address + ' has an invalid prefix');
            if (decodeBech32.version === 0) {
                if (decodeBech32.data.length === 20)
                    return bitcoinjs_lib_1.payments.p2wpkh({ hash: decodeBech32.data }).output;
                if (decodeBech32.data.length === 32)
                    return bitcoinjs_lib_1.payments.p2wsh({ hash: decodeBech32.data }).output;
            }
            else if (decodeBech32.version >= FUTURE_SEGWIT_MIN_VERSION &&
                decodeBech32.version <= FUTURE_SEGWIT_MAX_VERSION &&
                decodeBech32.data.length >= FUTURE_SEGWIT_MIN_SIZE &&
                decodeBech32.data.length <= FUTURE_SEGWIT_MAX_SIZE) {
                return bitcoinjs_lib_1.script.compile([
                    decodeBech32.version + FUTURE_SEGWIT_VERSION_DIFF,
                    decodeBech32.data,
                ]);
            }
        }
    }
    throw new Error(address + ' has no matching Script');
}
exports.toOutputScript = toOutputScript;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRkcmVzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9iaXRnby9ncm9lc3RsY29pbi9hZGRyZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUFpQztBQUNqQyxpREFBaUQ7QUFDakQsaURBQTREO0FBRTVELDZDQUF3RDtBQUN4RCxxQ0FBbUM7QUFDbkMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDaEQsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ3ZDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUVuQyxNQUFNLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztBQUNsQyxNQUFNLHNCQUFzQixHQUFHLENBQUMsQ0FBQztBQUNqQyxNQUFNLHlCQUF5QixHQUFHLEVBQUUsQ0FBQztBQUNyQyxNQUFNLHlCQUF5QixHQUFHLENBQUMsQ0FBQztBQUNwQyxNQUFNLDBCQUEwQixHQUFHLElBQUksQ0FBQztBQUV4QyxTQUFTLFVBQVUsQ0FBQyxPQUFPO0lBQ3pCLElBQUksTUFBTSxDQUFDO0lBQ1gsSUFBSSxPQUFPLENBQUM7SUFDWixJQUFJO1FBQ0YsTUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQzFDO0lBQUMsT0FBTyxDQUFDLEVBQUUsR0FBRTtJQUNkLElBQUksTUFBTSxFQUFFO1FBQ1YsT0FBTyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUIsSUFBSSxPQUFPLEtBQUssQ0FBQztZQUFFLE1BQU0sSUFBSSxTQUFTLENBQUMsT0FBTyxHQUFHLHNCQUFzQixDQUFDLENBQUM7S0FDMUU7U0FBTTtRQUNMLE1BQU0sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxQyxPQUFP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QUssRUFBRTtvQkFDakMsT0FBTyx3QkFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFnQixDQUFDO2dCQUN2RSxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLEVBQUU7b0JBQ2pDLE9BQU8sd0JBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxJQUFJLEVBQUUsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBZ0IsQ0FBQzthQUN2RTtpQkFBTSxJQUNMLFlBQVksQ0FBQyxPQUFPLElBQUkseUJBQXlCO2dCQUNqRCxZQUFZLENBQUMsT0FBTyxJQUFJLHlCQUF5QjtnQkFDakQsWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksc0JBQXNCO2dCQUNsRCxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxzQkFBc0IsRUFDbEQ7Z0JBQ0EsT0FBTyxzQkFBTyxDQUFDLE9BQU8sQ0FBQztvQkFDckIsWUFBWSxDQUFDLE9BQU8sR0FBRywwQkFBMEI7b0JBQ2pELFlBQVksQ0FBQyxJQUFJO2lCQUNsQixDQUFDLENBQUM7YUFDSjtTQUNGO0tBQ0Y7SUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sR0FBRyx5QkFBeUIsQ0FBQyxDQUFDO0FBQ3ZELENBQUM7QUFyQ0Qsd0NBcUNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XHJcbmltcG9ydCAqIGFzIHR5cGVzIGZyb20gJ2JpdGNvaW5qcy1saWIvc3JjL3R5cGVzJztcclxuaW1wb3J0IHsgcGF5bWVudHMsIHNjcmlwdCBhcyBic2NyaXB0IH0gZnJvbSAnYml0Y29pbmpzLWxpYic7XHJcbmltcG9ydCB7IEJhc2U1OENoZWNrUmVzdWx0IH0gZnJvbSAnYml0Y29pbmpzLWxpYi9zcmMvYWRkcmVzcyc7XHJcbmltcG9ydCB7IGlzR3JvZXN0bGNvaW4sIE5ldHdvcmsgfSBmcm9tICcuLi8uLi9uZXR3b3Jrcyc7XHJcbmltcG9ydCB7IGdyb2VzdGwgfSBmcm9tICcuL2NyeXB0byc7XHJcbmNvbnN0IGJzNThjaGVja0Jhc2UgPSByZXF1aXJlKCdiczU4Y2hlY2svYmFzZScpO1xyXG5jb25zdCB0eXBlZm9yY2UgPSByZXF1aXJlKCd0eXBlZm9yY2UnKTtcclxuY29uc3QgYmVjaDMyXzEgPSByZXF1aXJlKCdiZWNoMzInKTtcclxuXHJcbmNvbnN0IEZVVFVSRV9TRUdXSVRfTUFYX1NJWkUgPSA0MDtcclxuY29uc3QgRlVUVVJFX1NFR1dJVF9NSU5fU0laRSA9IDI7XHJcbmNvbnN0IEZVVFVSRV9TRUdXSVRfTUFYX1ZFUlNJT04gPSAxNjtcclxuY29uc3QgRlVUVVJFX1NFR1dJVF9NSU5fVkVSU0lPTiA9IDE7XHJcbmNvbnN0IEZVVFVSRV9TRUdXSVRfVkVSU0lPTl9ESUZGID0gMHg1MDtcclxuXHJcbmZ1bmN0aW9uIGZyb21CZWNoMzIoYWRkcmVzcykge1xyXG4gIGxldCByZXN1bHQ7XHJcbiAgbGV0IHZlcnNpb247XHJcbiAgdHJ5IHtcclxuICAgIHJlc3VsdCA9IGJlY2gzMl8xLmJlY2gzMi5kZWNvZGUoYWRkcmVzcyk7XHJcbiAgfSBjYXRjaCAoZSkge31cclxuICBpZiAocmVzdWx0KSB7XHJcbiAgICB2ZXJzaW9uID0gcmVzdWx0LndvcmRzWzBdO1xyXG4gICAgaWYgKHZlcnNpb24gIT09IDApIHRocm93IG5ldyBUeXBlRXJyb3IoYWRkcmVzcyArICcgdXNlcyB3cm9uZyBlbmNvZGluZycpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXN1bHQgPSBiZWNoMzJfMS5iZWNoMzJtLmRlY29kZShhZGRyZXNzKTtcclxuICAgIHZlcnNpb24gPSByZXN1bHQud29yZHNbMF07XHJcbiAgICBpZiAodmVyc2lvbiA9PT0gMCkgdGhyb3cgbmV3IFR5cGVFcnJvcihhZGRyZXNzICsgJyB1c2VzIHdyb25nIGVuY29kaW5nJyk7XHJcbiAgfVxyXG4gIGNvbnN0IGRhdGEgPSBiZWNoMzJfMS5iZWNoMzIuZnJvbVdvcmRzKHJlc3VsdC53b3Jkcy5zbGljZSgxKSk7XHJcbiAgcmV0dXJuIHtcclxuICAgIHZlcnNpb24sXHJcbiAgICBwcmVmaXg6IHJlc3VsdC5wcmVmaXgsXHJcbiAgICBkYXRhOiBCdWZmZXIuZnJvbShkYXRhKSxcclxuICB9O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZnJvbUJhc2U1OENoZWNrKGFkZHJlc3M6IHN0cmluZyk6IEJhc2U1OENoZWNrUmVzdWx0IHtcclxuICBjb25zdCBwYXlsb2FkID0gYnM1OGNoZWNrQmFzZShncm9lc3RsKS5kZWNvZGUoYWRkcmVzcyk7XHJcbiAgLy8gVE9ETzogNC4wLjAsIG1vdmUgdG8gXCJ0b091dHB1dFNjcmlwdFwiXHJcbiAgaWYgKHBheWxvYWQubGVuZ3RoIDwgMjEpIHRocm93IG5ldyBUeXBlRXJyb3IoYWRkcmVzcyArICcgaXMgdG9vIHNob3J0Jyk7XHJcbiAgaWYgKHBheWxvYWQubGVuZ3RoID4gMjEpIHRocm93IG5ldyBUeXBlRXJyb3IoYWRkcmVzcyArICcgaXMgdG9vIGxvbmcnKTtcclxuICBjb25zdCB2ZXJzaW9uID0gcGF5bG9hZC5yZWFkVUludDgoMCk7XHJcbiAgY29uc3QgaGFzaCA9IHBheWxvYWQuc2xpY2UoMSk7XHJcbiAgcmV0dXJuIHsgdmVyc2lvbiwgaGFzaCB9O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdG9CYXNlNThDaGVjayhoYXNoOiBCdWZmZXIsIHZlcnNpb246IG51bWJlcik6IHN0cmluZyB7XHJcbiAgdHlwZWZvcmNlKHR5cGVzLnR1cGxlKHR5cGVzLkhhc2gxNjBiaXQsIHR5cGVzLlVJbnQ4KSwgYXJndW1lbnRzKTtcclxuICBjb25zdCBwYXlsb2FkID0gQnVmZmVyLmFsbG9jVW5zYWZlKDIxKTtcclxuICBwYXlsb2FkLndyaXRlVUludDgodmVyc2lvbiwgMCk7XHJcbiAgaGFzaC5jb3B5KHBheWxvYWQsIDEpO1xyXG4gIHJldHVybiBiczU4Y2hlY2tCYXNlKGdyb2VzdGwpLmVuY29kZShwYXlsb2FkKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZyb21PdXRwdXRTY3JpcHQob3V0cHV0OiBCdWZmZXIsIG5ldHdvcms6IE5ldHdvcmspOiBzdHJpbmcge1xyXG4gIGFzc2VydChpc0dyb2VzdGxjb2luKG5ldHdvcmspKTtcclxuICB0cnkge1xyXG4gICAgcmV0dXJuIHBheW1lbnRzLnAycGtoKHsgb3V0cHV0LCBuZXR3b3JrIH0pLmFkZHJlc3MgYXMgc3RyaW5nO1xyXG4gIH0gY2F0Y2ggKGUpIHt9XHJcbiAgdHJ5IHtcclxuICAgIHJldHVybiBwYXltZW50cy5wMnNoKHsgb3V0cHV0LCBuZXR3b3JrIH0pLmFkZHJlc3MgYXMgc3RyaW5nO1xyXG4gIH0gY2F0Y2ggKGUpIHt9XHJcbiAgdHJ5IHtcclxuICAgIHJldHVybiBwYXltZW50cy5wMndwa2goeyBvdXRwdXQsIG5ldHdvcmsgfSkuYWRkcmVzcyBhcyBzdHJpbmc7XHJcbiAgfSBjYXRjaCAoZSkge31cclxuICB0cnkge1xyXG4gICAgcmV0dXJuIHBheW1lbnRzLnAyd3NoKHsgb3V0cHV0LCBuZXR3b3JrIH0pLmFkZHJlc3MgYXMgc3RyaW5nO1xyXG4gIH0gY2F0Y2ggKGUpIHt9XHJcbiAgdHJ5IHtcclxuICAgIHJldHVybiBwYXltZW50cy5wMnRyKHsgb3V0cHV0LCBuZXR3b3JrIH0pLmFkZHJlc3MgYXMgc3RyaW5nO1xyXG4gIH0gY2F0Y2ggKGUpIHt9XHJcbiAgdGhyb3cgbmV3IEVycm9yKGJzY3JpcHQudG9BU00ob3V0cHV0KSArICcgaGFzIG5vIG1hdGNoaW5nIEFkZHJlc3MnKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRvT3V0cHV0U2NyaXB0KGFkZHJlc3M6IHN0cmluZywgbmV0d29yazogTmV0d29yayk6IEJ1ZmZlciB7XHJcbiAgbGV0IGRlY29kZUJhc2U1ODtcclxuICBsZXQgZGVjb2RlQmVjaDMyO1xyXG4gIHRyeSB7XHJcbiAgICBkZWNvZGVCYXNlNTggPSBmcm9tQmFzZTU4Q2hlY2soYWRkcmVzcyk7XHJcbiAgfSBjYXRjaCAoZSkge31cclxuICBpZiAoZGVjb2RlQmFzZTU4KSB7XHJcbiAgICBpZiAoZGVjb2RlQmFzZTU4LnZlcnNpb24gPT09IG5ldHdvcmsucHViS2V5SGFzaClcclxuICAgICAgcmV0dXJuIHBheW1lbnRzLnAycGtoKHsgaGFzaDogZGVjb2RlQmFzZTU4Lmhhc2ggfSkub3V0cHV0IGFzIEJ1ZmZlcjtcclxuICAgIGlmIChkZWNvZGVCYXNlNTgudmVyc2lvbiA9PT0gbmV0d29yay5zY3JpcHRIYXNoKVxyXG4gICAgICByZXR1cm4gcGF5bWVudHMucDJzaCh7IGhhc2g6IGRlY29kZUJhc2U1OC5oYXNoIH0pLm91dHB1dCBhcyBCdWZmZXI7XHJcbiAgfSBlbHNlIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGRlY29kZUJlY2gzMiA9IGZyb21CZWNoMzIoYWRkcmVzcyk7XHJcbiAgICB9IGNhdGNoIChlKSB7fVxyXG4gICAgaWYgKGRlY29kZUJlY2gzMikge1xyXG4gICAgICBpZiAoZGVjb2RlQmVjaDMyLnByZWZpeCAhPT0gbmV0d29yay5iZWNoMzIpXHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGFkZHJlc3MgKyAnIGhhcyBhbiBpbnZhbGlkIHByZWZpeCcpO1xyXG4gICAgICBpZiAoZGVjb2RlQmVjaDMyLnZlcnNpb24gPT09IDApIHtcclxuICAgICAgICBpZiAoZGVjb2RlQmVjaDMyLmRhdGEubGVuZ3RoID09PSAyMClcclxuICAgICAgICAgIHJldHVybiBwYXltZW50cy5wMndwa2goeyBoYXNoOiBkZWNvZGVCZWNoMzIuZGF0YSB9KS5vdXRwdXQgYXMgQnVmZmVyO1xyXG4gICAgICAgIGlmIChkZWNvZGVCZWNoMzIuZGF0YS5sZW5ndGggPT09IDMyKVxyXG4gICAgICAgICAgcmV0dXJuIHBheW1lbnRzLnAyd3NoKHsgaGFzaDogZGVjb2RlQmVjaDMyLmRhdGEgfSkub3V0cHV0IGFzIEJ1ZmZlcjtcclxuICAgICAgfSBlbHNlIGlmIChcclxuICAgICAgICBkZWNvZGVCZWNoMzIudmVyc2lvbiA+PSBGVVRVUkVfU0VHV0lUX01JTl9WRVJTSU9OICYmXHJcbiAgICAgICAgZGVjb2RlQmVjaDMyLnZlcnNpb24gPD0gRlVUVVJFX1NFR1dJVF9NQVhfVkVSU0lPTiAmJlxyXG4gICAgICAgIGRlY29kZUJlY2gzMi5kYXRhLmxlbmd0aCA+PSBGVVRVUkVfU0VHV0lUX01JTl9TSVpFICYmXHJcbiAgICAgICAgZGVjb2RlQmVjaDMyLmRhdGEubGVuZ3RoIDw9IEZVVFVSRV9TRUdXSVRfTUFYX1NJWkVcclxuICAgICAgKSB7XHJcbiAgICAgICAgcmV0dXJuIGJzY3JpcHQuY29tcGlsZShbXHJcbiAgICAgICAgICBkZWNvZGVCZWNoMzIudmVyc2lvbiArIEZVVFVSRV9TRUdXSVRfVkVSU0lPTl9ESUZGLFxyXG4gICAgICAgICAgZGVjb2RlQmVjaDMyLmRhdGEsXHJcbiAgICAgICAgXSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgdGhyb3cgbmV3IEVycm9yKGFkZHJlc3MgKyAnIGhhcyBubyBtYXRjaGluZyBTY3JpcHQnKTtcclxufSJdfQ==