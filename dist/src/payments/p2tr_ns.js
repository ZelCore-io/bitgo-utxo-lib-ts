"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.p2tr_ns = void 0;
const networks_1 = require("../networks");
const bitcoinjs_lib_1 = require("bitcoinjs-lib");
const OPS = bitcoinjs_lib_1.script.OPS;
const typef = require('typeforce');
const BITCOIN_NETWORK = networks_1.networks.bitcoin;
function stacksEqual(a, b) {
    if (a.length !== b.length)
        return false;
    return a.every((x, i) => {
        return x.equals(b[i]);
    });
}
// input: [signatures ...]
// output: [pubKeys[0:n-1] OP_CHECKSIGVERIFY] pubKeys[n-1] OP_CHECKSIG
function p2tr_ns(a, opts) {
    if (!a.input && !a.output && !(a.pubkeys && a.pubkeys.length) && !a.signatures) {
        throw new TypeError('Not enough data');
    }
    opts = Object.assign({ validate: true }, opts || {});
    if (!opts.eccLib)
        throw new Error('ECC Library is required for p2tr_ns.');
    const ecc = opts.eccLib;
    function isAcceptableSignature(x) {
        if (Buffer.isBuffer(x)) {
            return (
            // empty signatures may be represented as empty buffers
            (opts && opts.allowIncomplete && x.length === 0) || bitcoinjs_lib_1.script.isCanonicalSchnorrSignature(x));
        }
        return !!(opts && opts.allowIncomplete && x === OPS.OP_0);
    }
    typef({
        network: typef.maybe(typef.Object),
        output: typef.maybe(typef.Buffer),
        pubkeys: typef.maybe(typef.arrayOf(ecc.isXOnlyPoint)),
        signatures: typef.maybe(typef.arrayOf(isAcceptableSignature)),
        input: typef.maybe(typef.Buffer),
    }, a);
    const network = a.network || BITCOIN_NETWORK;
    const o = { network };
    const _chunks = bitcoinjs_lib_1.lazy.value(() => {
        if (!a.output)
            return;
        return bitcoinjs_lib_1.script.decompile(a.output);
    });
    bitcoinjs_lib_1.lazy.prop(o, 'output', () => {
        if (!a.pubkeys)
            return;
        return bitcoinjs_lib_1.script.compile([].concat(...a.pubkeys.map((pk, i, pks) => [pk, i === pks.length - 1 ? OPS.OP_CHECKSIG : OPS.OP_CHECKSIGVERIFY])));
    });
    bitcoinjs_lib_1.lazy.prop(o, 'n', () => {
        if (!o.pubkeys)
            return;
        return o.pubkeys.length;
    });
    bitcoinjs_lib_1.lazy.prop(o, 'pubkeys', () => {
        const chunks = _chunks();
        if (!chunks)
            return;
        return chunks.filter((_, index) => index % 2 === 0);
    });
    bitcoinjs_lib_1.lazy.prop(o, 'signatures', () => {
        var _a;
        if (!a.input)
            return;
        return (_a = bitcoinjs_lib_1.script.decompile(a.input)) === null || _a === void 0 ? void 0 : _a.reverse();
    });
    bitcoinjs_lib_1.lazy.prop(o, 'input', () => {
        if (!a.signatures)
            return;
        return bitcoinjs_lib_1.script.compile([...a.signatures].reverse());
    });
    bitcoinjs_lib_1.lazy.prop(o, 'witness', () => {
        if (!o.input)
            return;
        return [];
    });
    bitcoinjs_lib_1.lazy.prop(o, 'name', () => {
        if (!o.n)
            return;
        return `p2tr_ns(${o.n})`;
    });
    // extended validation
    if (opts.validate) {
        const chunks = _chunks();
        if (chunks) {
            if (chunks[chunks.length - 1] !== OPS.OP_CHECKSIG) {
                throw new TypeError('Output ends with unexpected opcode');
            }
            if (chunks
                .filter((_, index) => index % 2 === 1)
                .slice(0, -1)
                .some((op) => op !== OPS.OP_CHECKSIGVERIFY)) {
                throw new TypeError('Output contains unexpected opcode');
            }
            if (o.n > 16 || o.n !== chunks.length / 2) {
                throw new TypeError('Output contains too many pubkeys');
            }
            if (o.pubkeys.some((x) => !ecc.isXOnlyPoint(x))) {
                throw new TypeError('Output contains invalid pubkey(s)');
            }
            if (a.pubkeys && !stacksEqual(a.pubkeys, o.pubkeys)) {
                throw new TypeError('Pubkeys mismatch');
            }
        }
        if (a.pubkeys && a.pubkeys.length) {
            o.n = a.pubkeys.length;
        }
        if (a.signatures && o.n) {
            if (a.signatures.length < o.n) {
                throw new TypeError('Not enough signatures provided');
            }
            if (a.signatures.length > o.n) {
                throw new TypeError('Too many signatures provided');
            }
        }
        if (a.input) {
            if (!o.signatures.every(isAcceptableSignature)) {
                throw new TypeError('Input has invalid signature(s)');
            }
            if (a.signatures && !stacksEqual(a.signatures, o.signatures)) {
                throw new TypeError('Signature mismatch');
            }
            if (o.n !== o.signatures.length) {
                throw new TypeError(`Signature count mismatch (n: ${o.n}, signatures.length: ${o.signatures.length}`);
            }
        }
    }
    return Object.assign(o, a);
}
exports.p2tr_ns = p2tr_ns;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicDJ0cl9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYXltZW50cy9wMnRyX25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDBDQUF1QztBQUN2QyxpREFBcUY7QUFFckYsTUFBTSxHQUFHLEdBQUcsc0JBQU8sQ0FBQyxHQUFHLENBQUM7QUFDeEIsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBRW5DLE1BQU0sZUFBZSxHQUFHLG1CQUFRLENBQUMsT0FBTyxDQUFDO0FBRXpDLFNBQVMsV0FBVyxDQUFDLENBQVcsRUFBRSxDQUFXO0lBQzNDLElBQUksQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsTUFBTTtRQUFFLE9BQU8sS0FBSyxDQUFDO0lBRXhDLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUN0QixPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsMEJBQTBCO0FBQzFCLHNFQUFzRTtBQUN0RSxTQUFnQixPQUFPLENBQUMsQ0FBVSxFQUFFLElBQWtCO0lBQ3BELElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRTtRQUM5RSxNQUFNLElBQUksU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUM7S0FDeEM7SUFDRCxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLENBQUM7SUFFckQsSUFBSSxDQUFD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RCxJQUFJLENBQUMsQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUN2QixJQUFJLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQzdCLE1BQU0sSUFBSSxTQUFTLENBQUMsZ0NBQWdDLENBQUMsQ0FBQzthQUN2RDtZQUNELElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDN0IsTUFBTSxJQUFJLFNBQVMsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO2FBQ3JEO1NBQ0Y7UUFFRCxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUU7WUFDWCxJQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVcsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsRUFBRTtnQkFDL0MsTUFBTSxJQUFJLFNBQVMsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO2FBQ3ZEO1lBRUQsSUFBSSxDQUFDLENBQUMsVUFBVSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLFVBQVcsQ0FBQyxFQUFFO2dCQUM3RCxNQUFNLElBQUksU0FBUyxDQUFDLG9CQUFvQixDQUFDLENBQUM7YUFDM0M7WUFDRCxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLFVBQVcsQ0FBQyxNQUFNLEVBQUU7Z0JBQ2hDLE1BQU0sSUFBSSxTQUFTLENBQUMsZ0NBQWdDLENBQUMsQ0FBQyxDQUFDLHdCQUF3QixDQUFDLENBQUMsVUFBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7YUFDeEc7U0FDRjtLQUNGO0lBRUQsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBaElELDBCQWdJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG5ldHdvcmtzIH0gZnJvbSAnLi4vbmV0d29ya3MnO1xyXG5pbXBvcnQgeyBzY3JpcHQgYXMgYnNjcmlwdCwgUGF5bWVudCwgUGF5bWVudE9wdHMsIFN0YWNrLCBsYXp5IH0gZnJvbSAnYml0Y29pbmpzLWxpYic7XHJcblxyXG5jb25zdCBPUFMgPSBic2NyaXB0Lk9QUztcclxuY29uc3QgdHlwZWYgPSByZXF1aXJlKCd0eXBlZm9yY2UnKTtcclxuXHJcbmNvbnN0IEJJVENPSU5fTkVUV09SSyA9IG5ldHdvcmtzLmJpdGNvaW47XHJcblxyXG5mdW5jdGlvbiBzdGFja3NFcXVhbChhOiBCdWZmZXJbXSwgYjogQnVmZmVyW10pOiBib29sZWFuIHtcclxuICBpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSByZXR1cm4gZmFsc2U7XHJcblxyXG4gIHJldHVybiBhLmV2ZXJ5KCh4LCBpKSA9PiB7XHJcbiAgICByZXR1cm4geC5lcXVhbHMoYltpXSk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbi8vIGlucHV0OiBbc2lnbmF0dXJlcyAuLi5dXHJcbi8vIG91dHB1dDogW3B1YktleXNbMDpuLTFdIE9QX0NIRUNLU0lHVkVSSUZZXSBwdWJLZXlzW24tMV0gT1BfQ0hFQ0tTSUdcclxuZXhwb3J0IGZ1bmN0aW9uIHAydHJfbnMoYTogUGF5bWVudCwgb3B0cz86IFBheW1lbnRPcHRzKTogUGF5bWVudCB7XHJcbiAgaWYgKCFhLmlucHV0ICYmICFhLm91dHB1dCAmJiAhKGEucHVia2V5cyAmJiBhLnB1YmtleXMubGVuZ3RoKSAmJiAhYS5zaWduYXR1cmVzKSB7XHJcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdOb3QgZW5vdWdoIGRhdGEnKTtcclxuICB9XHJcbiAgb3B0cyA9IE9iamVjdC5hc3NpZ24oeyB2YWxpZGF0ZTogdHJ1ZSB9LCBvcHRzIHx8IHt9KTtcclxuXHJcbiAgaWYgKCFvcHRzLmVjY0xpYikgdGhyb3cgbmV3IEVycm9yKCdFQ0MgTGlicmFyeSBpcyByZXF1aXJlZCBmb3IgcDJ0cl9ucy4nKTtcclxuICBjb25zdCBlY2MgPSBvcHRzLmVjY0xpYjtcclxuXHJcbiAgZnVuY3Rpb24gaXNBY2NlcHRhYmxlU2lnbmF0dXJlKHg6IEJ1ZmZlciB8IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcih4KSkge1xyXG4gICAgICByZXR1cm4gKFxyXG4gICAgICAgIC8vIGVtcHR5IHNpZ25hdHVyZXMgbWF5IGJlIHJlcHJlc2VudGVkIGFzIGVtcHR5IGJ1ZmZlcnNcclxuICAgICAgICAob3B0cyAmJiBvcHRzLmFsbG93SW5jb21wbGV0ZSAmJiB4Lmxlbmd0aCA9PT0gMCkgfHwgYnNjcmlwdC5pc0Nhbm9uaWNhbFNjaG5vcnJTaWduYXR1cmUoeClcclxuICAgICAgKTtcclxuICAgIH1cclxuICAgIHJldHVybiAhIShvcHRzICYmIG9wdHMuYWxsb3dJbmNvbXBsZXRlICYmIHggPT09IE9QUy5PUF8wKTtcclxuICB9XHJcblxyXG4gIHR5cGVmKFxyXG4gICAge1xyXG4gICAgICBuZXR3b3JrOiB0eXBlZi5tYXliZSh0eXBlZi5PYmplY3QpLFxyXG4gICAgICBvdXRwdXQ6IHR5cGVmLm1heWJlKHR5cGVmLkJ1ZmZlciksXHJcbiAgICAgIHB1YmtleXM6IHR5cGVmLm1heWJlKHR5cGVmLmFycmF5T2YoZWNjLmlzWE9ubHlQb2ludCkpLFxyXG5cclxuICAgICAgc2lnbmF0dXJlczogdHlwZWYubWF5YmUodHlwZWYuYXJyYXlPZihpc0FjY2VwdGFibGVTaWduYXR1cmUpKSxcclxuICAgICAgaW5wdXQ6IHR5cGVmLm1heWJlKHR5cGVmLkJ1ZmZlciksXHJcbiAgICB9LFxyXG4gICAgYVxyXG4gICk7XHJcblxyXG4gIGNvbnN0IG5ldHdvcmsgPSBhLm5ldHdvcmsgfHwgQklUQ09JTl9ORVRXT1JLO1xyXG4gIGNvbnN0IG86IFBheW1lbnQgPSB7IG5ldHdvcmsgfTtcclxuXHJcbiAgY29uc3QgX2NodW5rcyA9IGxhenkudmFsdWUoKCkgPT4ge1xyXG4gICAgaWYgKCFhLm91dHB1dCkgcmV0dXJuO1xyXG4gICAgcmV0dXJuIGJzY3JpcHQuZGVjb21waWxlKGEub3V0cHV0KSBhcyBTdGFjaztcclxuICB9KTtcclxuXHJcbiAgbGF6eS5wcm9wKG8sICdvdXRwdXQnLCAoKSA9PiB7XHJcbiAgICBpZiAoIWEucHVia2V5cykgcmV0dXJuO1xyXG4gICAgcmV0dXJuIGJzY3JpcHQuY29tcGlsZShcclxuICAgICAgKFtdIGFzIFN0YWNrKS5jb25jYXQoXHJcbiAgICAgICAgLi4uYS5wdWJrZXlzLm1hcCgocGssIGksIHBrcykgPT4gW3BrLCBpID09PSBwa3MubGVuZ3RoIC0gMSA/IE9QUy5PUF9DSEVDS1NJRyA6IE9QUy5PUF9DSEVDS1NJR1ZFUklGWV0pXHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfSk7XHJcbiAgbGF6eS5wcm9wKG8sICduJywgKCkgPT4ge1xyXG4gICAgaWYgKCFvLnB1YmtleXMpIHJldHVybjtcclxuICAgIHJldHVybiBvLnB1YmtleXMubGVuZ3RoO1xyXG4gIH0pO1xyXG4gIGxhenkucHJvcChvLCAncHVia2V5cycsICgpID0+IHtcclxuICAgIGNvbnN0IGNodW5rcyA9IF9jaHVua3MoKTtcclxuICAgIGlmICghY2h1bmtzKSByZXR1cm47XHJcbiAgICByZXR1cm4gY2h1bmtzLmZpbHRlcigoXywgaW5kZXgpID0+IGluZGV4ICUgMiA9PT0gMCkgYXMgQnVmZmVyW107XHJcbiAgfSk7XHJcbiAgbGF6eS5wcm9wKG8sICdzaWduYXR1cmVzJywgKCkgPT4ge1xyXG4gICAgaWYgKCFhLmlucHV0KSByZXR1cm47XHJcbiAgICByZXR1cm4gYnNjcmlwdC5kZWNvbXBpbGUoYS5pbnB1dCk/LnJldmVyc2UoKTtcclxuICB9KTtcclxuICBsYXp5LnByb3AobywgJ2lucHV0JywgKCkgPT4ge1xyXG4gICAgaWYgKCFhLnNpZ25hdHVyZXMpIHJldHVybjtcclxuICAgIHJldHVybiBic2NyaXB0LmNvbXBpbGUoWy4uLmEuc2lnbmF0dXJlc10ucmV2ZXJzZSgpKTtcclxuICB9KTtcclxuICBsYXp5LnByb3AobywgJ3dpdG5lc3MnLCAoKSA9PiB7XHJcbiAgICBpZiAoIW8uaW5wdXQpIHJldHVybjtcclxuICAgIHJldHVybiBbXTtcclxuICB9KTtcclxuICBsYXp5LnByb3AobywgJ25hbWUnLCAoKSA9PiB7XHJcbiAgICBpZiAoIW8ubikgcmV0dXJuO1xyXG4gICAgcmV0dXJuIGBwMnRyX25zKCR7by5ufSlgO1xyXG4gIH0pO1xyXG5cclxuICAvLyBleHRlbmRlZCB2YWxpZGF0aW9uXHJcbiAgaWYgKG9wdHMudmFsaWRhdGUpIHtcclxuICAgIGNvbnN0IGNodW5rcyA9IF9jaHVua3MoKTtcclxuICAgIGlmIChjaHVua3MpIHtcclxuICAgICAgaWYgKGNodW5rc1tjaHVua3MubGVuZ3RoIC0gMV0gIT09IE9QUy5PUF9DSEVDS1NJRykge1xyXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ091dHB1dCBlbmRzIHdpdGggdW5leHBlY3RlZCBvcGNvZGUnKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoXHJcbiAgICAgICAgY2h1bmtzXHJcbiAgICAgICAgICAuZmlsdGVyKChfLCBpbmRleCkgPT4gaW5kZXggJSAyID09PSAxKVxyXG4gICAgICAgICAgLnNsaWNlKDAsIC0xKVxyXG4gICAgICAgICAgLnNvbWUoKG9wKSA9PiBvcCAhPT0gT1BTLk9QX0NIRUNLU0lHVkVSSUZZKVxyXG4gICAgICApIHtcclxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdPdXRwdXQgY29udGFpbnMgdW5leHBlY3RlZCBvcGNvZGUnKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoby5uISA+IDE2IHx8IG8ubiAhPT0gY2h1bmtzLmxlbmd0aCAvIDIpIHtcclxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdPdXRwdXQgY29udGFpbnMgdG9vIG1hbnkgcHVia2V5cycpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChvLnB1YmtleXMhLnNvbWUoKHgpID0+ICFlY2MuaXNYT25seVBvaW50KHgpKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ091dHB1dCBjb250YWlucyBpbnZhbGlkIHB1YmtleShzKScpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoYS5wdWJrZXlzICYmICFzdGFja3NFcXVhbChhLnB1YmtleXMsIG8ucHVia2V5cyEpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUHVia2V5cyBtaXNtYXRjaCcpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGEucHVia2V5cyAmJiBhLnB1YmtleXMubGVuZ3RoKSB7XHJcbiAgICAgIG8ubiA9IGEucHVia2V5cy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGEuc2lnbmF0dXJlcyAmJiBvLm4pIHtcclxuICAgICAgaWYgKGEuc2lnbmF0dXJlcy5sZW5ndGggPCBvLm4pIHtcclxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdOb3QgZW5vdWdoIHNpZ25hdHVyZXMgcHJvdmlkZWQnKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoYS5zaWduYXR1cmVzLmxlbmd0aCA+IG8ubikge1xyXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RvbyBtYW55IHNpZ25hdHVyZXMgcHJvdmlkZWQnKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChhLmlucHV0KSB7XHJcbiAgICAgIGlmICghby5zaWduYXR1cmVzIS5ldmVyeShpc0FjY2VwdGFibGVTaWduYXR1cmUpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSW5wdXQgaGFzIGludmFsaWQgc2lnbmF0dXJlKHMpJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChhLnNpZ25hdHVyZXMgJiYgIXN0YWNrc0VxdWFsKGEuc2lnbmF0dXJlcywgby5zaWduYXR1cmVzISkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdTaWduYXR1cmUgbWlzbWF0Y2gnKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoby5uICE9PSBvLnNpZ25hdHVyZXMhLmxlbmd0aCkge1xyXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYFNpZ25hdHVyZSBjb3VudCBtaXNtYXRjaCAobjogJHtvLm59LCBzaWduYXR1cmVzLmxlbmd0aDogJHtvLnNpZ25hdHVyZXMhLmxlbmd0aH1gKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24obywgYSk7XHJcbn1cclxuIl19